<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-02-08 Fri 11:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dirty Duck: A Guided Tour of Triage</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Center of Data Science for Public Policy" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Dirty Duck: A Guided Tour of Triage</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfce46dd">1. Description of the problem</a>
<ul>
<li><a href="#orgc879a43">1.1. Inspection Prioritization</a></li>
<li><a href="#org0da3c7c">1.2. Early Warning</a></li>
<li><a href="#orgc821536">1.3. What do they have in common?</a></li>
<li><a href="#orgdb0973f">1.4. How do they differ?</a></li>
</ul>
</li>
<li><a href="#orgc11ac50">2. Infrastructure</a></li>
<li><a href="#org36c779e">3. Data preparation</a>
<ul>
<li><a href="#org0a9a6a7">3.1. Load the data</a></li>
<li><a href="#org45c998c">3.2. Transforming (and cleaning) the data</a>
<ul>
<li><a href="#org27fe4e0">3.2.1. Rationale</a></li>
<li><a href="#org38885ba">3.2.2. Dataset documentation</a></li>
<li><a href="#orgfe40a17">3.2.3. Reality check</a></li>
<li><a href="#org56bc6fc">3.2.4. Cleaning</a></li>
</ul>
</li>
<li><a href="#org2f8a239">3.3. Semantic tables</a>
<ul>
<li><a href="#orga55d59f">3.3.1. Entities table</a></li>
<li><a href="#org1e12341">3.3.2. Events table</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb8b9011">4. Triage</a>
<ul>
<li><a href="#org3a6fa67">4.1. Triage interface</a></li>
<li><a href="#orgfa749fd">4.2. A simple <code>triage</code> experiment</a>
<ul>
<li><a href="#orgf36e9ac">4.2.1. A brief recap of Machine Learning</a></li>
<li><a href="#org3e82d33">4.2.2. Cohorts, labels, event dates and as of dates</a></li>
</ul>
</li>
<li><a href="#org812bb39">4.3. Experiment configuration file</a></li>
<li><a href="#orgf73e332">4.4. Temporal crossvalidation</a></li>
<li><a href="#orgefda1e3">4.5. Feature engineering</a>
<ul>
<li><a href="#org76e26af">4.5.1. Imputation</a></li>
<li><a href="#org80d5a4b">4.5.2. Feature groups strategies</a></li>
<li><a href="#org2ae3d35">4.5.3. Controlling the size of the tables</a></li>
</ul>
</li>
<li><a href="#org4168d0b">4.6. The Grid</a></li>
<li><a href="#org7999158">4.7. Machine learning governance</a>
<ul>
<li><a href="#orgc7591fd">4.7.1. What are all the results tables about?</a></li>
</ul>
</li>
<li><a href="#orgd1e0073">4.8. Audition</a></li>
<li><a href="#org51a3f9a">4.9. Post-modeling</a></li>
<li><a href="#orga988a26">4.10. Final cleaning</a></li>
</ul>
</li>
<li><a href="#orgf1af385">5. Inpection prioritization</a>
<ul>
<li><a href="#org3d761c5">5.1. Problem description</a></li>
<li><a href="#orgf41a447">5.2. Creating the labels</a></li>
<li><a href="#org129f598">5.3. Modeling Using Machine Learning</a>
<ul>
<li><a href="#orgc8a0675">5.3.1. Defining a baseline</a></li>
<li><a href="#orgb4556af">5.3.2. Creating a simple experiment: ML as a Data Mining technique</a></li>
<li><a href="#orgc8a4ee7">5.3.3. A more advanced experiment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org518c064">6. An Early Intervention System</a>
<ul>
<li><a href="#orgcb51c06">6.1. Problem description</a></li>
<li><a href="#orgbabbf25">6.2. What are the labels? What are the outcomes?</a></li>
<li><a href="#org3ab6030">6.3. Modeling Using Machine Learning</a></li>
</ul>
</li>
<li><a href="#org1f18376">7. <span class="todo TODO">TODO</span> Audition: How can I pick the best one?</a></li>
<li><a href="#org4bc9352">8. <span class="todo TODO">TODO</span> Postmodeling</a></li>
<li><a href="#org768e5ae">9. <span class="todo WORKING">WORKING</span> Scaling out: AWS Batch</a>
<ul>
<li><a href="#org5163dc0">9.1. What do you need to setup?</a></li>
<li><a href="#orga35d7a2">9.2. Assumptions</a></li>
<li><a href="#org43ee7c6">9.3. Configuration</a>
<ul>
<li><a href="#orge808c06">9.3.1. Job definition</a></li>
<li><a href="#orgdd49988">9.3.2. Environment overrides</a></li>
<li><a href="#org89528ef">9.3.3. <code>credentials-filter</code></a></li>
<li><a href="#orga47967f">9.3.4. Running an experiment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf406f7a">10. What's next?</a></li>
<li><a href="#orga459cf2">11. Appendix: For the impatient</a></li>
</ul>
</div>
</div>


<div id="outline-container-orgfce46dd" class="outline-2">
<h2 id="orgfce46dd"><span class="section-number-2">1</span> Description of the problem</h2>
<div class="outline-text-2" id="text-1">
<p>
This tutorial aims to introduce the reader to <a href="https://github.com/dssg/triage">triage</a>, a machine learning modeling tool built by the <a href="https://dsapp.uchicago.edu">Center for Data Science and Public Policy</a>.
We will use the well-known <a href="https://data.cityofchicago.org/Health-Human-Services/Food-Inspections/4ijn-s7e5">Chicago Food Inspections dataset</a>.<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<p>
We will present the two problems that <code>triage</code> was built to model<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>:
</p>

<ol class="org-ol">
<li><b>Resource prioritization</b> (internally known as the <i>inspections
problem</i>)<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup> and</li>
<li><b>Early warning</b>.<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup></li>
</ol>
</div>


<div id="outline-container-orgc879a43" class="outline-3">
<h3 id="orgc879a43"><span class="section-number-3">1.1</span> Inspection Prioritization</h3>
<div class="outline-text-3" id="text-1-1">
<p>
In an ideal world, inspectors would frequently visit every food
facility, every day<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup> to ensure it meets safety standards. But
the real world doesn't have enough
inspectors for that to happen, so the city needs to decide how to allocate
its limited inspection workforce to find and remediate as many establishments
with food hazards as possible. Assuming the city can inspect \(n\) facilities
in the next \(X\) period of time, they can define the problem like this:
</p>

<blockquote>
<p>
Which \(n\) facilities will have a food violation in the
following \(X\) period of time?
</p>
</blockquote>

<p>
If our inspection workforce is really limited, we should probably just target
the most serious violations. Then we'd define the problem like this:
</p>

<blockquote>
<p>
Which \(n\) facilities will have a critical or serious violation in the
following \(X\) period of time?
</p>
</blockquote>
</div>
</div>


<div id="outline-container-org0da3c7c" class="outline-3">
<h3 id="org0da3c7c"><span class="section-number-3">1.2</span> Early Warning</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Using the same data set, facility owners or managers would pose the
ML problem as an early warning problem.
They'd like to know whether an inspector is going to visit their facility
so they can prepare for it. They can define the problem like this:
</p>

<blockquote>
<p>
Will my facility be inspected in the next \(X\) period of time?
</p>
</blockquote>

<p>
Note that in both cases, we are defining a period of time in which the
event potentially will happen.
</p>
</div>
</div>

<div id="outline-container-orgc821536" class="outline-3">
<h3 id="orgc821536"><span class="section-number-3">1.3</span> What do they have in common?</h3>
<div class="outline-text-3" id="text-1-3">
<p>
For either problem, \(X\) could be a day, a week, month, a quarter, a year, 56 days,
or some other time period.
</p>

<p>
Without going into detail, both problems use data where each
row describes an <b>event</b> in which an <b>entity</b> was involved, and
each event has a specific <b>outcome</b> or result.
</p>

<p>
The <b>entity</b> for both inspection prioritizations and early warnings
in this tutorial is a food <i>facility</i>, and the <b>event</b> is an inspection.
But the <b>outcome</b> differs: for inspections the outcome is <i>inspection failed</i>
or <i>major violation found</i>, while for early warning the outcome is
<i>inspected</i>.
</p>
</div>
</div>

<div id="outline-container-orgdb0973f" class="outline-3">
<h3 id="orgdb0973f"><span class="section-number-3">1.4</span> How do they differ?</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Besides the obvious (i.e. the label), these ML's problem formulations
have very different internal structure:
</p>

<p>
The <i>EIS</i> problem <b>all</b> the entities of interest in a given period of
time <b>have</b> a label. The <i>Inspections</i> problem does not have that
luxury: from all the existing entities of interest only a bunch are
<i>inspected</i> that means that only those inspected have a label
(<code>True/False</code>) but all the remaining ones doesn't have one. This will be
reflected, for example in the <i>training</i> matrices: you only train in the
facilities that were inspected (so you will have less rows in
them). Another impact will be in the metrics: you need to be very
careful about interpreting the metrics in an inspections
problem. Finally, when you are designing the field validation of your
model, you need to take in account this selection bias, if not, you
will be inspecting the same facilities over and over<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>
</p>
</div>
</div>
</div>


<div id="outline-container-orgc11ac50" class="outline-2">
<h2 id="orgc11ac50"><span class="section-number-2">2</span> Infrastructure</h2>
<div class="outline-text-2" id="text-2">
<p>
In every data science project you will need several tools to
help analyze the data in an efficient<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup> manner.
Examples include a place to store the data (a database
management system or <b>DBMS</b>); a way to put your model to work,
i.e. a way that allows the model to ingest new data and make
predictions (an <b>API</b>); and a way to examine the performance
of trained models (monitor tools).
</p>

<p>
This tutorial includes a script for managing the infrastructure<sup><a id="fnr.8" class="footref" href="#fn.8">8</a></sup> in
a transparent way.
</p>

<p>
The infrastructure of this tutorial has <i>four</i> pieces:
</p>
<ul class="org-ul">
<li>a <code>postgresql</code> database called <code>food_db</code>,</li>
<li>a container that executes <code>triage</code> experiments (we will use this
when trying to scale up),</li>
<li>a container for interacting with the data called <code>bastion</code>.</li>
</ul>

<p>
<code>bastion</code> includes a <code>postgresql</code> client
(so you can interact with the database)<sup><a id="fnr.9" class="footref" href="#fn.9">9</a></sup> and a full <code>python</code>
environment (so you can code or modify the things for
the tutorial).
</p>

<p>
The only thing you need installed on your laptop is <code>docker</code>.
</p>

<p>
From your command line (terminal) run the following from the repo directory:
</p>

<div class="org-src-container">
<pre class="src src-shell">    ./tutorial.sh
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">   Usage: ./tutorial.sh <span style="color: #8c8c8c;">{</span>start|stop|build|rebuild|run|logs|status|destroy|all|<span style="color: #8c8c8c;">}</span>

   OPTIONS:
      -h|help             Show this message
      start
      stop
      rebuild
      status
      destroy
      -t|triage
      -a|all

   INFRASTRUCTURE:
      Build the infrastructure:
           $ ./tutorial.sh start

      Check the status of the containers:
           $ ./tutorial.sh status

      Stop the tutorial's infrastructure:
           $ ./tutorial.sh stop

      Destroy all the resources related to the tutorial:
           $ ./tutorial.sh destroy

      View the infrastructure logs:
           $ ./tutorial.sh -l

   EXPERIMENTS:
      NOTE:
         The following commands assume that "sampleexperimentconfig.yaml"
         is located inside the triage/experimentconfig directory

      Run one experiment:
           $ ./tutorial.sh -t --configfile sampleexperimentconfig.yaml run

      Run one experiment, do not replace existing matrices or models, and enable debug:
           $ ./tutorial.sh -t --configfile sampleexperimentconfig.yaml --no-replace --debug run

      Validate experiment configuration file:
           $ ./tutorial.sh triage --configfile sampleexperimentconfig.yaml validate

      Show the experiment's temporal cross-validation blocks:
           $ ./tutorial.sh -t --configfile sampleexperimentconfig.yaml show-temporal-blocks

      Plot model number 4 <span style="color: #8c8c8c;">(</span>for Decision Trees and Random Forests<span style="color: #8c8c8c;">)</span>:
           $ ./tutorial.sh -t --configfile sampleexperimentconfig.yaml showmodelplot --model 4

      Triage help:
           $ ./tutorial.sh triage --help

</pre>
</div>


<p>
Following the instructions on the screen, we can start the
infrastructure with:
</p>

<div class="org-src-container">
<pre class="src src-sh">    ./tutorial.sh start
</pre>
</div>


<p>
You can check that everything is running smoothly with <code>status</code>
</p>

<div class="org-src-container">
<pre class="src src-shell">    ./tutorial.sh status
    :
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">         Name                    Command              State           Ports
   ---------------------------------------------------------------------------------
   fooddb            docker-entrypoint.sh postgres   Up      0.0.0.0:5434-&gt;5432/tcp
   tutorialbastion   bash                            Up
</pre>
</div>

<p>
To access the <code>postgresql</code> client type:
</p>

<div class="org-src-container">
<pre class="src src-sh">  ./tutorial.sh bastion
</pre>
</div>

<p>
Your prompt should change to something like:
</p>

<pre class="example">
  root@485373fb3c64:/$
</pre>

<p>
<b>NOTE</b>: The number you see will be different (i.e. not <code>485373fb3c64</code>).
</p>

<p>
Inside <code>bastion</code>, type the next command to connect to the database
</p>

<div class="org-src-container">
<pre class="src src-sh">   psql $<span style="color: #8c8c8c;">{</span><span style="color: #cae682;">FOOD_DB_URL</span><span style="color: #8c8c8c;">}</span>
</pre>
</div>

<p>
The prompt will change again to
</p>

<pre class="example">
   psql (9.6.7, server 10.2 (Debian 10.2-1.pgdg90+1))
   WARNING: psql major version 9.6, server major version 10.
         Some psql features might not work.
   Type "help" for help.

   food=#
</pre>

<p>
The previous command is using <code>psql</code>, a powerful command line client
for the Postgresql database. If you want to use this client fully,
check <a href="https://www.postgresql.org/docs/10/static/app-psql.html">psql's documentation</a>.
</p>

<p>
The database is running and it's named <code>food</code>. It should contain a
single table named <code>inspections</code> in the <code>schema</code> <code>raw</code>.
Let's check the structure of the <code>inspections</code> table.
Type the following command:
</p>

<div class="org-src-container">
<pre class="src src-sql">    \d raw.inspections
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "raw.inspections"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">inspection</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dba<sub>name</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">aka<sub>name</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">license<sub>num</sub></td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">facility<sub>type</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risk</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">address</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">city</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">state</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">zip</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">type</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">violations</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">latitude</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">longitude</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">location</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
That's it. We will work from this table of raw data.
</p>

<p>
You can disconnect from the database typing <code>\q</code>. But don't leave
the database yet! We still need to do a lot of things <sup><a id="fnr.10" class="footref" href="#fn.10">10</a></sup>
</p>
</div>
</div>

<div id="outline-container-org36c779e" class="outline-2">
<h2 id="org36c779e"><span class="section-number-2">3</span> Data preparation</h2>
<div class="outline-text-2" id="text-3">
<p>
We need to get the data and transform it into a shape that is suitable for the analysis.
</p>

<p>
<b>NOTE:</b> Unless we say otherwise, you should run all the following commands inside <code>bastion</code>.
</p>
</div>

<div id="outline-container-org0a9a6a7" class="outline-3">
<h3 id="org0a9a6a7"><span class="section-number-3">3.1</span> Load the data</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Before loading the data into the database, verify that the database table is empty:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
</tr>
</tbody>
</table>


<p>
We will use some <code>postgresql</code> magic in order to get the data in our
database. In particular we will use the powerful <a href="https://www.postgresql.org/docs/10/sql-copy.html">copy</a> command
and the City of Chicago's data API:
</p>

<div class="org-src-container">
<pre class="src src-sql">\copy raw.inspections <span style="color: #8ac6f2;">from</span> program <span style="color: #95e454;">'curl "https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD"'</span> HEADER CSV
</pre>
</div>

<p>
Now, you should have some data<sup><a id="fnr.11" class="footref" href="#fn.11">11</a></sup>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">180842</td>
</tr>
</tbody>
</table>

<p>
Let's peek inside the table<sup><a id="fnr.12" class="footref" href="#fn.12">12</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> inspection, dba_name, risk, results <span style="color: #8ac6f2;">from</span> raw.inspections <span style="color: #8ac6f2;">limit</span> 1;
</pre>
</div>

<p>
Ok, now you have some data loaded! But we still need to <i>munge</i> it to use it in our machine learning task.
</p>
</div>
</div>

<div id="outline-container-org45c998c" class="outline-3">
<h3 id="org45c998c"><span class="section-number-3">3.2</span> Transforming (and cleaning) the data</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org27fe4e0" class="outline-4">
<h4 id="org27fe4e0"><span class="section-number-4">3.2.1</span> Rationale</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
To tackle a Machine Learning problem, you need to identify the
<b>entities</b> for your problem domain, and if your problem involves time,
how those entities change, either what <b>events</b> happen to
the entity or what <b>events</b> the entity effects.
</p>

<p>
We will encode this information in two tables, one named <code>entities</code> and the
other <code>events</code>.
</p>

<p>
The entity, in this example, is the food <b>facility</b>, and the events are
the <b>inspections</b> on the facility.
</p>

<p>
The <code>entities</code> table should contain a unique identifier for the entity and
some data about that entity (like name, age, status). The
<code>events</code> table will include data related to the inspection, including the
two most important attributes: its spatial and temporal positions <sup><a id="fnr.13" class="footref" href="#fn.13">13</a></sup>.
</p>

<p>
Before starting the cleaning, make your life easier by following this rule:
</p>

<blockquote>
<p>
<i>Do not change the original data</i>
</p>
</blockquote>

<p>
The reason is, if you make a mistake or want to try a different data
transformation, you can always can go back to the <code>raw</code> data and start over.
</p>

<p>
The transformation "road" that we will take in this tutorial is as follows:
</p>

<ol class="org-ol">
<li>Put a copy of the data in the <code>raw</code> schema. (We just did that.)</li>
<li>Apply some simple transformations and store the resulting
data in the <code>cleaned</code> schema.</li>
<li>Organize the data in two <i>unnormalized</i><sup><a id="fnr.14" class="footref" href="#fn.14">14</a></sup> tables:
<code>events</code> and <code>entities</code> in the <code>semantic</code> schema.</li>
<li>Address some <code>triage</code> idiosyncrasies, and create
other tables and store them in the schema <code>triage</code>.</li>
<li>Run <code>triage</code>. It will create several schemas (<code>model_metadata</code>,
<code>test_results</code>, <code>train_results</code>).</li>
</ol>



<div class="figure">
<p><img src="images/data_road.png" alt="data_road.png" width="600" height="800" />
</p>
</div>
</div>
</div>



<div id="outline-container-org38885ba" class="outline-4">
<h4 id="org38885ba"><span class="section-number-4">3.2.2</span> Dataset documentation</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
The Chicago Food Inspection dataset has documentation
<a href="https://data.cityofchicago.org/api/assets/BAD5301B-681A-4202-9D25-51B2CAE672FF?download=true">here</a>.
</p>

<p>
We can make sense there about the column's meaning, and the
process that generates the data.
</p>

<p>
Most columns are self-explanatory, but some are not:<sup><a id="fnr.15" class="footref" href="#fn.15">15</a></sup>
</p>

<dl class="org-dl">
<dt><b>Risk category of facility</b> (<code>risk</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
Each establishment is categorized as
to its risk of adversely affecting the public’s health, with 1
being the highest and 3 the lowest. The frequency of
inspection is tied to this risk, with risk 1 establishments
inspected most frequently and risk 3 least frequently.
</p>
</blockquote>

<dl class="org-dl">
<dt><b>Inspection type</b> (<code>type</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
An inspection can be one of the following
types: canvass, the most common type of inspection performed
at a frequency relative to the risk of the establishment;
consultation, when the inspection is done at the request of the
owner prior to the opening of the establishment; complaint, when
the inspection is done in response to a complaint against the
establishment; license, when the inspection is done as a
requirement for the establishment to receive its license to
operate; suspect food poisoning, when the inspection is done
in response to one or more persons claiming to have gotten ill
as a result of eating at the establishment (a specific type of
complaint-based inspection); task-force inspection, when an
inspection of a bar or tavern is done. Re-inspections can
occur for most types of these inspections and are indicated as
such.
</p>
</blockquote>

<dl class="org-dl">
<dt><b>Results</b> (<code>results</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
An inspection can pass, pass with conditions, or
fail. Establishments receiving a ‘pass’ were found to have no
critical or serious violations (violation number 1-14 and 15-29,
respectively). Establishments receiving a ‘pass  with conditions’
were found to have critical or serious violations, but these were
corrected during the inspection. Establishments receiving a
‘fail’ were found to have critical or serious violations that
were not correctable during the inspection. An establishment
receiving a ‘fail’ does not  necessarily mean the establishment’s
licensed is suspended. Establishments found to be out of business
or not located are indicated as such.
</p>
</blockquote>

<dl class="org-dl">
<dt><b>Violations</b> (<code>violations</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
An establishment can receive <b>one or more</b> of 45
distinct violations (violation numbers 1-44 and 70). For each
violation number listed for a given establishment, <i>the
requirement the establishment must meet in order for it</i> to <b>NOT</b>
<i>receive a violation is noted, followed by a specific description
of the findings that caused the violation to be issued</i>.
</p>
</blockquote>

<p>
We added emphasis to the last one.
</p>

<p>
From these definitions, we can infer the following:
</p>

<ol class="org-ol">
<li><i>risk</i> is related to the frequency of inspections of type <i>canvass</i>.</li>
<li><i>consultation</i> is an inspection <i>before</i> the facility opens
(so we can remove it from the data). The same happens with <i>license</i>.</li>
<li><i>complaint</i> and <i>suspected food poisoning</i> are triggered by people.</li>
<li><i>consultation</i> is triggered by the owner of the facility.</li>
<li><i>task-force</i> occurs at bars or taverns.</li>
<li><b>Critical violations</b> are coded between <code>1-14</code>, <b>serious violations</b>
between <code>15-29</code>. We can assume that the violations code <code>30</code> and
higher are <i>minor</i> violations.</li>
<li><i>violation</i> describes the problems found, and the comment section
describes the steps the facility should take to fix the problem.</li>
<li>There are only three possible results of the inspection. (Also,
an inspection may not happen if the facility was not located or went
out of business).</li>
<li>There can be several <code>violations</code> per <code>inspection</code>.</li>
</ol>
</div>
</div>

<div id="outline-container-orgfe40a17" class="outline-4">
<h4 id="orgfe40a17"><span class="section-number-4">3.2.3</span> Reality check</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
It is important to verify that the documentation is correct. Let's start by
checking that the <code>risk</code> column <b>only</b> has three classifications:
</p>

<p>
<b>NOTE</b> Execute this in <code>psql</code> inside the container <code>bastion</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">select</span> risk, <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span> risk <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">desc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">risk</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Risk 1 (High)</td>
<td class="org-right">128345</td>
</tr>

<tr>
<td class="org-left">Risk 2 (Medium)</td>
<td class="org-right">36083</td>
</tr>

<tr>
<td class="org-left">Risk 3 (Low)</td>
<td class="org-right">16317</td>
</tr>

<tr>
<td class="org-left">¤</td>
<td class="org-right">69</td>
</tr>

<tr>
<td class="org-left">All</td>
<td class="org-right">28</td>
</tr>
</tbody>
</table>

<p>
Ok, there are two extra <code>risk</code> types, <code>All</code> and <code>NULL</code>, for a grand total
of <b>5</b>.
</p>

<p>
What about <code>types</code> of inspections?
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">select</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">distinct</span> <span style="color: #8ac6f2;">type</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">108</td>
</tr>
</tbody>
</table>

<p>
Wow, there are <b>108</b> types of inspections instead of the (expected) <b>5</b>!
</p>

<p>
What are those types? How bad is it?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #8ac6f2;">type</span>, <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span> <span style="color: #8ac6f2;">type</span> <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">desc</span> <span style="color: #8ac6f2;">limit</span> 10;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Canvass</td>
<td class="org-right">95642</td>
</tr>

<tr>
<td class="org-left">License</td>
<td class="org-right">23607</td>
</tr>

<tr>
<td class="org-left">Canvass Re-Inspection</td>
<td class="org-right">18775</td>
</tr>

<tr>
<td class="org-left">Complaint</td>
<td class="org-right">16780</td>
</tr>

<tr>
<td class="org-left">License Re-Inspection</td>
<td class="org-right">8347</td>
</tr>

<tr>
<td class="org-left">Complaint Re-Inspection</td>
<td class="org-right">6867</td>
</tr>

<tr>
<td class="org-left">Short Form Complaint</td>
<td class="org-right">6464</td>
</tr>

<tr>
<td class="org-left">Suspected Food Poisoning</td>
<td class="org-right">805</td>
</tr>

<tr>
<td class="org-left">Consultation</td>
<td class="org-right">670</td>
</tr>

<tr>
<td class="org-left">License-Task Force</td>
<td class="org-right">605</td>
</tr>
</tbody>
</table>

<p>
This column will require also cleaning.
</p>

<p>
Finally, let's look <code>results</code> (should be 3)
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">select</span> results, <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span> results <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">desc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">results</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Pass</td>
<td class="org-right">102278</td>
</tr>

<tr>
<td class="org-left">Fail</td>
<td class="org-right">34975</td>
</tr>

<tr>
<td class="org-left">Pass w/ Conditions</td>
<td class="org-right">20672</td>
</tr>

<tr>
<td class="org-left">Out of Business</td>
<td class="org-right">15838</td>
</tr>

<tr>
<td class="org-left">No Entry</td>
<td class="org-right">5527</td>
</tr>

<tr>
<td class="org-left">Not Ready</td>
<td class="org-right">1486</td>
</tr>

<tr>
<td class="org-left">Business Not Located</td>
<td class="org-right">66</td>
</tr>
</tbody>
</table>

<p>
Ok, disheartening. But that's the reality of <i>real</i> data. We'll try to clean this mess.
</p>
</div>
</div>

<div id="outline-container-org56bc6fc" class="outline-4">
<h4 id="org56bc6fc"><span class="section-number-4">3.2.4</span> Cleaning</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
Let's look at the data to figure out how we need to transform it. We'll
start with all the columns except <code>violations</code>. We'll
deal with that one later because it's more complex.
</p>

<p>
First, we'll remove superfluous spaces; convert the columns
<code>type, results, dba_name, aka_name, facility_type, address, city</code> to
lower case; and clean <code>risk</code>, keeping only the description
(e.g. <code>high</code> instead of <code>Risk 1 (High)</code>).
</p>

<p>
We still need to clean further the column <code>type</code> (which contains more
values than the <b>seven</b> mentioned in the documentation:
<i>canvass</i>, <i>complaint</i>, <i>license</i>, <i>re-inspection</i>, <i>task-force</i>, <i>consultation</i>,
and <i>suspected food poisoning</i>). For simplicity, we will use <i>regular
expressions</i> and ignore <i>re-inspection</i>.
</p>

<p>
For the column <code>risk</code>, we will impute as <code>high</code> all the <code>NULL</code> and <code>All</code>
values<sup><a id="fnr.16" class="footref" href="#fn.16">16</a></sup>.
</p>

<p>
As we have seen (and will continue see) through this
tutorial, <i>real data are messy</i>; for example, the column <code>dba_name</code>
has several spellings for the same thing: <code>SUBWAY</code> and
<code>Subway</code>, <code>MCDONALDS</code> and <code>MC DONALD'S</code>, <code>DUNKIN DONUTS/BASKIN ROBBINS</code> and
<code>DUNKIN DONUTS / BASKIN ROBBINS</code>, etc.
</p>

<p>
We could use <a href="https://www.postgresql.org/docs/current/static/fuzzystrmatch.html">soundex</a>
or machine learning <i>deduplication</i><sup><a id="fnr.17" class="footref" href="#fn.17">17</a></sup> to clean these names,
but we'll go with a very simple cleaning strategy: convert all the
names to lowercase, remove the trailing spaces, remove the apostrophe,
and remove the spaces around "<code>/</code>". It won't completely clean
those names, but it's good enough for this example project.
</p>

<p>
Let's review the status of the spatial columns (<code>state, city, zip, latitude,
longitude</code>). Beginning with <code>state</code>, all the facilities in the
data should be located in <b>Ilinois</b>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #8ac6f2;">state</span>, <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span> <span style="color: #8ac6f2;">state</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">state</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IL</td>
<td class="org-right">180809</td>
</tr>

<tr>
<td class="org-left">¤</td>
<td class="org-right">33</td>
</tr>
</tbody>
</table>

<p>
Ok, almost correct, there are some <code>NULL</code> values. We will assume that
the <code>NULL</code> values are actually <code>IL</code> (i.e. we will impute them). Moving to
the next spatial column, we expect that all the values in the column
<code>city</code> are Chicago:<sup><a id="fnr.18" class="footref" href="#fn.18">18</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    <span style="color: #e5786d;">lower</span><span style="color: #8c8c8c;">(</span>city<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> city,
    to_char<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>*<span style="color: #93a8c6;">)</span>, <span style="color: #95e454;">'999,999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> <span style="color: #e5786d;">count</span>
<span style="color: #8ac6f2;">from</span> raw.inspections
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span> <span style="color: #e5786d;">lower</span><span style="color: #8c8c8c;">(</span>city<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">desc</span> <span style="color: #8ac6f2;">limit</span> 10;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">city</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">chicago</td>
<td class="org-right">180,438</td>
</tr>

<tr>
<td class="org-left">¤</td>
<td class="org-right">155</td>
</tr>

<tr>
<td class="org-left">cchicago</td>
<td class="org-right">44</td>
</tr>

<tr>
<td class="org-left">schaumburg</td>
<td class="org-right">23</td>
</tr>

<tr>
<td class="org-left">maywood</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-left">elk grove village</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-left">evanston</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-left">chestnut street</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-left">cicero</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-left">inactive</td>
<td class="org-right">8</td>
</tr>
</tbody>
</table>

<p>
Oh boy. There are 150-ish rows with <code>NULL</code> values and forty-ish rows with the
value <code>cchicago</code>. Farther down the list (if you dare), we even have
<code>chicagochicago</code>. All the values are near Chicago, even if they're in different
counties, so we will ignore this column (or equivalently,
we will assume that all the records are from Chicago).
</p>

<p>
Zip code has a similar <code>NULL</code> problem:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> raw.inspections <span style="color: #8ac6f2;">where</span> zip <span style="color: #8ac6f2;">is</span> <span style="color: #8ac6f2;">null</span> <span style="color: #8ac6f2;">or</span> btrim<span style="color: #8c8c8c;">(</span>zip<span style="color: #8c8c8c;">)</span> = <span style="color: #95e454;">''</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">75</td>
</tr>
</tbody>
</table>

<p>
We could attempt to replace these <code>NULL</code> values using the location point or
using similar names of restaurants, but for this tutorial we will
remove them. Also, we will convert the coordinates latitude and
longitude to a Postgres <code>Point</code>.<sup><a id="fnr.19" class="footref" href="#fn.19">19</a></sup> <sup>, </sup><sup><a id="fnr.20" class="footref" href="#fn.20">20</a></sup> <sup>, </sup><sup><a id="fnr.21" class="footref" href="#fn.21">21</a></sup>
</p>

<p>
We will drop the columns <code>state</code>,
<code>latitude</code>, and <code>longitude</code> because the <code>Point</code> contains all that information.
We also will remove the column <code>city</code> because almost
everything happens in Chicago.
</p>

<p>
If you're keeping count, we are only keeping two columns related
to the spatial location of the events: the location of the facility (<code>location</code>)
and one related to inspection assignments (<code>zip_code</code>).
</p>

<p>
Each inspection can have multiple violations. To handle that as simply as
possible, we'll put violations in their own table.
</p>

<p>
Finally, we will improve the names of the columns
(e.g. <code>results -&gt; result, dba_name -&gt; facility</code>, etc).
</p>

<p>
We will create a new <code>schema</code> called <code>cleaned</code>. The objective of this
schema is twofold: to keep our raw data <i>as is <sup><a id="fnr.22" class="footref" href="#fn.22">22</a></sup></i> and to store our assumptions
and cleaning decisions separate from the <i>raw</i> data in a schema that
<i>semantically</i> transmits that "this is our cleaned data."
</p>

<p>
The <code>cleaned</code> schema will contain two tables: <code>cleaned.inspections</code>
and <code>cleaned.violations</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">create</span> <span style="color: #8ac6f2;">schema</span> if <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">exists</span> cleaned;
</pre>
</div>

<p>
Then, we will create our mini <b>ETL</b> with our cleaning decisions:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">drop</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">if</span> <span style="color: #8ac6f2;">exists</span> cleaned.inspections <span style="color: #8ac6f2;">cascade</span>;

<span style="color: #8ac6f2;">create</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">cleaned.inspections</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8c8c8c;">(</span>
        <span style="color: #8ac6f2;">with</span> cleaned <span style="color: #8ac6f2;">as</span> <span style="color: #93a8c6;">(</span>
        <span style="color: #8ac6f2;">select</span>
            inspection::<span style="color: #92a65e;">integer</span>,
            btrim<span style="color: #b0b1a3;">(</span><span style="color: #e5786d;">lower</span><span style="color: #97b098;">(</span>results<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8ac6f2;">result</span>,
            license_num::<span style="color: #92a65e;">integer</span>,
            btrim<span style="color: #b0b1a3;">(</span><span style="color: #e5786d;">lower</span><span style="color: #97b098;">(</span>dba_name<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> facility,
            btrim<span style="color: #b0b1a3;">(</span><span style="color: #e5786d;">lower</span><span style="color: #97b098;">(</span>aka_name<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> facility_aka,
            <span style="color: #8ac6f2;">case</span> <span style="color: #8ac6f2;">when</span>
            facility_type <span style="color: #8ac6f2;">is</span> <span style="color: #8ac6f2;">null</span> <span style="color: #8ac6f2;">then</span> <span style="color: #95e454;">'unknown'</span>
            <span style="color: #8ac6f2;">else</span> btrim<span style="color: #b0b1a3;">(</span><span style="color: #e5786d;">lower</span><span style="color: #97b098;">(</span>facility_type<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
            <span style="color: #8ac6f2;">end</span> <span style="color: #8ac6f2;">as</span> facility_type,
            <span style="color: #e5786d;">lower</span><span style="color: #b0b1a3;">(</span><span style="color: #e5786d;">substring</span><span style="color: #97b098;">(</span>risk <span style="color: #8ac6f2;">from</span> <span style="color: #95e454;">'\((.+)\)'</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> risk,
            btrim<span style="color: #b0b1a3;">(</span><span style="color: #e5786d;">lower</span><span style="color: #97b098;">(</span>address<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> address,
            zip <span style="color: #8ac6f2;">as</span> zip_code,
            <span style="color: #e5786d;">substring</span><span style="color: #b0b1a3;">(</span>
                btrim<span style="color: #97b098;">(</span><span style="color: #e5786d;">lower</span><span style="color: #aebed8;">(</span>regexp_replace<span style="color: #b0b0b3;">(</span><span style="color: #8ac6f2;">type</span>, <span style="color: #95e454;">'liquor'</span>, <span style="color: #95e454;">'task force'</span>, <span style="color: #95e454;">'gi'</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            <span style="color: #8ac6f2;">from</span> <span style="color: #95e454;">'canvass|task force|complaint|food poisoning|consultation|license|tag removal'</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8ac6f2;">type</span>,
            <span style="color: #92a65e;">date</span>,
            <span style="color: #99968b;">-- point(longitude, latitude) as location</span>
            ST_SetSRID<span style="color: #b0b1a3;">(</span>ST_MakePoint<span style="color: #97b098;">(</span>longitude, latitude<span style="color: #97b098;">)</span>, 4326<span style="color: #b0b1a3;">)</span>::geography <span style="color: #8ac6f2;">as</span> location  <span style="color: #99968b;">-- We use geography so the measurements are in meters</span>
        <span style="color: #8ac6f2;">from</span> raw.inspections
        <span style="color: #8ac6f2;">where</span> zip <span style="color: #8ac6f2;">is</span> <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">null</span>  <span style="color: #99968b;">-- removing NULL zip codes</span>
            <span style="color: #93a8c6;">)</span>

    <span style="color: #8ac6f2;">select</span> * <span style="color: #8ac6f2;">from</span> cleaned <span style="color: #8ac6f2;">where</span> <span style="color: #8ac6f2;">type</span> <span style="color: #8ac6f2;">is</span> <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">null</span>
        <span style="color: #8c8c8c;">)</span>;
</pre>
</div>

<p>
You could execute this code from the command line using <code>psql</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">psql $<span style="color: #8c8c8c;">{</span><span style="color: #cae682;">FOOD_DB_URL</span><span style="color: #8c8c8c;">}</span> &lt; /sql/create_cleaned_inspections_table.sql
</pre>
</div>

<p>
Or if you're in <code>psql</code>:
</p>

<pre class="example">
\i /sql/create_cleaned_inspections_table.sql
</pre>

<p>
The number of inspections now is:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    to_char<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>inspection<span style="color: #93a8c6;">)</span>, <span style="color: #95e454;">'999,999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> <span style="color: #e5786d;">count</span>
<span style="color: #8ac6f2;">from</span> cleaned.inspections;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">179,977</td>
</tr>
</tbody>
</table>

<p>
Note that  quantity is smaller  is smaller than the one from
<code>raw.inspections</code>,
since we throw away some inspections.
</p>

<p>
With the <code>cleaned.inspections</code> table created, let's take a closer look at
the <code>violations</code> column to figure out how to clean it.
</p>

<p>
The first thing to note is that the column <code>violation</code> has a lot of information:
it describes the code violation, what's required to address it (see
 <a href="#org38885ba">3.2.2</a>), and the inspector's comments. The
comments are free text, which means that they can contain line breaks,
mispellings, etc. In particular, note that pipes (<code>|</code>) seperate multiple violations.
</p>

<p>
The following <code>sql</code> code removes line breaks and multiple spaces and
creates an array with all the violations for inspection number <code>2145736</code>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    <span style="color: #8ac6f2;">unnest</span><span style="color: #8c8c8c;">(</span>string_to_array<span style="color: #93a8c6;">(</span>regexp_replace<span style="color: #b0b1a3;">(</span>violations, <span style="color: #95e454;">'[\n\r]+'</span>, <span style="color: #95e454;">' '</span>, <span style="color: #95e454;">'g'</span> <span style="color: #b0b1a3;">)</span>, <span style="color: #95e454;">'|'</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #8ac6f2;">as</span> violations_array
<span style="color: #8ac6f2;">from</span> raw.inspections
<span style="color: #8ac6f2;">where</span>
    inspection = <span style="color: #95e454;">'2145736'</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">violations<sub>array</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: FIRST FLOOR GIRL'S WASHROOM,MIDDLE WASHBOWL SINK FAUCET NOT IN GOOD REPAIR, MUST REPAIR AND MAINTAIN.   ONE OUT OF TWO HAND DRYER NOT WORKING IN THE FOLLOWING WASHROOM: FIRST FLOOR  BOY'S AND GIRL'S WASHROOM, AND  BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR AND MAINTAIN.</td>
</tr>

<tr>
<td class="org-left">34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: DAMAGED FLOOR INSIDE THE BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR, MAKE THE FLOOR SMOOTH EASILY CLEANABLE.</td>
</tr>

<tr>
<td class="org-left">35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: MISSING PART OF THE COVING(BASEBOARD) BY THE EXPOSED HAND SINK IN THE KITCHEN. MUST REPAIR AND MAINTAIN.   WATER STAINED CEILING TILES IN THE LUNCH ROOM. MUST REPLACE CEILING TILES AND MAINTAIN.  PEELING PAINT ON THE CEILING AND WALLS THROUGHOUT THE SCHOOL. HALLWAYS, INSIDE THE CLASSROOMS, INSIDE THE WASHROOMS IN ALL FLOORS. INSTRUCTED TO SCRAPE PEELING PAINT AND RE PAINT.</td>
</tr>
</tbody>
</table>

<p>
This little piece of code is doing a lot: first it replaces all the
line breaks <code>[\n\r]+</code> with spaces, then, it splits the string using the
pipe and stores it in an array (<code>string_to_array</code>), finally it returns
every violation description in a row (<code>unnest</code>).
</p>

<p>
From this, we can learn that the structure of the <code>violations</code> column
follows:
</p>

<ul class="org-ul">
<li>If there are several violations reported, those violations will
be separated by <code>'|'</code></li>
<li>Every violation begins with a code and a description</li>
<li>Every violation can have <b>comments</b>, which appear after
the string <code>- Comments:</code></li>
</ul>

<p>
We will create a new table called <code>cleaned.violations</code> to store
</p>

<ul class="org-ul">
<li>inspection</li>
<li>code</li>
<li>description</li>
<li>comments</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">   <span style="color: #8ac6f2;">drop</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">if</span> <span style="color: #8ac6f2;">exists</span> cleaned.violations <span style="color: #8ac6f2;">cascade</span>;

   <span style="color: #8ac6f2;">create</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">cleaned.violations</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8c8c8c;">(</span>
   <span style="color: #8ac6f2;">select</span>
       inspection::<span style="color: #92a65e;">integer</span>,
       license_num::<span style="color: #92a65e;">integer</span>,
       <span style="color: #92a65e;">date</span>::<span style="color: #92a65e;">date</span>,
       btrim<span style="color: #93a8c6;">(</span>tuple<span style="color: #b0b1a3;">[</span>1<span style="color: #b0b1a3;">]</span><span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> code,
       btrim<span style="color: #93a8c6;">(</span>tuple<span style="color: #b0b1a3;">[</span>2<span style="color: #b0b1a3;">]</span><span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> description,
       btrim<span style="color: #93a8c6;">(</span>tuple<span style="color: #b0b1a3;">[</span>3<span style="color: #b0b1a3;">]</span><span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> comment,
       <span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">case</span>
           <span style="color: #8ac6f2;">when</span> btrim<span style="color: #b0b1a3;">(</span>tuple<span style="color: #97b098;">[</span>1<span style="color: #97b098;">]</span><span style="color: #b0b1a3;">)</span> = <span style="color: #95e454;">''</span> <span style="color: #8ac6f2;">then</span> <span style="color: #8ac6f2;">NULL</span>
           <span style="color: #8ac6f2;">when</span> btrim<span style="color: #b0b1a3;">(</span>tuple<span style="color: #97b098;">[</span>1<span style="color: #97b098;">]</span><span style="color: #b0b1a3;">)</span>::<span style="color: #92a65e;">int</span> <span style="color: #8ac6f2;">between</span> 1 <span style="color: #8ac6f2;">and</span> 14 <span style="color: #8ac6f2;">then</span> <span style="color: #95e454;">'critical'</span> <span style="color: #99968b;">-- From the documentation</span>
           <span style="color: #8ac6f2;">when</span> btrim<span style="color: #b0b1a3;">(</span>tuple<span style="color: #97b098;">[</span>1<span style="color: #97b098;">]</span><span style="color: #b0b1a3;">)</span>::<span style="color: #92a65e;">int</span> <span style="color: #8ac6f2;">between</span> 15 <span style="color: #8ac6f2;">and</span> 29  <span style="color: #8ac6f2;">then</span> <span style="color: #95e454;">'serious'</span>
           <span style="color: #8ac6f2;">else</span> <span style="color: #95e454;">'minor'</span>
           <span style="color: #8ac6f2;">end</span>
           <span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> severity <span style="color: #8ac6f2;">from</span>
       <span style="color: #93a8c6;">(</span>
       <span style="color: #8ac6f2;">select</span>
           inspection,
           license_num,
           <span style="color: #92a65e;">date</span>,
           regexp_split_to_array<span style="color: #b0b1a3;">(</span>   <span style="color: #99968b;">-- Create an array we will split the code, description, comment</span>
               regexp_split_to_table<span style="color: #97b098;">(</span> <span style="color: #99968b;">-- Create a row per each comment we split by |</span>
                   <span style="color: #e5786d;">coalesce</span><span style="color: #aebed8;">(</span>            <span style="color: #99968b;">-- If there isn't a violation add '- Comments:'</span>
                       regexp_replace<span style="color: #b0b0b3;">(</span>violations, <span style="color: #95e454;">'[\n\r]+'</span>, <span style="color: #95e454;">''</span>, <span style="color: #95e454;">'g'</span> <span style="color: #b0b0b3;">)</span>  <span style="color: #99968b;">-- Remove line breaks</span>
                       , <span style="color: #95e454;">'- Comments:'</span><span style="color: #aebed8;">)</span>
                   , <span style="color: #95e454;">'\|'</span><span style="color: #97b098;">)</span>  <span style="color: #99968b;">-- Split the violations</span>
               , <span style="color: #95e454;">'(?&lt;=\d+)\.\s*|\s*-\s*Comments:'</span><span style="color: #b0b1a3;">)</span>  <span style="color: #99968b;">-- Split each violation in three</span>
           <span style="color: #8ac6f2;">as</span> tuple
       <span style="color: #8ac6f2;">from</span> raw.inspections
       <span style="color: #8ac6f2;">where</span> results <span style="color: #8ac6f2;">in</span> <span style="color: #b0b1a3;">(</span><span style="color: #95e454;">'Fail'</span>, <span style="color: #95e454;">'Pass'</span>, <span style="color: #95e454;">'Pass w/ Conditions'</span><span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">and</span> license_num <span style="color: #8ac6f2;">is</span> <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">null</span>
           <span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> t
       <span style="color: #8c8c8c;">)</span>;
</pre>
</div>

<p>
This code is in <code>/sql/create_violations_table.sql</code>. You can execute
 it with psql's -f option, as before.
</p>

<p>
We can verify the result of the previous script
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    inspection, <span style="color: #92a65e;">date</span>, code, description
<span style="color: #8ac6f2;">from</span> cleaned.violations
<span style="color: #8ac6f2;">where</span>
    inspection = 2145736
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    code <span style="color: #8ac6f2;">asc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">code</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2145736</td>
<td class="org-right">2018-03-01</td>
<td class="org-right">32</td>
<td class="org-left">FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED</td>
</tr>

<tr>
<td class="org-right">2145736</td>
<td class="org-right">2018-03-01</td>
<td class="org-right">34</td>
<td class="org-left">FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED</td>
</tr>

<tr>
<td class="org-right">2145736</td>
<td class="org-right">2018-03-01</td>
<td class="org-right">35</td>
<td class="org-left">WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS</td>
</tr>
</tbody>
</table>


<p>
If everything worked correctly you should be able to run the following code<sup><a id="fnr.23" class="footref" href="#fn.23">23</a></sup>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    <span style="color: #8ac6f2;">case</span>
    <span style="color: #8ac6f2;">when</span>
    <span style="color: #8ac6f2;">grouping</span><span style="color: #8c8c8c;">(</span>severity<span style="color: #8c8c8c;">)</span> = 1 <span style="color: #8ac6f2;">then</span> <span style="color: #95e454;">'TOTAL'</span>
    <span style="color: #8ac6f2;">else</span>
    severity
    <span style="color: #8ac6f2;">end</span> <span style="color: #8ac6f2;">as</span> severity,
    to_char<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>*<span style="color: #93a8c6;">)</span>, <span style="color: #95e454;">'999,999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> <span style="color: #e5786d;">count</span>
<span style="color: #8ac6f2;">from</span>
    cleaned.violations
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #8ac6f2;">rollup</span> <span style="color: #8c8c8c;">(</span>severity<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    severity nulls <span style="color: #8ac6f2;">first</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">severity</th>
<th scope="col" class="org-left">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">¤</td>
<td class="org-left">25,919</td>
</tr>

<tr>
<td class="org-left">critical</td>
<td class="org-left">44,385</td>
</tr>

<tr>
<td class="org-left">minor</td>
<td class="org-left">460,796</td>
</tr>

<tr>
<td class="org-left">serious</td>
<td class="org-left">52,865</td>
</tr>

<tr>
<td class="org-left">TOTAL</td>
<td class="org-left">583,965</td>
</tr>
</tbody>
</table>

<p>
As a last step, we should create from the cleaned tables the <code>entities</code>
and <code>events</code> tables.
</p>
</div>
</div>
</div>

<div id="outline-container-org2f8a239" class="outline-3">
<h3 id="org2f8a239"><span class="section-number-3">3.3</span> Semantic tables</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-orga55d59f" class="outline-4">
<h4 id="orga55d59f"><span class="section-number-4">3.3.1</span> Entities table</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
The <code>entities</code> table should uniquely identify each facility and contain
descriptive attributes. First, we should investigate how we can uniquely
identify a facility. Let's hope it's easy<sup><a id="fnr.24" class="footref" href="#fn.24">24</a></sup>.
</p>

<p>
Let's start with the obvious option. Perhaps <code>license_num</code> is a unique
identifier. Let's confirm our hypothesis with some queries.
</p>

<p>
We will begin with the following query: <i>What are 5 licenses with the most inspections?</i>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    license_num,
    to_char<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>*<span style="color: #93a8c6;">)</span>, <span style="color: #95e454;">'999,999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_inspections,
    <span style="color: #e5786d;">coalesce</span><span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>*<span style="color: #93a8c6;">)</span> filter <span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">where</span> <span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span><span style="color: #93a8c6;">)</span>, 0<span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">as</span> total_failures
<span style="color: #8ac6f2;">from</span>
    cleaned.inspections
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    license_num
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
     <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">desc</span>
    <span style="color: #8ac6f2;">limit</span> 5;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">license<sub>num</sub></th>
<th scope="col" class="org-right">total<sub>inspections</sub></th>
<th scope="col" class="org-right">total<sub>failures</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">453</td>
<td class="org-right">114</td>
</tr>

<tr>
<td class="org-right">1354323</td>
<td class="org-right">192</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">14616</td>
<td class="org-right">174</td>
<td class="org-right">31</td>
</tr>

<tr>
<td class="org-right">1574001</td>
<td class="org-right">82</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">1974745</td>
<td class="org-right">59</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>


<p>
This looks weird. There are three license numbers, in particular license number <code>0</code>,
 that have many more inspections than the rest. Let's
 investigate <code>license_num</code> = <code>0</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">select</span>
      facility_type,
      <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_inspections,
      <span style="color: #e5786d;">coalesce</span><span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>*<span style="color: #93a8c6;">)</span> filter <span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">where</span> <span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span><span style="color: #93a8c6;">)</span>, 0<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_failures
  <span style="color: #8ac6f2;">from</span>
      cleaned.inspections
  <span style="color: #8ac6f2;">where</span>
      license_num=0
  <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
      facility_type
  <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
      total_inspections <span style="color: #8ac6f2;">desc</span>
  <span style="color: #8ac6f2;">limit</span> 10;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">facility<sub>type</sub></th>
<th scope="col" class="org-right">total<sub>inspections</sub></th>
<th scope="col" class="org-right">total<sub>failures</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">restaurant</td>
<td class="org-right">104</td>
<td class="org-right">44</td>
</tr>

<tr>
<td class="org-left">special event</td>
<td class="org-right">73</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-left">unknown</td>
<td class="org-right">44</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-left">shelter</td>
<td class="org-right">31</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">navy pier kiosk</td>
<td class="org-right">30</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">church</td>
<td class="org-right">30</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">grocery store</td>
<td class="org-right">16</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-left">school</td>
<td class="org-right">12</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">long term care</td>
<td class="org-right">11</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">church kitchen</td>
<td class="org-right">11</td>
<td class="org-right">4</td>
</tr>
</tbody>
</table>

<p>
It seems that <code>license_number</code> <code>0</code> is a generic placeholder:
Most of these are related to <i>special events</i>, <i>churches</i>, <i>festivals</i>,
etc. But what about the <code>restaurants</code> that have <code>license_num</code> =
<code>0</code>? Are those the same restaurant?
</p>


<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">select</span>
      license_num,
      facility,
      address,
      <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_inspections,
      <span style="color: #e5786d;">coalesce</span><span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>*<span style="color: #93a8c6;">)</span> filter <span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">where</span> <span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span><span style="color: #93a8c6;">)</span>, 0<span style="color: #8c8c8c;">)</span>
      <span style="color: #8ac6f2;">as</span> total_failures
  <span style="color: #8ac6f2;">from</span>
      cleaned.inspections
  <span style="color: #8ac6f2;">where</span>
      license_num = 0
      <span style="color: #8ac6f2;">and</span>
      facility_type = <span style="color: #95e454;">'restaurant'</span>
  <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
      license_num, facility, address
  <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
      total_inspections <span style="color: #8ac6f2;">desc</span>
  <span style="color: #8ac6f2;">limit</span> 10;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">license<sub>num</sub></th>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">address</th>
<th scope="col" class="org-right">total<sub>inspections</sub></th>
<th scope="col" class="org-right">total<sub>failures</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-left">british airways</td>
<td class="org-left">11601 w touhy ave</td>
<td class="org-right">5</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">rib lady 2</td>
<td class="org-left">4203 w cermak rd</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">taqueria la capital</td>
<td class="org-left">3508 w 63rd st</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">nutricion familiar</td>
<td class="org-left">3000 w 59th st</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">salvation army</td>
<td class="org-left">506 n des plaines st</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">herbalife</td>
<td class="org-left">6214 w diversey ave</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">la michoacana</td>
<td class="org-left">4346 s california ave</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">las quecas</td>
<td class="org-left">2500 s christiana ave</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">mrs. t's southern fried chicken</td>
<td class="org-left">3343 n broadway</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">unlicensed</td>
<td class="org-left">7559 n ridge blvd</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<p>
Nope. Unfortunately, <code>license_num</code> is not a unique identifier.
</p>

<p>
Perhaps <code>license_num</code> and <code>address</code> are a unique identifier.
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #8ac6f2;">select</span>
  <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">distinct</span> license_num<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_licenses,
  <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">distinct</span> facility<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_facilities,
  <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">distinct</span> address<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_addresses
  <span style="color: #8ac6f2;">from</span> cleaned.inspections;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">total<sub>licenses</sub></th>
<th scope="col" class="org-right">total<sub>facilities</sub></th>
<th scope="col" class="org-right">total<sub>addresses</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">35420</td>
<td class="org-right">26060</td>
<td class="org-right">17492</td>
</tr>
</tbody>
</table>

<p>
We were expecting (naively) that we should get one <code>license_num</code> per
<code>facility</code> per <code>address</code>, but that isn't the case. Perhaps
several facilities share a name (e.g. "Subway" or "McDonalds") or
license, or perhaps several facilities share the same
address, such as facilities at the stadium or the airport.
</p>

<p>
We will try to use the combination of <code>license_num</code>, <code>facility</code>, <code>facility_aka</code>,
<code>facility_type</code>, and <code>address</code> to identify a facility:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    license_num, facility, facility_type, facility_aka, address , <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">from</span>
    cleaned.inspections
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    license_num, facility, facility_type, facility_aka, address
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">desc</span>, facility, facility_aka, address, license_num, facility_type
<span style="color: #8ac6f2;">limit</span> 10;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">license<sub>num</sub></th>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">facility<sub>type</sub></th>
<th scope="col" class="org-left">facility<sub>aka</sub></th>
<th scope="col" class="org-left">address</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1142451</td>
<td class="org-left">jewel food  store # 3345</td>
<td class="org-left">grocery store</td>
<td class="org-left">jewel food  store # 3345</td>
<td class="org-left">1224 s wabash ave</td>
<td class="org-right">46</td>
</tr>

<tr>
<td class="org-right">1490035</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">restaurant</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">6900 s lafayette ave</td>
<td class="org-right">46</td>
</tr>

<tr>
<td class="org-right">1596210</td>
<td class="org-left">food 4 less midwest #552</td>
<td class="org-left">grocery store</td>
<td class="org-left">food 4 less</td>
<td class="org-left">7030 s ashland ave</td>
<td class="org-right">45</td>
</tr>

<tr>
<td class="org-right">2083833</td>
<td class="org-left">mariano's fresh market #8503</td>
<td class="org-left">grocery store</td>
<td class="org-left">mariano's fresh market</td>
<td class="org-left">333 e benton pl</td>
<td class="org-right">43</td>
</tr>

<tr>
<td class="org-right">60184</td>
<td class="org-left">taqueria el ranchito</td>
<td class="org-left">restaurant</td>
<td class="org-left">taqueria el ranchito</td>
<td class="org-left">2829 n milwaukee ave</td>
<td class="org-right">42</td>
</tr>

<tr>
<td class="org-right">1476553</td>
<td class="org-left">pete's produce</td>
<td class="org-left">grocery store</td>
<td class="org-left">pete's produce</td>
<td class="org-left">1543 e 87th st</td>
<td class="org-right">41</td>
</tr>

<tr>
<td class="org-right">1000572</td>
<td class="org-left">jewel food store #3030</td>
<td class="org-left">grocery store</td>
<td class="org-left">jewel food store #3030</td>
<td class="org-left">7530 s stony island ave</td>
<td class="org-right">40</td>
</tr>

<tr>
<td class="org-right">1302136</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">restaurant</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">70 e garfield blvd</td>
<td class="org-right">40</td>
</tr>

<tr>
<td class="org-right">1094</td>
<td class="org-left">one stop food &amp; liquor store</td>
<td class="org-left">grocery store</td>
<td class="org-left">one stop food &amp; liquor store</td>
<td class="org-left">4301-4323 s lake park ave</td>
<td class="org-right">39</td>
</tr>

<tr>
<td class="org-right">2108657</td>
<td class="org-left">morrison's restaurant</td>
<td class="org-left">restaurant</td>
<td class="org-left">morrison's restaurant</td>
<td class="org-left">8127 s ashland ave</td>
<td class="org-right">38</td>
</tr>
</tbody>
</table>

<p>
Yay, it looks like these columns enable us to identify a facility!
</p>

<p>
The <code>entities</code> table should store two other types of attributes. The
first type describe the entity no matter the time. If the entity were
a person, date of birth would be an example but age would not because
the latter changes but the former does not. We'll include <code>zip_code</code>
and <code>location</code> as two facility attributes.
</p>

<p>
The second type describes when the entity is available for
action (e.g. inspection). In this case, the columns <code>start_time, end_time</code>
describe the interval in which the facility is in business or <i>active</i>.
These columns are important because we don't want to make predictions for
inactive entities.
</p>

<p>
The data don't contain active/inactive date columns, so we
will use the date of the facility's first inspection as <code>start_time</code>,
and either <code>NULL</code> or the date of inspection if the result was <code>out of business</code>
or <code>business not located</code> as <code>end_time</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">create</span> <span style="color: #8ac6f2;">schema</span> if <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">exists</span> semantic;

<span style="color: #8ac6f2;">drop</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">if</span> <span style="color: #8ac6f2;">exists</span> semantic.entities <span style="color: #8ac6f2;">cascade</span>;

<span style="color: #8ac6f2;">create</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">semantic.entities</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8c8c8c;">(</span>
        <span style="color: #8ac6f2;">with</span> entities <span style="color: #8ac6f2;">as</span> <span style="color: #93a8c6;">(</span>
        <span style="color: #8ac6f2;">select</span>
            <span style="color: #8ac6f2;">distinct</span> <span style="color: #8ac6f2;">on</span> <span style="color: #b0b1a3;">(</span>
                license_num,
                facility,
                facility_aka,
                facility_type,
                address
                <span style="color: #b0b1a3;">)</span>
            license_num,
            facility,
            facility_aka,
            facility_type,
            address,
            zip_code,
            location,
            <span style="color: #e5786d;">min</span><span style="color: #b0b1a3;">(</span><span style="color: #92a65e;">date</span><span style="color: #b0b1a3;">)</span> over <span style="color: #b0b1a3;">(</span>partition <span style="color: #8ac6f2;">by</span> license_num, facility, facility_aka, facility_type, address<span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> start_time,
            <span style="color: #e5786d;">max</span><span style="color: #b0b1a3;">(</span><span style="color: #8ac6f2;">case</span> <span style="color: #8ac6f2;">when</span> <span style="color: #8ac6f2;">result</span> <span style="color: #8ac6f2;">in</span> <span style="color: #97b098;">(</span><span style="color: #95e454;">'out of business'</span>, <span style="color: #95e454;">'business not located'</span><span style="color: #97b098;">)</span>
                <span style="color: #8ac6f2;">then</span> <span style="color: #92a65e;">date</span>
                <span style="color: #8ac6f2;">else</span> <span style="color: #8ac6f2;">NULL</span>
                <span style="color: #8ac6f2;">end</span><span style="color: #b0b1a3;">)</span>
            over <span style="color: #b0b1a3;">(</span>partition <span style="color: #8ac6f2;">by</span> license_num, facility, facility_aka, address<span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> end_time
        <span style="color: #8ac6f2;">from</span> cleaned.inspections
        <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
            license_num, facility, facility_aka, facility_type, address,
            <span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">asc</span> <span style="color: #99968b;">-- IMPORTANT!!</span>
            <span style="color: #93a8c6;">)</span>

    <span style="color: #8ac6f2;">select</span>
        row_number<span style="color: #93a8c6;">()</span> over <span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> start_time <span style="color: #8ac6f2;">asc</span> <span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> entity_id,
        license_num,
        facility,
        facility_aka,
        facility_type,
        address,
        zip_code,
        location,
        start_time,
        end_time,
        daterange<span style="color: #93a8c6;">(</span>start_time, end_time<span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> activity_period
    <span style="color: #8ac6f2;">from</span> entities
        <span style="color: #8c8c8c;">)</span>;
</pre>
</div>

<p>
Note that we added a <i>unique</i> identifier (<code>entity_id</code>) to this table. This
identifier was assigned using a PostgreSQL idiom: <code>distinct
on()</code>. <code>DISTINCT ON</code> keeps the "first" row of each group. If
you are interested in this powerful technique see this <a href="http://www.postgresqltutorial.com/postgresql-select-distinct/">blogpost</a>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    to_char<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>entity_id<span style="color: #93a8c6;">)</span>, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> entities
<span style="color: #8ac6f2;">from</span>
    semantic.entities;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">entities</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">36,780</td>
</tr>
</tbody>
</table>

<p>
We will add some indexes to this table:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">create</span> index entities_ix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8c8c8c;">(</span>entity_id<span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index entities_license_num_ix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8c8c8c;">(</span>license_num<span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index entities_facility_ix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8c8c8c;">(</span>facility<span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index entities_facility_type_ix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8c8c8c;">(</span>facility_type<span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index entities_zip_code_ix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8c8c8c;">(</span>zip_code<span style="color: #8c8c8c;">)</span>;

<span style="color: #99968b;">-- Spatial index</span>
<span style="color: #8ac6f2;">create</span> index entities_location_gix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8ac6f2;">using</span> gist <span style="color: #8c8c8c;">(</span>location<span style="color: #8c8c8c;">)</span>;

<span style="color: #8ac6f2;">create</span> index entities_full_key_ix <span style="color: #8ac6f2;">on</span> semantic.entities <span style="color: #8c8c8c;">(</span>license_num, facility, facility_aka, facility_type, address<span style="color: #8c8c8c;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e12341" class="outline-4">
<h4 id="org1e12341"><span class="section-number-4">3.3.2</span> Events table</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
We are ready to create the events table. This table will describe
the inspection, like the <i>type</i> of inspection, <i>when</i> and <i>where</i>
the inspection happened, and the inspection <i>result</i>. We will add
the violations as a <code>JSONB</code> column.<sup><a id="fnr.25" class="footref" href="#fn.25">25</a></sup> Finally, we'll rename
<code>inspection</code> as <code>event_id</code>.<sup><a id="fnr.26" class="footref" href="#fn.26">26</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">drop</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">if</span> <span style="color: #8ac6f2;">exists</span> semantic.events <span style="color: #8ac6f2;">cascade</span>;

<span style="color: #8ac6f2;">create</span> <span style="color: #8ac6f2;">table</span> <span style="color: #cae682;">semantic.events</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8c8c8c;">(</span>

        <span style="color: #8ac6f2;">with</span> entities <span style="color: #8ac6f2;">as</span> <span style="color: #93a8c6;">(</span>
        <span style="color: #8ac6f2;">select</span> * <span style="color: #8ac6f2;">from</span> semantic.entities
            <span style="color: #93a8c6;">)</span>,

        inspections <span style="color: #8ac6f2;">as</span> <span style="color: #93a8c6;">(</span>
        <span style="color: #8ac6f2;">select</span>
            i.inspection, i.<span style="color: #8ac6f2;">type</span>, i.<span style="color: #92a65e;">date</span>, i.risk, i.<span style="color: #8ac6f2;">result</span>,
            i.license_num, i.facility, i.facility_aka,
            i.facility_type, i.address, i.zip_code, i.location,
            jsonb_agg<span style="color: #b0b1a3;">(</span>
                jsonb_build_object<span style="color: #97b098;">(</span>
                    <span style="color: #95e454;">'code'</span>, v.code,
                    <span style="color: #95e454;">'severity'</span>, v.severity,
                    <span style="color: #95e454;">'description'</span>, v.description,
                    <span style="color: #95e454;">'comment'</span>, v.comment
                    <span style="color: #97b098;">)</span>
            <span style="color: #8ac6f2;">order</span>  <span style="color: #8ac6f2;">by</span> code
                <span style="color: #b0b1a3;">)</span> <span style="color: #8ac6f2;">as</span> violations
        <span style="color: #8ac6f2;">from</span>
            cleaned.inspections <span style="color: #8ac6f2;">as</span> i
            <span style="color: #8ac6f2;">inner</span> <span style="color: #8ac6f2;">join</span>
            cleaned.violations <span style="color: #8ac6f2;">as</span> v
            <span style="color: #8ac6f2;">on</span> i.inspection = v.inspection
        <span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
            i.inspection, i.<span style="color: #8ac6f2;">type</span>, i.license_num, i.facility,
            i.facility_aka, i.facility_type, i.address, i.zip_code, i.location,
            i.<span style="color: #92a65e;">date</span>, i.risk, i.<span style="color: #8ac6f2;">result</span>
            <span style="color: #93a8c6;">)</span>

    <span style="color: #8ac6f2;">select</span>
        i.inspection <span style="color: #8ac6f2;">as</span> event_id,
        e.entity_id, i.<span style="color: #8ac6f2;">type</span>, i.<span style="color: #92a65e;">date</span>, i.risk, i.<span style="color: #8ac6f2;">result</span>,
        e.facility_type, e.zip_code, e.location,
        i.violations
    <span style="color: #8ac6f2;">from</span>
        entities <span style="color: #8ac6f2;">as</span> e
        <span style="color: #8ac6f2;">inner</span> <span style="color: #8ac6f2;">join</span>
        inspections <span style="color: #8ac6f2;">as</span> i
        <span style="color: #8ac6f2;">using</span> <span style="color: #93a8c6;">(</span>license_num, facility, facility_aka, facility_type, address, zip_code<span style="color: #93a8c6;">)</span>
        <span style="color: #8c8c8c;">)</span>;

<span style="color: #99968b;">-- Add some indices</span>
<span style="color: #8ac6f2;">create</span> index events_entity_ix <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8c8c8c;">(</span>entity_id <span style="color: #8ac6f2;">asc</span> nulls <span style="color: #8ac6f2;">last</span><span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index events_event_ix <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8c8c8c;">(</span>event_id <span style="color: #8ac6f2;">asc</span> nulls <span style="color: #8ac6f2;">last</span><span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index events_type_ix <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">type</span><span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index events_date_ix <span style="color: #8ac6f2;">on</span> semantic.events<span style="color: #8c8c8c;">(</span><span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">asc</span> nulls <span style="color: #8ac6f2;">last</span><span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index events_facility_type_ix <span style="color: #8ac6f2;">on</span> semantic.events  <span style="color: #8c8c8c;">(</span>facility_type<span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index events_zip_code_ix <span style="color: #8ac6f2;">on</span> semantic.events  <span style="color: #8c8c8c;">(</span>zip_code<span style="color: #8c8c8c;">)</span>;

<span style="color: #99968b;">-- Spatial index</span>
<span style="color: #8ac6f2;">create</span> index events_location_gix <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8ac6f2;">using</span> gist <span style="color: #8c8c8c;">(</span>location<span style="color: #8c8c8c;">)</span>;

<span style="color: #99968b;">-- JSONB indices</span>
<span style="color: #8ac6f2;">create</span> index events_violations <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8ac6f2;">using</span> gin<span style="color: #8c8c8c;">(</span>violations<span style="color: #8c8c8c;">)</span>;
<span style="color: #8ac6f2;">create</span> index events_violations_json_path <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8ac6f2;">using</span> gin<span style="color: #8c8c8c;">(</span>violations jsonb_path_ops<span style="color: #8c8c8c;">)</span>;

<span style="color: #8ac6f2;">create</span> index events_event_entity_zip_code_date <span style="color: #8ac6f2;">on</span> semantic.events <span style="color: #8c8c8c;">(</span>event_id <span style="color: #8ac6f2;">asc</span> nulls <span style="color: #8ac6f2;">last</span>, entity_id <span style="color: #8ac6f2;">asc</span> nulls <span style="color: #8ac6f2;">last</span>, zip_code, <span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">desc</span> nulls <span style="color: #8ac6f2;">last</span><span style="color: #8c8c8c;">)</span>;

</pre>
</div>

<p>
Success! We have one row per event.<sup><a id="fnr.27" class="footref" href="#fn.27">27</a></sup> Our semantic data looks like:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    event_id,
    entity_id,
    <span style="color: #8ac6f2;">type</span>,
    <span style="color: #92a65e;">date</span>,
    risk,
    <span style="color: #8ac6f2;">result</span>,
    facility_type,
    zip_code
<span style="color: #8ac6f2;">from</span>
    semantic.events <span style="color: #8ac6f2;">limit</span> 1;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">event<sub>id</sub></th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-left">risk</th>
<th scope="col" class="org-left">result</th>
<th scope="col" class="org-left">facility<sub>type</sub></th>
<th scope="col" class="org-right">zip<sub>code</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1343315</td>
<td class="org-right">22056</td>
<td class="org-left">canvass</td>
<td class="org-right">2013-06-06</td>
<td class="org-left">low</td>
<td class="org-left">fail</td>
<td class="org-left">newsstand</td>
<td class="org-right">60623</td>
</tr>
</tbody>
</table>

<p>
We omitted <code>violations</code> and <code>location</code> for brevity. The total number of inspections is
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    to_char<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">count</span><span style="color: #93a8c6;">(</span>event_id<span style="color: #93a8c6;">)</span>, <span style="color: #95e454;">'999,999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> events
<span style="color: #8ac6f2;">from</span> semantic.events;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">events</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">155,374</td>
</tr>
</tbody>
</table>

<p>
Now that we have our data in a good shape, we are ready to use <b>Triage</b>.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb8b9011" class="outline-2">
<h2 id="orgb8b9011"><span class="section-number-2">4</span> Triage</h2>
<div class="outline-text-2" id="text-4">
<p>
Predictive analytics projects require coordinating many
tasks, such as feature generation, classifier training,
evaluation, and list generation. Each of these tasks is complicated
in its own right, but it also needs to be combined with the other
tasks throughout the course of the project.
</p>

<p>
DSaPP built <code>triage</code> to facilitate the creation of supervised learning
models, in particular <i>binary</i> classification models with a strong temporal
component in the data.
</p>

<p>
The dataset's temporal component mainly affects two modeling steps:
<i>feature creation</i> (you need to be careful to
avoid <i>leaking</i> information from the future through your <i>features</i>)
and hyperparameter selection. <code>triage</code> solves both by
splitting the data into temporal blocks and automating temporal
cross-validation and the feature generation.
</p>

<p>
<code>triage</code> uses the concept of an <i>experiment</i>. An <i>experiment</i> consists of a
series of steps that aim to generate a good model for predicting the
<i>label</i> of an entity in the data set. The steps are <i>data
time-splitting</i>, <i>label generation</i>, <i>feature generation</i>, <i>matrix creation</i>,
<i>model training</i>, <i>predictions</i>, and <i>model evaluation</i>. In each of these steps, <code>triage</code>
will handle the temporal nuances of the data.
</p>

<p>
Nowadays <code>triage</code> will
help you to select the best model (<i>model selection</i>) and it allows you
to explore and understand the behavior of your models using
<b>post-modeling</b> techniques.
</p>

<p>
You need to specify (via a configuration file) how you want to
split your data temporally, which combination of machine learning algorithms and
their hyperparameters you'd like to use, which kinds of features you want
to generate, which subsets of those features you want to try in each
model, and which metrics you'd like to use to evaluate performance and
provide some criteria to select the best model.
</p>

<p>
An <b>experiment run</b> consists in fitting every combination of algorithm,
hyperparameters, and feature subsets to the temporally split data and
evaluating their predictive performance on future data splits
using the user's metrics.
</p>

<p>
<code>triage</code> calls a unique combination of algorithm,
hyperparameters, and feature subsets a <code>model_group</code> and a model group fit
to a specific data matrix a <code>model</code>. Our data typically span multiple
time periods, so triage fits multiple models for each model group.
</p>

<p>
<code>triage</code> is simple to use, but it contains a lot of complex
concepts that we will try to clarify in this section. First we will
explain <i>how</i> to run <code>triage</code>, and then we will create a toy experiment
that helps explain triage's main concepts.
</p>
</div>

<div id="outline-container-org3a6fa67" class="outline-3">
<h3 id="org3a6fa67"><span class="section-number-3">4.1</span> Triage interface</h3>
<div class="outline-text-3" id="text-4-1">
<p>
To run a <code>triage</code> experiment, you need the following:
</p>

<ul class="org-ul">
<li>A database with the data that you want to model.
<ul class="org-ul">
<li>credentials for accessing this database are stored in a <code>database.yaml</code> file. For this tutorial, you can copy the example config file at <a href="../triage/experiment_config/example_database.yaml">../triage/experiment_config/example_database.yaml</a> and rename it to <code>database.yaml</code>. Be sure to edit it with the database password you specified in <code>.env</code> previously as well.</li>
</ul></li>

<li><code>triage</code> installed in your environment. You can verify that <code>triage</code> is installed (and check
its version) typying the following inside an <code>ipython</code> session in <code>bastion</code>:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">triage -h
:
</pre>
</div>

<ul class="org-ul">
<li>An <i>experiment config file</i>. This is where the magic happens. We will
discuss this file at length in this section of the tutorial.</li>
</ul>

<p>
We are providing a <code>docker</code> container that executes <code>triage</code> experiments.
You already had the database (you were working on it the last two
sections of this tutorial, remember?). So, like a real project, you just
need to worry about the <i>experiment configuration file</i>.
</p>

<p>
In the following section of the tutorial we will use a small experiment
configuration file located at <a href="../triage/experiment_config/simple_test_skeleton.yaml">../triage/experiment_config/simple_test_skeleton.yaml</a>.
</p>

<p>
We will show you how to setup the experiment while explaining the
inner workings of <code>triage</code>. We will modify the
configuration file to show the effects of the configuration
parameters. If you want to follow along, we suggest you copy that file
and modify by yourself.
</p>

<p>
You can run that experiment with:
</p>

<pre class="example">
# Remember to run this in bastion NOT in your laptop!
triage experiment experiment_config/simple_test_skeleton.yaml --project-path /triage/output
</pre>

<p>
Every time you modify the configuration file and see the effects,
you should execute the experiment again using the previous command.
</p>
</div>
</div>

<div id="outline-container-orgfa749fd" class="outline-3">
<h3 id="orgfa749fd"><span class="section-number-3">4.2</span> A simple <code>triage</code> experiment</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-orgf36e9ac" class="outline-4">
<h4 id="orgf36e9ac"><span class="section-number-4">4.2.1</span> A brief recap of Machine Learning</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
<b>Triage</b> helps you to run a <i>Machine learning</i> experiment. An experiment
in this context means the use of Machine Learning to explore
a dynamic system  in order to do some predictions about it.
</p>

<p>
Before execute the <i>any</i> ML experiment, you need to define some <i>boundaries</i>:
</p>

<ul class="org-ul">
<li>Which are the entities that you want to study?</li>
<li>What will you want to know about them?</li>
</ul>

<p>
In DSaPP, we build ML systems that aim to have social impact,
i.e. help government offices, NGOs or other agents to do their job
better. "Do their job better" means increase their reach
(e.g. identify correctly more entities with some characteristics) using more
efficiently their (scarce) resources (e.g. inspectors, medics, money, etc).
</p>

<p>
With this optic, the <i>boundaries</i> are:
</p>

<dl class="org-dl">
<dt>Cohort</dt><dd>Which are the entities that you want to reach?</dd>
<dt>Label</dt><dd>What will you want to know about them?</dd>
<dt>Label timespan</dt><dd>In what time period?</dd>
<dt>Update frequency</dt><dd>How frequently do you want to intervene?</dd>
<dt>(no term)</dt><dd>How many resources do you have to intervene?</dd>
</dl>

<p>
Triage's experiment configuration file structures this information.
</p>
</div>
</div>

<div id="outline-container-org3e82d33" class="outline-4">
<h4 id="org3e82d33"><span class="section-number-4">4.2.2</span> Cohorts, labels, event dates and as of dates</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
We will use the <i>inspections prioritization</i> as a narrative to help
clarify these concepts:
</p>

<dl class="org-dl">
<dt><i>Which are the entities that you want to reach?</i></dt><dd>Active facilities,
i.e. facilities that exists at the day of the <i>planning</i> inspections. We
don't want to waste city resources (inspectors time) going to
facilities that are out of business.</dd>
<dt>What will you want to know about them?</dt><dd>Will those facilities fail
the inspection?</dd>
<dt>In what time period?</dt><dd>Will those facilities fail the inspection in
the following month?</dd>
<dt>How frequently do you want to intervene?</dt><dd>Every month.</dd>
<dt>How many resources do you have to intervene?</dt><dd>We only have one
inspector, so, one inspection per month</dd>
</dl>

<p>
To exemplify and explain the inner workings of <code>triage</code> in this
scenario,  we will use a subset of the <code>semantic.events</code> table with the
following facilities (i.e. imagine that Chicago only has this three
facilities):
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    entity_id,
    license_num,
    facility_aka,
    facility_type,
    activity_period
<span style="color: #8ac6f2;">from</span>
    semantic.entities
<span style="color: #8ac6f2;">where</span>
    license_num <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>1596210, 1874347, 1142451<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    entity_id <span style="color: #8ac6f2;">asc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-right">license<sub>num</sub></th>
<th scope="col" class="org-left">facility<sub>aka</sub></th>
<th scope="col" class="org-left">facility<sub>type</sub></th>
<th scope="col" class="org-left">activity<sub>period</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">219</td>
<td class="org-right">1596210</td>
<td class="org-left">food 4 less</td>
<td class="org-left">grocery store</td>
<td class="org-left">[2010-01-08,)</td>
</tr>

<tr>
<td class="org-right">362</td>
<td class="org-right">1874347</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">restaurant</td>
<td class="org-left">[2010-01-12,2017-11-09)</td>
</tr>

<tr>
<td class="org-right">859</td>
<td class="org-right">1142451</td>
<td class="org-left">jewel food  store # 3345</td>
<td class="org-left">grocery store</td>
<td class="org-left">[2010-01-26,)</td>
</tr>
</tbody>
</table>


<p>
The first thing <code>triage</code> does when executes the experiment, is split the time that the data
covers in blocks considering the time horizon for the <i>label</i>
( <i>Which facilities will
fail an inspection in the following  month?</i>
in this scenario of <b>inspection prioritization<sup><a id="fnr.28" class="footref" href="#fn.28">28</a></sup></b>) . This time
horizon is calculated from a set of specific dates (<code>as_of_date</code> in
triage parlance) that divide the blocks in past (for training the
model) and future (for testing the model). The set of <code>as_of_dates</code> is
(<i>mainly</i>) calculated from the <i>label timespan</i> and the <i>update
frequency</i><sup><a id="fnr.29" class="footref" href="#fn.29">29</a></sup>. The <i>as of date</i> is not the <i>event date</i>. The <i>event date</i>
occurred  <i>when</i> the facility was inspected. The <i>as of date</i>
is when the planning of the future facilities to be inspected happens.
</p>

<p>
<code>triage</code> will create those <i>labels</i> using information about the <i>outcome</i> of
the event<sup><a id="fnr.30" class="footref" href="#fn.30">30</a></sup>, taking into account the temporal structure of the data.
In our example: if a facility is inspected
is the event, and whether it fails the inspection (outcome
<i>true</i>) or not (outcome <i>false</i>).
</p>

<p>
For a given entity on a given <i>as of date</i>, <code>triage</code>
asks whether there's an outcome in
the future time horizon. If so, <code>triage</code> will generate a
<i>label</i> for that specific entity on that <i>as of date</i>.
</p>

<p>
For this example,  the <i>label</i> will be if given an <i>as of date</i> (e.g. January first, 2014), the
facility will have a failed inspection in the following year.
</p>

<p>
The following example hopefully will clarify the difference between
<i>outcome</i> and <i>label</i>. We will focus on events (inspections) that happened
in the year of 2014.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    <span style="color: #92a65e;">date</span>,
    entity_id,
    <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> outcome
<span style="color: #8ac6f2;">from</span>
    semantic.events
<span style="color: #8ac6f2;">where</span>
    <span style="color: #95e454;">'[2014-01-01, 2015-01-01]'</span>::daterange @&gt; <span style="color: #92a65e;">date</span>
    <span style="color: #8ac6f2;">and</span>
    entity_id <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>219,362,859<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">asc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-left">outcome</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2014-01-14</td>
<td class="org-right">859</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-02-04</td>
<td class="org-right">219</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-02-24</td>
<td class="org-right">859</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">2014-03-05</td>
<td class="org-right">859</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-04-10</td>
<td class="org-right">362</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">2014-04-15</td>
<td class="org-right">219</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-04-18</td>
<td class="org-right">362</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-05-06</td>
<td class="org-right">859</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-08-28</td>
<td class="org-right">362</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-09-19</td>
<td class="org-right">219</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-09-30</td>
<td class="org-right">362</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">2014-10-10</td>
<td class="org-right">362</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">2014-10-31</td>
<td class="org-right">859</td>
<td class="org-left">f</td>
</tr>
</tbody>
</table>

<p>
We can observe that the facilities had several inspections, but in
that timeframe <code>362</code> y <code>859</code> had failed inspections.
</p>

<p>
Continuing the narrative, from the perspective
of the day of <code>2014-01-01</code> (<i>as of date</i>), those facilities will have
positive <i>label</i>.
</p>

<p>
We can express that in a query and getting the <i>labels</i> for that
<i>as of date</i> :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    <span style="color: #95e454;">'2014-01-01'</span> <span style="color: #8ac6f2;">as</span> as_of_date,
    entity_id,
    bool_or<span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span><span style="color: #8c8c8c;">)</span>::<span style="color: #92a65e;">integer</span> <span style="color: #8ac6f2;">as</span> label
<span style="color: #8ac6f2;">from</span>
    semantic.events
<span style="color: #8ac6f2;">where</span>
    <span style="color: #95e454;">'2014-01-01'</span>::<span style="color: #92a65e;">timestamp</span> &lt;= <span style="color: #92a65e;">date</span>
    <span style="color: #8ac6f2;">and</span> <span style="color: #92a65e;">date</span> &lt; <span style="color: #95e454;">'2014-01-01'</span>::<span style="color: #92a65e;">timestamp</span> + <span style="color: #92a65e;">interval</span> <span style="color: #95e454;">'1 year'</span>
    <span style="color: #8ac6f2;">and</span> entity_id <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>219,362,859<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    entity_id;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">as<sub>of</sub><sub>date</sub></th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-right">label</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2014-01-01</td>
<td class="org-right">219</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">2014-01-01</td>
<td class="org-right">362</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2014-01-01</td>
<td class="org-right">859</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<p>
Note that ee transform the <i>label</i> to integer, since the machine learning
algorithms only work with numeric data.
</p>


<p>
We also need a way to store the <i>state</i> of each entity. We can group
entities in <i>cohorts</i> defined by the state. The <i>cohort</i>  can be used to decide
which facilities you want to predict on (i.e. include in the ML
train/test matrices). The rationale of this comes
from the need to only predict for entities in a particular state:
<i>Is the restaurant new?</i>
<i>Is this facility on this zip code</i>? <i>Is the facility "active"?</i><sup><a id="fnr.31" class="footref" href="#fn.31">31</a></sup>
</p>

<p>
We will consider a facility as <b>active</b> if a given <i>as of date</i>  is in the
interval defined by the <code>start_date</code> and <code>end_date</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    <span style="color: #95e454;">'2018-01-01'</span>::<span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">as</span> as_of_date,
    entity_id,
    activity_period,
<span style="color: #8ac6f2;">case</span> <span style="color: #8ac6f2;">when</span>
activity_period @&gt; <span style="color: #95e454;">'2018-01-01'</span>::<span style="color: #92a65e;">date</span> <span style="color: #99968b;">-- 2018-01-01 is as of date</span>
<span style="color: #8ac6f2;">then</span> <span style="color: #95e454;">'active'</span>::text
<span style="color: #8ac6f2;">else</span> <span style="color: #95e454;">'inactive'</span>::text
<span style="color: #8ac6f2;">end</span> <span style="color: #8ac6f2;">as</span> <span style="color: #8ac6f2;">state</span>
<span style="color: #8ac6f2;">from</span>
    semantic.entities
<span style="color: #8ac6f2;">where</span>
    entity_id <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>219,362,859<span style="color: #8c8c8c;">)</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">as<sub>of</sub><sub>date</sub></th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-left">activity<sub>period</sub></th>
<th scope="col" class="org-left">state</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2018-01-01</td>
<td class="org-right">219</td>
<td class="org-left">[2010-01-08,)</td>
<td class="org-left">active</td>
</tr>

<tr>
<td class="org-right">2018-01-01</td>
<td class="org-right">362</td>
<td class="org-left">[2010-01-12,2017-11-09)</td>
<td class="org-left">inactive</td>
</tr>

<tr>
<td class="org-right">2018-01-01</td>
<td class="org-right">859</td>
<td class="org-left">[2010-01-26,)</td>
<td class="org-left">active</td>
</tr>
</tbody>
</table>

<p>
<code>Triage</code> will use a simple modification of the queries that we just
discussed for automate the generation of the <i>cohorts</i> and <i>labels</i> for
our experiment.
</p>
</div>
</div>
</div>

<div id="outline-container-org812bb39" class="outline-3">
<h3 id="org812bb39"><span class="section-number-3">4.3</span> Experiment configuration file</h3>
<div class="outline-text-3" id="text-4-3">
<p>
The <i>experiment configuration file</i> is used to create the <code>experiment</code>
object. Here, you will specify the temporal configuration, the
features to be generated, the labels to learn, and the models that you
want to train in your data.
</p>

<p>
The configuration file is a <code>yaml</code> file with the following main sections:
</p>

<dl class="org-dl">
<dt><a href="#orgf73e332"><code>temporal_config</code></a></dt><dd>Temporal specification of the data, used for
creating the blocks for temporal crossvalidation.</dd>

<dt><code>cohort_config</code></dt><dd>Using the state of the entities, define (using <code>sql</code>)
<i>cohorts</i> to filter out objects that shouldn't be included in the training and
prediction stages. This will generate a table call
<code>cohort_{experiment_hash}</code></dd>

<dt><code>label_config</code></dt><dd>Specify (using <code>sql</code>)how to generate <i>labels</i> from the event's
<i>outcome</i>. A table named <code>labels_{experiment_hash}</code>
will be created.</dd>

<dt><a href="#orgefda1e3"><code>feature_aggregation</code></a></dt><dd>Which spatio-temporal aggregations of the
columns in the data set do you want to generate as features for
the models?</dd>

<dt><code>model_group_keys</code></dt><dd>How do you want to identify the <code>model_group</code> in
the database (so you can run analysis on them)?</dd>

<dt><a href="#org4168d0b"><code>grid_config</code></a></dt><dd>Which combination of hyperparameters and algorithms
will be trained and evaluated in the data set?</dd>

<dt><code>scoring</code></dt><dd>Which metrics will be calculated?</dd>
</dl>

<p>
Two of the more important (and potentially confusing) sections are
<code>temporal_config</code> and <code>feature_generation</code>. We will explain them in
detail in the next sections.
</p>
</div>
</div>

<div id="outline-container-orgf73e332" class="outline-3">
<h3 id="orgf73e332"><span class="section-number-3">4.4</span> Temporal crossvalidation</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Cross validation is a common technique to select a model that generalizes
 well to new data. Standard cross validation randomly
 splits the training data into subsets, fits models on all but one,
 and calculates the metric of interest (e.g. precision/recall) on the
 one left out, rotating through the subsets and leaving each out
 once. You select the model that performed best across the left-out sets,
 and then retrain it on the complete training data.
</p>

<p>
Unfortunately, standard cross validation is inappropriate for most
real-world data science problems. If your data have temporal
correlations, standard cross validation lets the model peek into
the future, training on some future observations and testing on past
observations. To avoid this problem, you should design your
training and testing to mimic how your model will be used, making
predictions only using the data that would be available at that time (i.e. from the past).
</p>

<p>
In temporal crossvalidation, rather than randomly splitting the
dataset into training and test splits, temporal cross validation
splits the data by time.
</p>

<p>
<code>triage</code> uses the <code>timechop</code> library for this purpose. <code>Timechop</code>
will "chop" the data set in several temporal blocks. These
blocks are then used for creating the features and matrices for
training and evaluation of the machine learning models.
</p>

<p>
Assume we want to
select which restaurant (of two in our example dataset) we should inspect next
year based on its higher risk of violating some condition. Also assume
that the process of picking which facility is repeated every year on
January 1st<sup><a id="fnr.32" class="footref" href="#fn.32">32</a></sup>
</p>

<p>
Following the problem description template given in Section
<b>Description of the problem to solve</b>, the question that we'll attempt to answer is:
</p>

<pre class="example">
  Which facility ($n=1$) is likely to violate some
  inspected condition in the following year ($X=1$)?
</pre>

<p>
The traditional approach in machine learning is splitting the data in
training and test datasets. Train or fit the algorithm on the training
data set to generate a train model  and test or evaluate the model on
the test data set. We will do the same here, but, with the help of
<code>timechop</code> we will take in account the time:
</p>

<p>
We will fit models on training
set up to 2014-01-01 and see how well those models would have
predicted 2015; fit more models on
training set up to 2015-01-01 and see how  well those models would have
predicted 2016; and so on. That way, we choose models that have
historically performed best at our task, forecasting. It’s why this
approach is sometimes called <i>evaluation on a rolling forecast
origin</i> because the origin at which the prediction is made rolls
forward in time. <sup><a id="fnr.33" class="footref" href="#fn.33">33</a></sup>
</p>


<div id="org690bd6a" class="figure">
<p><img src="./images/rolling-origin.png" alt="rolling-origin.png" width="600" height="800" />
</p>
<p><span class="figure-number">Figure 2: </span>Cartoonish view of temporal splitting for Machine Learning, each point represents an <i>as of date</i>, the orange area are the past of that <i>as of date</i> and is used for feature generation. The blue area is the label span, it lies in the future of the <i>as of date</i>.</p>
</div>


<p>
The data at which the model will do the predictions is denominated as
<i>as of date</i> in <code>triage</code> (<i>as of date</i> = January first in our
example). The length of the prediction time window (1 year) is called
<i>label span</i>. Training and predicting with a new model <i>as of date</i> (every year) is the <i>model update frequency</i>.
</p>

<p>
Because it's inefficient to calculate by hand all the <i>as-of dates</i> or
prediction points, <code>timechop</code> will take care of that for us.
To do so, we need to specify some more constraints besides the <i>label
span</i> and the <i>model update frequency</i>:
</p>

<ul class="org-ul">
<li>What is the date range covered by our data?</li>
<li>What is the date range in which we have information about labels?</li>
<li>How frequently do you receive information about your entities?</li>
<li>How far in the future you want to predict?</li>
<li>How much of the past data do you want to use?</li>
</ul>

<p>
With this information, <code>timechop</code> will calculate as-of train and test
dates from the last date in which you have label data, using the label span in both
test and train sets, plus the constraints just mentioned.
</p>

<p>
In total <code>timechop</code> uses 11 configuration parameters<sup><a id="fnr.34" class="footref" href="#fn.34">34</a></sup>.
</p>

<ul class="org-ul">
<li>There are parameters related to the boundaries of the available data set:

<dl class="org-dl">
<dt><code>feature_start_time</code></dt><dd>data aggregated into features begins at
this point (earliest date included in features)</dd>
<dt><code>feature_end_time</code></dt><dd>data aggregated into features is from
before this point (latest date included in features)</dd>
<dt><code>label_start_time</code></dt><dd>data aggregated into labels begins at this
point (earliest event date included in any label (event date &gt;= label<sub>start</sub><sub>time</sub>)</dd>
<dt><code>label_end_time</code></dt><dd>data aggregated is from before this point (event
date &lt; label<sub>end</sub><sub>time</sub> to be included in any label)</dd>
</dl></li>

<li><p>
Parameters that control the <i>labels</i>' time horizon on the train and test sets:
</p>

<dl class="org-dl">
<dt><code>training_label_timespans</code></dt><dd>how much time is covered by
training labels (e.g., outcomes in the next 3 days? 2
months? 1 year?) (training prediction span)</dd>

<dt><code>test_label_timespans</code></dt><dd>how much time is covered by test
prediction (e.g., outcomes in the next 3 days? 2 months? 1
year?) (test prediction span)</dd>
</dl>

<p>
These parameters will be used with the <i>outcomes</i> table
to generate the <i>labels</i>. In an <b>early warning</b> setting, they will often
have the same value. For <b>inspections prioritization</b>, this value typically
equals <code>test_durations</code> and <code>model_update_frequency</code>.
</p></li>

<li><p>
Parameters related about how much data we want to use, both in the
future and in the past relative to the <i>as-of date</i>:
</p>

<dl class="org-dl">
<dt><code>test_durations</code></dt><dd><p>
how far into the future should a model be used
to make predictions (test span)
</p>

<p>
<b>NOTE</b>: in the typical case of wanting a single prediction set
immediately after model training, this should be set to 0 days
</p></dd>
</dl>

<p>
For early warning problems, <code>test_durations</code> should equal
<code>model_update_frequency</code>. For inspection prioritization, organizational
process determines the value: <i>how far out are you scheduling for?</i>
</p>

<p>
The equivalent of <code>test_durations</code> for the training matrices is <code>max_training_histories</code>:
</p>

<dl class="org-dl">
<dt><code>max_training_histories</code></dt><dd>the maximum amount of history for each
entity to train on (early matrices may contain less than this
time if it goes past label/feature start times). If patterns have
changed significantly, models trained on recent data may outperform
models trained on a much lengthier history.</dd>
</dl></li>

<li>Finally, we should specify how many rows per <code>entity_id</code> in the train
and test matrix:

<dl class="org-dl">
<dt><code>training_as_of_date_frequencies</code></dt><dd>how much time between rows
for a single entity in a training matrix (list time between
rows for same entity in train matrix).</dd>

<dt><code>test_as_of_date_frequencies</code></dt><dd>how much time between rows for a
single entity in a test matrix (time between rows for same
entity in test matrix).</dd>
</dl></li>
</ul>

<p>
The following images (we will show how to generate them later)
shows the time blocks created by several temporal configurations. We
will change a parameter at a time so you could see how it
affects the resulting blocks.
</p>

<p>
If you want to try the modifications (or your own) and generate the
temporal blocks images run the following (they'll be generated in <a href="../triage/images/">../triage/images/</a>):
</p>

<pre class="example">
# Remember to run this in bastion NOT in laptop's shell!
triage showtimechops experiment_config/simple_test_skeleton.yaml
</pre>
</div>

<ol class="org-ol">
<li><a id="org338a9a5"></a><code>{feature, label}_{end, start}_time</code><br />
<div class="outline-text-5" id="text-4-4-0-1">
<p>
The image below shows these <code>{feature, label}_start_time</code> are equal, as
are the <code>{feature, label}_end_time</code>. These parameters
show in the image as dashed vertical black lines. This setup will be
our <b>baseline</b> example.
</p>

<p>
The plot is divided in two horizontal lines ("Block 0" and "Block
1"). Each line is divided by vertical dashed lines &#x2013; the grey lines
outline the boundaries of the data for features and data for labels, which in
this image coincide. The black dash lines represent the
beginning and the end of the test set. In  "Block 0" those lines
correspond to <code>2017</code> and <code>2018</code>, and in "Block 1" they correspond
to <code>2016</code> and <code>2017</code>.
</p>


<div id="orgb3e539a" class="figure">
<p><img src="./images/timechop_1.png" alt="timechop_1.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 3: </span>feature and label start, end time equal</p>
</div>


<p>
The shaded areas (in this image there is just one per block, but you
will see other examples below) represents the span of the <i>as of dates</i>.
They start with the oldest <i>as of date</i> and end with the latest. Each
line inside that area represents the label span.
Those lines begin at the <i>as of date</i>. At each <i>as of date</i>, timechop
generates each entity's features (from the past) and labels (from the
future). So in the image, we will have
two sets of train/test datasets. Each facility will have 13 rows in "Block 0"
and 12 rows in "Block 1". The trained models will
predict the label using the features calculated for that test set <i>as of date</i>.
The single line represents the label's time horizon in testing.
</p>

<p>
This is the temporal configuration that generated the previous image:
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '1y'
</pre>

<p>
In that configuration the date ranges of features and labels are equal,
 but they can be different (maybe you have more data for features that
data for labels) as is shown in the following image and in their
 configuration parameters.
</p>


<div id="orgd03870b" class="figure">
<p><img src="./images/timechop_2.png" alt="timechop_2.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 4: </span>feature<sub>start</sub><sub>time</sub> different different that label<sub>start</sub><sub>time</sub>.</p>
</div>


<pre class="example">
temporal_config:
    feature_start_time: '2010-01-01'   # &lt;------- The change happened here!
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '1y'
</pre>
</div>
</li>

<li><a id="org0c259e1"></a><code>model_update_frequency</code><br />
<div class="outline-text-5" id="text-4-4-0-2">
<p>
From our <b>baseline</b> <code>temporal_config</code> example (<a href="#orgb3e539a">3</a>), we will
change how often we want a new model, which generates
more time blocks (if there are time-constrained data, obviously).
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '6month' # &lt;------- The change happened here!
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '1y'
</pre>


<div id="org1933637" class="figure">
<p><img src="./images/timechop_3.png" alt="timechop_3.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 5: </span>A smaller model<sub>update</sub><sub>frequency</sub> (from 1y to 6month) (The number of blocks grew)</p>
</div>
</div>
</li>


<li><a id="org8885086"></a><code>max_training_histories</code><br />
<div class="outline-text-5" id="text-4-4-0-3">
<p>
With this parameter you could get a <i>growing window</i> for training
(depicted in <a href="#orgfc03b32">6</a>) or as in all the other examples,
<i>fixed training windows</i>.
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'  # &lt;------- The change happened here!
</pre>



<div id="orgfc03b32" class="figure">
<p><img src="./images/timechop_4.png" alt="timechop_4.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 6: </span>The size of the block is bigger now</p>
</div>
</div>
</li>

<li><a id="org755dcef"></a><code>_as_of_date_frequencies</code> and <code>test_durations</code><br />
<div class="outline-text-5" id="text-4-4-0-4">
<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '3month' # &lt;------- The change happened here!

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'
</pre>



<div id="org6cf8630" class="figure">
<p><img src="./images/timechop_5.png" alt="timechop_5.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 7: </span>More rows per entity in the training block</p>
</div>

<p>
Now, change <code>test_as_of_date_frequencies</code>:
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '3month'&lt;------- The change happened here!

    max_training_histories: '10y'
</pre>



<div id="org814c932" class="figure">
<p><img src="./images/timechop_6.png" alt="timechop_6.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 8: </span>We should get more rows per entity in the test matrix, but that didn't happen. Why?</p>
</div>

<p>
Nothing changed because the test set doesn't have
"space" to allow more spans. The "space" is controlled by <code>test_durations</code>,
so let's change it to <code>6month</code>:
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '6month' &lt;------- The change happened here!
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'
</pre>



<div id="orgc9517d7" class="figure">
<p><img src="./images/timechop_7.png" alt="timechop_7.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 9: </span>The test duration is bigger now, so we got 6 rows (since the "base" frequency is 1 month)</p>
</div>

<p>
So, now we will move both parameters: <code>test_durations</code>, <code>test_as_of_date_frequencies</code>
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '6month' &lt;------- The change happened here!
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '3month' &lt;------- and also here!

    max_training_histories: '10y'
</pre>



<div id="orgcb10a2a" class="figure">
<p><img src="./images/timechop_8.png" alt="timechop_8.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 10: </span>With more room in testing, now test<sub>as</sub><sub>of</sub><sub>date</sub><sub>frequencies</sub> has some effect.</p>
</div>
</div>
</li>

<li><a id="org9472343"></a><code>_label_timespans</code><br />
<div class="outline-text-5" id="text-4-4-0-5">
<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['3month']  &lt;------- The change happened here!
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'
</pre>



<div id="org7573615" class="figure">
<p><img src="./images/timechop_9.png" alt="timechop_9.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 11: </span>The label time horizon in the test dataset now is smaller</p>
</div>


<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y'
    training_label_timespans: ['3month'] &lt;------- The change happened here!
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y']
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'
</pre>



<div id="org03525d9" class="figure">
<p><img src="./images/timechop_10.png" alt="timechop_10.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 12: </span>The label time horizon is smaller in the trainning dataset. One effect is that now we have more room for more rows per entity.</p>
</div>

<p>
That's it! Now you have the power to bend time!<sup><a id="fnr.35" class="footref" href="#fn.35">35</a></sup>
</p>

<p>
With the time blocks defined, <code>triage</code> will create the <i>labels</i> and
then the features for our train and test sets. We will
discuss <i>features</i> in the following section.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgefda1e3" class="outline-3">
<h3 id="orgefda1e3"><span class="section-number-3">4.5</span> Feature engineering</h3>
<div class="outline-text-3" id="text-4-5">
<p>
We will show how to create features using the <i>experiments config
file</i>. <code>triage</code> uses <code>collate</code> for this.<sup><a id="fnr.36" class="footref" href="#fn.36">36</a></sup> The <code>collate</code>
library controls the generation of features (including the imputation rules
for each feature generated) using the time blocks generated by
<code>timechop</code>. <code>Collate</code> helps the modeler create features based on
<i>spatio-temporal aggregations</i> into the <i>as of date</i>. <code>Collate</code> generates
<code>SQL</code> queries that will create <i>features</i> per each <i>as of date</i>.
</p>

<p>
As before, we will try to mimic what <code>triage</code> does behind the
scenario. <code>Collate</code> will help you to create features based on the
following template:
</p>

<blockquote>
<p>
For a given <i>as of date</i>, how the <i>aggregation function</i> operates
into a column taking into account a previous <i>time interval</i> and
some <i>attributes</i>.
</p>
</blockquote>

<p>
Two possible features could be framed as:
</p>

<pre class="example">
As of 2016-01-01, how many inspections
has each facility had in the previous 6 months?
</pre>

<p>
and
</p>

<pre class="example">
As of 2016-01-01, how many "high risk" findings has the
facility had in the previous 6 months?
</pre>

<p>
In our data, that date range (between 2016-01-01 and 2015-07-01) looks like:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    event_id,
    <span style="color: #92a65e;">date</span>,
    entity_id,
    risk
<span style="color: #8ac6f2;">from</span>
    semantic.events
<span style="color: #8ac6f2;">where</span>
    <span style="color: #92a65e;">date</span> &lt;@ daterange<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span><span style="color: #95e454;">'2016-01-01'</span>::<span style="color: #92a65e;">date</span> - <span style="color: #92a65e;">interval</span> <span style="color: #95e454;">'6 months'</span><span style="color: #93a8c6;">)</span>::<span style="color: #92a65e;">date</span>, <span style="color: #95e454;">'2016-01-01'</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">and</span> entity_id <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>219,362,859<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">asc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">event<sub>id</sub></th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-left">risk</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1561324</td>
<td class="org-right">2015-07-17</td>
<td class="org-right">859</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1561517</td>
<td class="org-right">2015-07-24</td>
<td class="org-right">859</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1562122</td>
<td class="org-right">2015-08-12</td>
<td class="org-right">859</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1547403</td>
<td class="org-right">2015-08-20</td>
<td class="org-right">219</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1547420</td>
<td class="org-right">2015-08-28</td>
<td class="org-right">219</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1547448</td>
<td class="org-right">2015-09-14</td>
<td class="org-right">362</td>
<td class="org-left">medium</td>
</tr>

<tr>
<td class="org-right">1547462</td>
<td class="org-right">2015-09-21</td>
<td class="org-right">362</td>
<td class="org-left">medium</td>
</tr>

<tr>
<td class="org-right">1547504</td>
<td class="org-right">2015-10-09</td>
<td class="org-right">362</td>
<td class="org-left">medium</td>
</tr>

<tr>
<td class="org-right">1547515</td>
<td class="org-right">2015-10-16</td>
<td class="org-right">362</td>
<td class="org-left">medium</td>
</tr>

<tr>
<td class="org-right">1583249</td>
<td class="org-right">2015-10-21</td>
<td class="org-right">859</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1583577</td>
<td class="org-right">2015-10-28</td>
<td class="org-right">859</td>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-right">1583932</td>
<td class="org-right">2015-11-04</td>
<td class="org-right">859</td>
<td class="org-left">high</td>
</tr>
</tbody>
</table>

<p>
We can transform those data to two features: <code>number_of_inspections</code>
and <code>flagged_as_high_risk</code>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    entity_id,
    <span style="color: #95e454;">'2016-01-01'</span> <span style="color: #8ac6f2;">as</span> as_of_date,
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>event_id<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> inspections,
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>event_id<span style="color: #8c8c8c;">)</span> filter <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">where</span> risk=<span style="color: #95e454;">'high'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> flagged_as_high_risk
<span style="color: #8ac6f2;">from</span>
    semantic.events
<span style="color: #8ac6f2;">where</span>
    <span style="color: #92a65e;">date</span> &lt;@ daterange<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span><span style="color: #95e454;">'2016-01-01'</span>::<span style="color: #92a65e;">date</span> - <span style="color: #92a65e;">interval</span> <span style="color: #95e454;">'6 months'</span><span style="color: #93a8c6;">)</span>::<span style="color: #92a65e;">date</span>, <span style="color: #95e454;">'2016-01-01'</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">and</span> entity_id <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>219,362,859<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #8ac6f2;">grouping</span> <span style="color: #8ac6f2;">sets</span><span style="color: #8c8c8c;">(</span>entity_id<span style="color: #8c8c8c;">)</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-right">as<sub>of</sub><sub>date</sub></th>
<th scope="col" class="org-right">inspections</th>
<th scope="col" class="org-right">flagged<sub>as</sub><sub>high</sub><sub>risk</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">219</td>
<td class="org-right">2016-01-01</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">362</td>
<td class="org-right">2016-01-01</td>
<td class="org-right">4</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">859</td>
<td class="org-right">2016-01-01</td>
<td class="org-right">6</td>
<td class="org-right">6</td>
</tr>
</tbody>
</table>

<p>
This query is making an <i>aggregation</i>. Note that the previous <code>SQL</code>
query has five parts:
</p>
<ul class="org-ul">
<li>The <i>filter</i> ((<code>risk = 'high')::int</code>)</li>
<li>The <i>aggregation function</i> (<code>count()</code>)</li>
<li>The <i>name</i> of the resulting transformation (<code>flagged_as_high_risk</code>)</li>
<li>The <i>context</i> in which it is aggregated (by <code>entity_id</code>)</li>
<li>The <i>date range</i> (between 2016-01-01 and 6 months before)</li>
</ul>

<p>
What about if we want to add proportions and totals of failed and
passed inspections?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    entity_id,
    <span style="color: #95e454;">'2016-01-01'</span> <span style="color: #8ac6f2;">as</span> as_of_date,
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>event_id<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> inspections,
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>event_id<span style="color: #8c8c8c;">)</span> filter <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">where</span> risk=<span style="color: #95e454;">'high'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> flagged_as_high_risk,
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>event_id<span style="color: #8c8c8c;">)</span> filter <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">where</span> <span style="color: #8ac6f2;">result</span>=<span style="color: #95e454;">'pass'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> passed_inspections,
    round<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">avg</span><span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span><span style="color: #8ac6f2;">result</span>=<span style="color: #95e454;">'pass'</span><span style="color: #b0b1a3;">)</span>::<span style="color: #92a65e;">int</span><span style="color: #93a8c6;">)</span>, 2<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> proportion_of_passed_inspections,
    <span style="color: #e5786d;">count</span><span style="color: #8c8c8c;">(</span>event_id<span style="color: #8c8c8c;">)</span> filter <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">where</span> <span style="color: #8ac6f2;">result</span>=<span style="color: #95e454;">'fail'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> failed_inspections,
    round<span style="color: #8c8c8c;">(</span><span style="color: #e5786d;">avg</span><span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span><span style="color: #8ac6f2;">result</span>=<span style="color: #95e454;">'fail'</span><span style="color: #b0b1a3;">)</span>::<span style="color: #92a65e;">int</span><span style="color: #93a8c6;">)</span>, 2<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> proportion_of_failed_inspections
<span style="color: #8ac6f2;">from</span>
    semantic.events
<span style="color: #8ac6f2;">where</span>
    <span style="color: #92a65e;">date</span> &lt;@ daterange<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span><span style="color: #95e454;">'2016-01-01'</span>::<span style="color: #92a65e;">date</span> - <span style="color: #92a65e;">interval</span> <span style="color: #95e454;">'6 months'</span><span style="color: #93a8c6;">)</span>::<span style="color: #92a65e;">date</span>, <span style="color: #95e454;">'2016-01-01'</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">and</span> entity_id <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>219,362,859<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #8ac6f2;">grouping</span> <span style="color: #8ac6f2;">sets</span><span style="color: #8c8c8c;">(</span>entity_id<span style="color: #8c8c8c;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-right">as<sub>of</sub><sub>date</sub></th>
<th scope="col" class="org-right">inspections</th>
<th scope="col" class="org-right">flagged<sub>as</sub><sub>high</sub><sub>risk</sub></th>
<th scope="col" class="org-right">passed<sub>inspections</sub></th>
<th scope="col" class="org-right">proportion<sub>of</sub><sub>passed</sub><sub>inspections</sub></th>
<th scope="col" class="org-right">failed<sub>inspections</sub></th>
<th scope="col" class="org-right">proportion<sub>of</sub><sub>failed</sub><sub>inspections</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">219</td>
<td class="org-right">2016-01-01</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">0.50</td>
<td class="org-right">1</td>
<td class="org-right">0.50</td>
</tr>

<tr>
<td class="org-right">362</td>
<td class="org-right">2016-01-01</td>
<td class="org-right">4</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0.25</td>
<td class="org-right">2</td>
<td class="org-right">0.50</td>
</tr>

<tr>
<td class="org-right">859</td>
<td class="org-right">2016-01-01</td>
<td class="org-right">6</td>
<td class="org-right">6</td>
<td class="org-right">4</td>
<td class="org-right">0.67</td>
<td class="org-right">2</td>
<td class="org-right">0.33</td>
</tr>
</tbody>
</table>

<p>
But what if we want to also add features for "medium" and "low" risk?
And what would the query look like if we want to use several time intervals, like
<i>3 months</i>, <i>5 years</i>, etc? What if we want to contextualize this by
location? Plus we need to calculate all these
features for several <i>as of dates</i> and manage the imputation strategy for all of
them!!!
</p>

<p>
You will realize that even with this simple set of features we
will require very complex <code>SQL</code> to be constructed.
</p>

<p>
But fear not. <code>triage</code> will automate that for us!
</p>

<p>
The following blocks of code represent a snippet of <code>triage</code>'s
configuration file related to feature aggregation. It shows the
<code>triage</code> syntax for the <code>inspections</code> feature constructed above:
</p>

<pre class="example">
feature_aggregations:
  -
    prefix: 'inspections'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    aggregates:
      -
        quantity:
          total: "*"
        imputation:   # This is optional and overrides the aggregates_imputation section above!
           count:
              type: 'zero_noflag'
        metrics:
          - 'count'

    intervals: ['6month']

    groups:
        - 'entity_id'
</pre>


<p>
<code>feature_aggregations</code> is a <code>yaml</code> list<sup><a id="fnr.37" class="footref" href="#fn.37">37</a></sup> of <i>feature groups construction
specification</i> or just <i>feature group</i>. A <i>feature group</i> is a way of grouping several features
that share <code>intervals</code> and <code>groups</code>. <code>triage</code> requires the
following configuration parameter for every <i>feature group</i>:
</p>

<dl class="org-dl">
<dt><code>prefix</code></dt><dd>This will be used for name of the <i>feature</i> created</dd>
<dt><code>from_obj</code></dt><dd>Represents a <code>TABLE</code> object in <code>PostgreSQL</code>. You
can pass a <i>table</i> like in the example above
(<code>semantic.events</code>) or a <code>SQL</code> query that returns a
table. We will see an example of this later.
<code>triage</code> will use it like the
<code>FROM</code> clause in the <code>SQL</code> query.</dd>
<dt><code>knowlege_date_column</code></dt><dd>Column that indicates the date of the event.</dd>
<dt><code>intervals</code></dt><dd>A <code>yaml</code> list. <code>triage</code> will create one feature per
interval listed.</dd>
<dt><code>groups</code></dt><dd>A <code>yaml</code> list of the attributes that we will use to
aggregate. This will be translated to a <code>SQL</code> <code>GROUP
              BY</code> by <code>triage</code>.</dd>
</dl>


<p>
The last section to discuss is <code>imputation</code>. Imputation is very
important step in the modeling, and you should carefully think about
how you will impute the missing values in the feature. After deciding
the best way of impute <i>each</i> feature, you should avoid leakage (For
example, imagine that you want to impute with the <b>mean</b> one
feature. You could have leakage if you take all the values of the
column, including ones of the future to calculate the imputation). We
will return to this later in this tutorial.
</p>


<p>
<code>Collate</code> is in charge of creating the <code>SQL</code> agregation queries. Another
way of thinking about it is that <code>collate</code> encapsulates the <code>FROM</code>
part of the query (<code>from_obj</code>) as well as the <code>GROUP BY</code> columns (<code>groups</code>).
</p>

<p>
<code>triage</code> (<code>collate</code>) supports two types of objects to be aggregated:
<code>aggregates</code> and <code>categoricals</code> (more on this one later)<sup><a id="fnr.38" class="footref" href="#fn.38">38</a></sup>. The
<code>aggregates</code> subsection represents a <code>yaml</code> list of <i>features</i> to be
created. Each element on this represents a column (<code>quantity</code>, in the
example, the whole row <code>*</code>) and an alias (<code>total</code>), defines the
<code>imputation</code> strategy for <code>NULLs</code>,  and the <code>metric</code> refers to the
<code>aggregation function</code> to be applied to the <code>quantity</code> (<code>count</code>).
</p>

<p>
<code>triage</code> will generate the following (or a very similar one), one per
each combination of <code>interval</code> &times; <code>groups</code> &times; <code>quantity</code>:
</p>

<pre class="example">
select
  metric(quantity) as alias
from
  from_obj
where
  as_of_date &lt;@ (as_of_date - interval, as_of_date)
group by
  groups
</pre>

<p>
With the previous configuration <code>triage</code> will generate <b>1</b> feature
with the following name:<sup><a id="fnr.39" class="footref" href="#fn.39">39</a></sup>
</p>

<ul class="org-ul">
<li><code>inspections_entity_id_6month_total_count</code></li>
</ul>

<p>
All the features of that <i>feature group</i> (in this case only 1) will be
stored in the table.
</p>

<ul class="org-ul">
<li><code>features.inspections_aggregation_imputed</code></li>
</ul>

<p>
In general the names of the generated tables are constructed as follows:
</p>

<pre class="example">
schema.prefix_group_aggregation_imputed
</pre>

<p>
<b>NOTE</b>: the outputs are stored in the <code>features</code> schema.
</p>

<p>
Inside each of those new tables, the feature name will follow this
pattern:
</p>

<pre class="example">
prefix_group_interval_alias_aggregation_operation
</pre>

<p>
If we complicate a little the above configuration adding new
intervals:
</p>

<pre class="example">
feature_aggregations:
  -
    prefix: 'inspections'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    aggregates:
      - # number of inspections
        quantity:
          total: "*"

        imputation:
          count:
            type: 'zero_noflag'

        metrics: ['count']

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
        - 'entity_id'
</pre>

<p>
You will end with 5 new <i>features</i>, one for each interval (5) &times; the only
aggregate definition we have. Note the weird <code>all</code> in the
<code>intervals</code> definition. <code>all</code> is the time interval
between the <code>feature_start_time</code> and the <code>as_of_date</code>.
</p>

<p>
<code>triage</code> also supports <code>categorical</code> objects. The following
code adds a <i>feature</i> for the <code>risk</code> flag.
</p>

<pre class="example">
feature_aggregations:
  -
    prefix: 'inspections'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    aggregates:
      - # number of inspections
        quantity:
          total: "*"

        imputation:
          count:
            type: 'zero_noflag'

        metrics: ['count']

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
        - 'entity_id'
  -
    prefix: 'risks'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    categoricals_imputation:
      sum:
        type: 'zero'

    categoricals:
      -
        column: 'risk'
        choice_query: 'select distinct risk from semantic.events'
          metrics:
            - 'sum'

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
      - 'entity_id'

</pre>

<p>
There are several changes. First, the imputation strategy in this new
<i>feature group</i> is for every categorical features in that feature group
(in that example only one). The next change is the type: instead of
<code>aggregates</code>, it's <code>categoricals</code>. <code>categoricals</code> define a <code>yaml</code>
list too. Each <code>categorical</code> feature needs to define a <code>column</code> to be
aggregated and the query to get all the distinct values.
</p>

<p>
With this configuration, <code>triage</code> will generate two tables, one per
<i>feature group</i>. The new table will be
<code>features.risks_aggregation_imputed</code>. This table will have more columns:
<code>intervals</code> (5) &times; <code>groups</code> (1) &times; <code>metric</code> (1) &times; <i>features</i> (1) &times; <i>number of choices returned by the query</i>.
</p>

<p>
The query:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #8ac6f2;">distinct</span> risk <span style="color: #8ac6f2;">from</span> semantic.events;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">risk</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">¤</td>
</tr>

<tr>
<td class="org-left">medium</td>
</tr>

<tr>
<td class="org-left">high</td>
</tr>

<tr>
<td class="org-left">low</td>
</tr>
</tbody>
</table>

<p>
returns 4 possible values (including <code>NULL</code>).
When dealing with categorical aggregations you need to be
careful. Could be the case that in some period of time, in your data,
you don't have all the possible values of the categorical variable. This could
cause problems down the road. Triage allows you to specify the
possible values (<i>choices</i>) of the variable. Instead of using
<code>choice_query</code>, you could use <code>choices</code> as follows:
</p>

<pre class="example">
feature_aggregations:
  -
    prefix: 'inspections'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    aggregates:
      - # number of inspections
        quantity:
          total: "*"

        imputation:
          count:
            type: 'mean'

        metrics: ['count']

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
        - 'entity_id'
  -
    prefix: 'risks'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    categoricals_imputation:
      sum:
        type: 'zero'

    categoricals:
      -
        column: 'risk'
        choices: ['low', 'medium', 'high']
          metrics:
            - 'sum'

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
      - 'entity_id'

</pre>

<p>
In both cases <code>triage</code> will generate <code>20</code> new features, as expected.
</p>

<p>
The features generated from categorical objects will have the
following pattern:
</p>

<pre class="example">
prefix_group_interval_column_choice_aggregation_operation
</pre>

<p>
So, <code>risks_entity_id_1month_risk_medium_sum</code> will be among our new features in the last example.
</p>

<p>
As a next step, let's investigate the effect of having several
elements in the <code>groups</code> list.
</p>

<pre class="example">
feature_aggregations:
  -
    prefix: 'inspections'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    aggregates:
      - # number of inspections
        quantity:
          total: "*"

        imputation:
          count:
            type: 'mean'

        metrics: ['count']

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
        - 'entity_id'

  -
    prefix: 'risks'
    from_obj: 'semantic.events'
    knowledge_date_column: 'date'

    categoricals_imputation:
      sum:
        type: 'zero'

    categoricals:
      -
        column: 'risk'
        choices: ['low', 'medium', 'high']
          metrics:
            - 'sum'

    intervals: ['1month', '3month', '6month', '1y', 'all']

    groups:
      - 'entity_id'
      - 'zip_code'

</pre>

<p>
The number of features created in the table
<code>features.risks_aggregation_imputed</code> is now 60
(<code>intervals</code> (5) &times; <code>groups</code> (2) &times; <code>metric</code> (2) &times; <i>features</i> (1) &times;
<i>number of choices</i> (3).
</p>

<p>
<code>Triage</code> will add several imputation <i>flag</i> (binary) columns per feature. Those
columns convey information about if that particular value was <i>imputed</i>
or <i>not</i>. So in the last counting we need to add 20 more columns to a
grand total of 80 columns.
</p>
</div>

<div id="outline-container-org76e26af" class="outline-4">
<h4 id="org76e26af"><span class="section-number-4">4.5.1</span> Imputation</h4>
<div class="outline-text-4" id="text-4-5-1">
<p>
<code>Triage</code> currently supports the following imputation strategies:
</p>

<dl class="org-dl">
<dt>mean</dt><dd>The mean value of the feature.</dd>

<dt>constant</dt><dd>Fill with a constant (you need to provide the constant value).</dd>

<dt>zero</dt><dd>Same that the previous one, but the constant is zero.</dd>

<dt>zero<sub>noflag</sub></dt><dd>Sometimes, the absence (i.e. a NULL) doesn't mean that
the value is missing, that actually means that the
event didn't happen to that entity. For example a
<code>NULL</code> in the <code>inspections_entity_id_1month_total_count</code>
column in <code>features.inspections_aggreagtion_imputed</code>
doesn't mean that the value is missing, it means that
<i>zero</i> inspections happen to that facility in the last
month. Henceforth, the <i>flag</i> column is not needed.</dd>
</dl>

<p>
Only for aggregates:
</p>

<dl class="org-dl">
<dt>binary<sub>mode</sub></dt><dd>Takes the mode of a binary feature</dd>
</dl>

<p>
Only for categoricals::
</p>

<dl class="org-dl">
<dt>null<sub>category</sub></dt><dd>Just flag null values with the null category column</dd>
</dl>

<p>
and finally, if you are sure that is not possible to have <i>NULLS:</i>
</p>

<dl class="org-dl">
<dt>error</dt><dd>Raise an exception if ant null values are encountered.</dd>
</dl>
</div>
</div>

<div id="outline-container-org80d5a4b" class="outline-4">
<h4 id="org80d5a4b"><span class="section-number-4">4.5.2</span> Feature groups strategies</h4>
<div class="outline-text-4" id="text-4-5-2">
<p>
Another interesting thing that <code>triage</code> controls is how many feature
groups are used in the machine learning grid. This would help you to
understand the effect of using different groups in the final
performance of the models.
</p>

<p>
In <code>simple_test_skeleton.yaml</code> you will find the following blocks:
</p>

<pre class="example">
feature_group_definition:
  prefix:
    - 'results'
    - 'risks'
    - 'inspections'

feature_group_strategies: ['all']
</pre>

<p>
This configuration adds to the <i>number</i> of model groups to be created.
</p>

<p>
The possible feature group strategies are:
</p>

<dl class="org-dl">
<dt><code>all</code></dt><dd>All the features groups are used.</dd>
<dt><code>leave-one-out</code></dt><dd>All the combinations of: "All the feature groups
except one are used".</dd>
<dt><code>leave-one-in</code></dt><dd>All the combinations of "One feature group except
the rest is used"</dd>
<dt><code>all-combinations</code></dt><dd>All the combinations of <i>feature groups</i></dd>
</dl>

<p>
In order to clarify these concepts, let's use
<code>simple_test_skeleton.yaml</code> configuration file. In it there are three
feature groups: <code>inspections</code>, <code>results</code>, <code>risks</code>.
</p>

<p>
Using <code>all</code> will create just one set containg all the features of the
three feature groups:
</p>

<ul class="org-ul">
<li><code>{inspections, results, risks}</code></li>
</ul>

<p>
If you modify <code>feature_group_strategies</code> to <code>['leave-one-out']</code>: the
following sets will be created:
</p>

<ul class="org-ul">
<li><code>{inspections, results}, {inspections, risks}, {results, risks}</code></li>
</ul>

<p>
Using the <code>leave-one-in</code> strategy:
</p>

<ul class="org-ul">
<li><code>{inspections}, {results}, {risks}</code></li>
</ul>

<p>
Finally choosing <code>all-combinations</code>:
</p>

<ul class="org-ul">
<li><code>{inspections}, {results}, {risks}, {inspections, results}</code>,
<code>{inspections, risks}, {results, risks}, {inspections, results, risks}</code></li>
</ul>
</div>
</div>

<div id="outline-container-org2ae3d35" class="outline-4">
<h4 id="org2ae3d35"><span class="section-number-4">4.5.3</span> Controlling the size of the tables</h4>
<div class="outline-text-4" id="text-4-5-3">
<blockquote>
<p>
This section is a little technical, you can skip it if you fell like it.
</p>
</blockquote>

<p>
By default, <code>triage</code> will use the biggest column type for the features
table (<code>integer</code>, <code>numeric</code>, etc). This could lead to humongous  tables,
with sizes several hundred of gigabytes. <code>Triage</code> took that decision,
because it doesn't know anything about the possible values of your
data (e.g. Is it possible to have millions of inspections in one
month? or just a few dozens?).
</p>

<p>
If you are facing this difficulty, you can force <code>triage</code> to <i>cast</i> the
column in the <i>features</i> table. Just add <code>coltype</code> to the
<code>aggregate/categorical</code> block:
</p>

<div class="org-src-container">
<pre class="src src-yaml"> <span style="color: #cae682;">aggregates</span>:
   <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    quantity</span>:
      <span style="color: #cae682;">total</span>: <span style="color: #95e454;">"*"</span>
    <span style="color: #cae682;">metrics</span>: [<span style="color: #95e454;">'count'</span>]
    <span style="color: #cae682;">coltype</span>: <span style="color: #95e454;">'smallint'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4168d0b" class="outline-3">
<h3 id="org4168d0b"><span class="section-number-3">4.6</span> The Grid</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Before applying Machine Learning to your dataset you don't know which
combination of algorithm and hyperparameters will be the best given a
specific matrix.
</p>

<p>
<code>Triage</code> approaches this problem exploring a algorithm +
hyperparameters + feature groups grid. At this time, this exploration
is a exhaustive one, i.e. it covers the complete grid, so you would
get (number of algorithms) \(\times\) (number of hyperparameters) \(\times\) (number
of feature group strategies) models groups. The number of models
trained is (number of model groups)  \(\times\) (number of time splits).
</p>

<p>
In our simple experiment the grid is very simple:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">grid_config</span>:
    <span style="color: #95e454;">'sklearn.dummy.DummyClassifier'</span>:
        <span style="color: #cae682;">strategy</span>: [most_frequent]
</pre>
</div>

<p>
Just one algorithm and one hyperparameter (also we have only one
feature group strategy: <code>all</code>), and two time splits. So we will get 2
models, 1 model group.
</p>

<p>
Keep in mind that the grid is providing more than way to select a
model. You can use the tables generated by the grid (see next section,  <a href="#org7999158">Machine learning governance</a>)
and <i>analyze</i> and <i>understand</i> your data. In other words, analyzing the results
(evaluations, predictions, hyperparameter space, etc.) is like
applying <b>Data mining</b> concepts to your data using Machine learning. We
will return to this when we apply post modeling to our models.
</p>
</div>
</div>

<div id="outline-container-org7999158" class="outline-3">
<h3 id="org7999158"><span class="section-number-3">4.7</span> Machine learning governance</h3>
<div class="outline-text-3" id="text-4-7">
<p>
When <code>triage</code> executes the experiment, it creates a series of new schemas for
storing the copious output of the experiment. The schemas are
<code>test_results, train_results</code>, and <code>model_metadata</code>. These schemas
store the metadata of the trained models, features, parameters, and hyperparameters
used in their training. It also stores the predictions and evaluations
of the models on the test sets.
</p>

<p>
The schema <code>model_metadata</code> is composed by the tables:
</p>

<div class="org-src-container">
<pre class="src src-sql">\dt model_metadata.*
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of relations</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Schema</td>
<td class="org-left">Name</td>
<td class="org-left">Type</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">experiment<sub>matrices</sub></td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">experiment<sub>models</sub></td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">experiments</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">list<sub>predictions</sub></td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">matrices</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">model<sub>groups</sub></td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">model<sub>metadata</sub></td>
<td class="org-left">models</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>
</tbody>
</table>

<p>
The tables contained in <code>test_results</code> are:
</p>

<div class="org-src-container">
<pre class="src src-sql">\dt test_results.*
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of relations</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Schema</td>
<td class="org-left">Name</td>
<td class="org-left">Type</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">test<sub>results</sub></td>
<td class="org-left">evaluations</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">test<sub>results</sub></td>
<td class="org-left">individual<sub>importances</sub></td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">test<sub>results</sub></td>
<td class="org-left">predictions</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>
</tbody>
</table>

<p>
Lastly, if you have interest in how the model performed in the <i>training</i>
data sets you could consult <code>train_results</code>
</p>

<div class="org-src-container">
<pre class="src src-sql">\dt train_results.*
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of relations</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Schema</td>
<td class="org-left">Name</td>
<td class="org-left">Type</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">train<sub>results</sub></td>
<td class="org-left">evaluations</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">train<sub>results</sub></td>
<td class="org-left">feature<sub>importances</sub></td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">train<sub>results</sub></td>
<td class="org-left">predictions</td>
<td class="org-left">table</td>
<td class="org-left">food<sub>user</sub></td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-orgc7591fd" class="outline-4">
<h4 id="orgc7591fd"><span class="section-number-4">4.7.1</span> What are all the results tables about?</h4>
<div class="outline-text-4" id="text-4-7-1">
<p>
<code>model_groups</code> stores the algorithm (<code>model_type</code>), the
hyperparameters (<code>hyperparameters</code>), and the features shared by a
particular set of models. <code>models</code> contains data specific to a model:
the <code>model_group</code> (you can use <code>model_group_id</code> for linking the model to a
model group), temporal information (like <code>train_end_time</code>), and the train
matrix UUID (<code>train_matrix_uuid</code>). This <b>UUID</b> is important
because it's the name of the file in which the matrix is stored.
</p>

<p>
Lastly, <code>{train, test}_results.predictions</code> contains all the <i>scores</i> generated by every
model for every entity. <code>{train_test}_results.evaluation</code> stores the value of all the
<b>metrics</b> for every model, which were specified in the <code>scoring</code>
section in the config file.
</p>
</div>

<ol class="org-ol">
<li><a id="orgd1de2ff"></a><code>model_metadata.experiments</code><br />
<div class="outline-text-5" id="text-4-7-1-1">
<p>
This table has the two columns: <code>experiment_hash</code> and <code>config</code>
</p>

<div class="org-src-container">
<pre class="src src-sql">\d model_metadata.experiments
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "model<sub>metadata.experiments</sub>"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">experiment<sub>hash</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">config</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"experiments<sub>pkey</sub>" PRIMARY KEY, btree (experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Referenced by:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "model<sub>metadata.experiment</sub><sub>matrices</sub>" CONSTRAINT "experiment<sub>matrices</sub><sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (experiment<sub>hash</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "model<sub>metadata.experiment</sub><sub>models</sub>" CONSTRAINT "experiment<sub>models</sub><sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (experiment<sub>hash</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "model<sub>metadata.matrices</sub>" CONSTRAINT "matrices<sub>built</sub><sub>by</sub><sub>experiment</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "model<sub>metadata.models</sub>" CONSTRAINT "models<sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<code>experiment_hash</code> contains the hash of the configuration file that we used for our
<code>triage</code> run.<sup><a id="fnr.40" class="footref" href="#fn.40">40</a></sup> <code>config</code> that contains the configuration experiment file
that we used for our <code>triage</code> run, stored as <code>jsonb</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> experiment_hash,
config -&gt;  <span style="color: #95e454;">'user_metadata'</span> <span style="color: #8ac6f2;">as</span> user_metadata
<span style="color: #8ac6f2;">from</span> model_metadata.experiments;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">experiment<sub>hash</sub></th>
<th scope="col" class="org-left">user<sub>metadata</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">873101c742bc899c9e074003447992b4</td>
<td class="org-left">{"org": "DSaPP", "team": "Tutorial", "author": "Adolfo De Unanue", "etl<sub>date</sub>": "2019-01-18", "experiment<sub>type</sub>": "test", "label<sub>definition</sub>": "failed<sub>inspection</sub>"}</td>
</tr>
</tbody>
</table>


<p>
We could use the following advice: If we are interested in all models
that resulted from a certain config, we could lookup that config in
<code>model_metadata.experiments</code> and then use its <code>experiment_hash</code> on other tables
to find all the models that resulted from that configuration.
</p>
</div>
</li>

<li><a id="org1282bf2"></a><code>metadata_model.model_groups</code><br />
<div class="outline-text-5" id="text-4-7-1-2">
<p>
Do you remember how we defined in <code>grid_config</code> the different
classifiers that we want <code>triage</code> to train? For example, we could use
in a configuration file the following:
</p>

<pre class="example">
    'sklearn.tree.DecisionTreeClassifier':
        criterion: ['entropy']
        max_depth: [1, 2, 5, 10]
        random_state: [2193]
</pre>

<p>
By doing so, we are saying that we want to train 4 decision trees
(<code>max_depth</code> is one of <code>1, 2, 5, 10</code>). However, remember that we are using
temporal crossvalidation to build our models, so we are
going to have different temporal slices that we are training
models on, e.g., 2010-2011, 2011-2012, etc.
</p>

<p>
Therefore, we are going to train our four
decision trees on each temporal slice. Therefore, the trained model (or
the instance of that model) will change across temporal splits, but the
configuration will remain the same. This table lets us keep track of
the different configurations (<code>model_groups</code>) and gives us an <code>id</code> for
each configuration (<code>model_group_id</code>). We can leverage the <code>model_group_id</code>
to find all the models that were trained using the same config
but on different slices of time.
</p>

<p>
In our simple test configuration file we have:
</p>

<pre class="example">
    'sklearn.dummy.DummyClassifier':
        strategy: [most_frequent]
</pre>

<p>
Therefore, if we run the following
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    model_group_id,
    model_type,
    hyperparameters,
    model_config -&gt; <span style="color: #95e454;">'feature_groups'</span> <span style="color: #8ac6f2;">as</span> feature_groups,
    model_config -&gt; <span style="color: #95e454;">'cohort_name'</span> <span style="color: #8ac6f2;">as</span> cohort,
    model_config -&gt; <span style="color: #95e454;">'label_name'</span> <span style="color: #8ac6f2;">as</span> label,
    model_config -&gt; <span style="color: #95e454;">'label_definition'</span> <span style="color: #8ac6f2;">as</span> label_definition,
    model_config -&gt; <span style="color: #95e454;">'experiment_type'</span> <span style="color: #8ac6f2;">as</span> experiment_type,
    model_config -&gt; <span style="color: #95e454;">'etl_date'</span> <span style="color: #8ac6f2;">as</span> etl_date
<span style="color: #8ac6f2;">from</span>
    model_metadata.model_groups;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">model<sub>type</sub></th>
<th scope="col" class="org-left">hyperparameters</th>
<th scope="col" class="org-left">feature<sub>groups</sub></th>
<th scope="col" class="org-left">cohort</th>
<th scope="col" class="org-left">label</th>
<th scope="col" class="org-left">label<sub>definition</sub></th>
<th scope="col" class="org-left">experiment<sub>type</sub></th>
<th scope="col" class="org-left">etl<sub>date</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">["prefix: results", "prefix: risks", "prefix: inspections"]</td>
<td class="org-left">"test<sub>facilities</sub>"</td>
<td class="org-left">"failed<sub>inspections</sub>"</td>
<td class="org-left">"failed<sub>inspection</sub>"</td>
<td class="org-left">"test"</td>
<td class="org-left">"2019-01-18"</td>
</tr>
</tbody>
</table>

<p>
You can see that a model group is defined by the classifier
(<code>model_type</code>), its hyperparameters (<code>hyperparameters</code>), the features
(<code>feature_list</code>) (not shown), and the <code>model_config</code>.
</p>

<p>
The field <code>model_config</code> is created using information from the block
<code>model_group_keys</code>. In our test configuration file the block is:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">model_group_keys</span>:
  - <span style="color: #95e454;">'class_path'</span>
  - <span style="color: #95e454;">'parameters'</span>
  - <span style="color: #95e454;">'feature_names'</span>
  - <span style="color: #95e454;">'feature_groups'</span>
  - <span style="color: #95e454;">'cohort_name'</span>
  - <span style="color: #95e454;">'state'</span>
  - <span style="color: #95e454;">'label_name'</span>
  - <span style="color: #95e454;">'label_timespan'</span>
  - <span style="color: #95e454;">'training_as_of_date_frequency'</span>
  - <span style="color: #95e454;">'max_training_history'</span>
  - <span style="color: #95e454;">'label_definition'</span>
  - <span style="color: #95e454;">'experiment_type'</span>
  - <span style="color: #95e454;">'org'</span>
  - <span style="color: #95e454;">'team'</span>
  - <span style="color: #95e454;">'author'</span>
  - <span style="color: #95e454;">'etl_date'</span>
</pre>
</div>


<p>
<i>What can we learn from that?</i> For example, if we add a new feature and
rerun <code>triage</code>, <code>triage</code> will create a new <code>model_group</code> even if the
classifier and the <code>hyperparameters</code> are the same as before.
</p>
</div>
</li>

<li><a id="org02b3aed"></a><code>model_metadata.models</code><br />
<div class="outline-text-5" id="text-4-7-1-3">
<p>
This table stores the information about our actual <i>models</i>, i.e.,
instances of our classifiers trained on specific temporal slices.
</p>
<div class="org-src-container">
<pre class="src src-sql">\d model_metadata.models
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "model<sub>metadata.models</sub>"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">model<sub>id</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">nextval('model<sub>metadata.models</sub><sub>model</sub><sub>id</sub><sub>seq</sub>'::regclass)</td>
</tr>

<tr>
<td class="org-left">model<sub>group</sub><sub>id</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model<sub>hash</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">run<sub>time</sub></td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">batch<sub>run</sub><sub>time</sub></td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model<sub>type</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">hyperparameters</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model<sub>comment</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">batch<sub>comment</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">config</td>
<td class="org-left">json</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">built<sub>by</sub><sub>experiment</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">train<sub>end</sub><sub>time</sub></td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">test</td>
<td class="org-left">boolean</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">train<sub>matrix</sub><sub>uuid</sub></td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">training<sub>label</sub><sub>timespan</sub></td>
<td class="org-left">interval</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model<sub>size</sub></td>
<td class="org-left">real</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"models<sub>pkey</sub>" PRIMARY KEY, btree (model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"ix<sub>results</sub><sub>models</sub><sub>model</sub><sub>hash</sub>" UNIQUE, btree (model<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Foreign-key constraints:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"matrix<sub>uuid</sub><sub>for</sub><sub>models</sub>" FOREIGN KEY (train<sub>matrix</sub><sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"models<sub>experiment</sub><sub>hash</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"models<sub>model</sub><sub>group</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>group</sub><sub>id</sub>) REFERENCES model<sub>metadata.model</sub><sub>groups</sub>(model<sub>group</sub><sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Referenced by:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "test<sub>results.evaluations</sub>" CONSTRAINT "evaluations<sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "train<sub>results.feature</sub><sub>importances</sub>" CONSTRAINT "feature<sub>importances</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "test<sub>results.individual</sub><sub>importances</sub>" CONSTRAINT "individual<sub>importances</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "model<sub>metadata.list</sub><sub>predictions</sub>" CONSTRAINT "list<sub>predictions</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "test<sub>results.predictions</sub>" CONSTRAINT "predictions<sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "train<sub>results.evaluations</sub>" CONSTRAINT "train<sub>evaluations</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "train<sub>results.predictions</sub>" CONSTRAINT "train<sub>predictions</sub><sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Noteworthy columns are:
</p>

<dl class="org-dl">
<dt><code>model_id</code></dt><dd>The id of the model (i.e., instance&#x2026;). We will
use this ID to trace a model evaluation
to a <code>model_group</code> and vice versa.</dd>
<dt><code>model_group_id</code></dt><dd>The id of the models <i>model group</i> we encountered above.</dd>
<dt><code>model_hash</code></dt><dd>The <i>hash</i> of our model. We can use the hash to
load the actual model. It gets stored under
<code>TRIAGE_OUTPUT_PATH/trained_models/{model_hash}</code>. We
are going to this later to look at a trained
decision tree.</dd>
<dt><code>run_time</code></dt><dd>Time when the model was trained.</dd>
<dt><code>model_type</code></dt><dd>The algorithm used for training.</dd>
<dt><code>model_comment</code></dt><dd>Literally the text in the <code>model_comment</code> block
in the configuration file</dd>
<dt><code>hyperparameters</code></dt><dd>Hyperparameters used for the model
configuration.</dd>
<dt><code>built_by_experiment</code></dt><dd>The hash of our experiment. We encountered this value in the <code>results.experiments</code> table before.</dd>
<dt><code>train_end_time</code></dt><dd>When building the training matrix, we included training samples up to this date.</dd>
<dt><code>train_matrix_uuid</code></dt><dd>The <i>hash</i> of the matrix that we used to
 train this model. The matrix gets stored as <code>csv</code> under
<code>TRIAGE_OUTPUT_PATH/matrices/{train_matrix_uuid}.csv</code>. This is helpful
when trying to inspect the matrix and features that were used
for training.</dd>
<dt><code>train_label_timespan</code></dt><dd>How big was our window to get the labels for our training
matrix? For example, a <code>train_label_window</code> of 1 year would
mean that we look one year from a given date in the training
matrix into the future to find the label for that training
sample.</dd>
</dl>
</div>
</li>


<li><a id="org620160d"></a><code>model_metadata.matrices</code><br />
<div class="outline-text-5" id="text-4-7-1-4">
<p>
This schema contains information about the matrices used in the model's
training. You could use this information to debug your
models. Important columns are <code>matrix_uuid</code> (The matrix gets stored as
        <code>TRIAGE_OUTPUT_PATH/matrices/{train_matrix_uuid}.csv</code>),
<code>matrix_type</code> (indicated if the matrix was used for <i>training</i> models or
<i>testing</i> them), <code>lookback_duration</code> and <code>feature_starttime</code> (give
information about the temporal setting of the features) and <code>num_observations</code>
(size of the matrices).
</p>


<div class="org-src-container">
<pre class="src src-sql">\d model_metadata.matrices
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "model<sub>metadata.matrices</sub>"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">matrix<sub>id</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">matrix<sub>uuid</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">matrix<sub>type</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">labeling<sub>window</sub></td>
<td class="org-left">interval</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num<sub>observations</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">creation<sub>time</sub></td>
<td class="org-left">timestamp with time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">now()</td>
</tr>

<tr>
<td class="org-left">lookback<sub>duration</sub></td>
<td class="org-left">interval</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">feature<sub>start</sub><sub>time</sub></td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">matrix<sub>metadata</sub></td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">built<sub>by</sub><sub>experiment</sub></td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"matrices<sub>pkey</sub>" PRIMARY KEY, btree (matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"ix<sub>model</sub><sub>metadata</sub><sub>matrices</sub><sub>matrix</sub><sub>uuid</sub>" UNIQUE, btree (matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Foreign-key constraints:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"matrices<sub>built</sub><sub>by</sub><sub>experiment</sub><sub>fkey</sub>" FOREIGN KEY (built<sub>by</sub><sub>experiment</sub>) REFERENCES model<sub>metadata.experiments</sub>(experiment<sub>hash</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Referenced by:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "model<sub>metadata.models</sub>" CONSTRAINT "matrix<sub>uuid</sub><sub>for</sub><sub>models</sub>" FOREIGN KEY (train<sub>matrix</sub><sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "test<sub>results.predictions</sub>" CONSTRAINT "matrix<sub>uuid</sub><sub>for</sub><sub>testpred</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "train<sub>results.predictions</sub>" CONSTRAINT "matrix<sub>uuid</sub><sub>for</sub><sub>trainpred</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "train<sub>results.predictions</sub>" CONSTRAINT "train<sub>predictions</sub><sub>matrix</sub><sub>uuid</sub><sub>fkey</sub>" FOREIGN KEY (matrix<sub>uuid</sub>) REFERENCES model<sub>metadata.matrices</sub>(matrix<sub>uuid</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li>


<li><a id="org9b522bb"></a><code>{test, train}_results.evaluations</code><br />
<div class="outline-text-5" id="text-4-7-1-5">
<p>
These tables lets us analyze how well our models are doing. Based on the
config that we used for our <code>triage</code> run, <code>triage</code> is calculating metrics
and storing them in this table, e.g., our model's precision in top 10%.
</p>

<div class="org-src-container">
<pre class="src src-sql">\d test_results.evaluations
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "test<sub>results.evaluations</sub>"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Collation</td>
<td class="org-left">Nullable</td>
<td class="org-left">Default</td>
</tr>

<tr>
<td class="org-left">model<sub>id</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">evaluation<sub>start</sub><sub>time</sub></td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">evaluation<sub>end</sub><sub>time</sub></td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">as<sub>of</sub><sub>date</sub><sub>frequency</sub></td>
<td class="org-left">interval</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">metric</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">parameter</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">not null</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">value</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num<sub>labeled</sub><sub>examples</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num<sub>labeled</sub><sub>above</sub><sub>threshold</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num<sub>positive</sub><sub>labels</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">sort<sub>seed</sub></td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"evaluations<sub>pkey</sub>" PRIMARY KEY, btree (model<sub>id</sub>, evaluation<sub>start</sub><sub>time</sub>, evaluation<sub>end</sub><sub>time</sub>, as<sub>of</sub><sub>date</sub><sub>frequency</sub>, metric, parameter)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Foreign-key constraints:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"evaluations<sub>model</sub><sub>id</sub><sub>fkey</sub>" FOREIGN KEY (model<sub>id</sub>) REFERENCES model<sub>metadata.models</sub>(model<sub>id</sub>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Its columns are:
</p>

<dl class="org-dl">
<dt><code>model_id</code></dt><dd>Our beloved <code>model_id</code> that we have encountered before.</dd>
<dt><code>evaluation_start_time</code></dt><dd>After training the model, we evaluate
it on a test matrix. This column tells us the earliest time
that an example in our test matrix could have.</dd>
<dt><code>evaluation_end_time</code></dt><dd>After training the model, we evaluate
it on a test matrix. This column tells us the latest time that
an example in our test matrix could have.</dd>
<dt><code>metric</code></dt><dd>Indicates which metric we are evaluating, e.g., <code>precision@</code>.</dd>
<dt>(no term)</dt><dd><code>parameter</code> ::Indicates at which parameter we are evaluating our
metric, e.g., a metric of precision@ and a parameter of
<code>100.0_pct</code> shows us the <code>precision@100pct</code>.</dd>
<dt><code>value</code></dt><dd>The value observed for our metric@parameter.</dd>
<dt><code>num_labeled_examples</code></dt><dd>The number of labeled examples in our
test matrix. Why does it matter? It could be the case that we
have entities that have no label for the test timeframe (for example,
not all facilities will have an inspection). We still want to make
predictions for these entities but can't include them when
calculating performance metrics.</dd>
<dt><code>num_labeled_above_threshold</code></dt><dd>How many examples above our threshold were labeled?</dd>
<dt><code>num_positive_labels</code></dt><dd>The number of rows that had true positive labels.</dd>
</dl>

<p>
A look at the table shows that we have multiple rows for each model, each
showing a different performance metric.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    evaluation_end_time,
    model_id,
    metric || <span style="color: #8ac6f2;">parameter</span> <span style="color: #8ac6f2;">as</span> metric,
    <span style="color: #8ac6f2;">value</span>,
    num_labeled_examples,
    num_labeled_above_threshold,
    num_positive_labels
<span style="color: #8ac6f2;">from</span>
    test_results.evaluations
<span style="color: #8ac6f2;">where</span>
    <span style="color: #8ac6f2;">parameter</span> = <span style="color: #95e454;">'100.0_pct'</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">evaluation<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-right">model<sub>id</sub></th>
<th scope="col" class="org-left">metric</th>
<th scope="col" class="org-right">value</th>
<th scope="col" class="org-right">num<sub>labeled</sub><sub>examples</sub></th>
<th scope="col" class="org-right">num<sub>labeled</sub><sub>above</sub><sub>threshold</sub></th>
<th scope="col" class="org-right">num<sub>positive</sub><sub>labels</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-right">1</td>
<td class="org-left">precision@100.0<sub>pct</sub></td>
<td class="org-right">0.6666666666666666</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-right">1</td>
<td class="org-left">recall@100.0<sub>pct</sub></td>
<td class="org-right">1.0</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">2</td>
<td class="org-left">precision@100.0<sub>pct</sub></td>
<td class="org-right">0.3333333333333333</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">2</td>
<td class="org-left">recall@100.0<sub>pct</sub></td>
<td class="org-right">1.0</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
Remember that at 100%, the <code>recall</code> should be 1, and the <code>precision</code> is
equal to the baserate. If these two things don't match, there are
problems in your data, pipeline, etl. You must get this correct!
</p>
</blockquote>

<p>
<i>What does this query tell us?</i>
</p>

<p>
We can now see how the different instances (trained on different temporal
slices, but with the same model params) of a model group performs over
time.  Note how we only included the <i>models</i> that belong to our
<i>model group</i> <code>1</code>.
</p>
</div>
</li>

<li><a id="org5ac3578"></a><code>{test, train}_results.predictions</code><br />
<div class="outline-text-5" id="text-4-7-1-6">
<p>
You can think of the previous table <code>{test, train}_results.{test,
train}_predictions</code> as a summary
of individuals predictions that our model is making. But where can you
find the individual predictions that our model is making? (So you can
generate a list from here). And where can we find the test matrix that
the  predictions are based on? Let us introduce you to the
<code>results.predictions</code> table.
</p>

<p>
Here is what its first row looks like:
</p>

<div class="org-src-container">
<pre class="src src-sql" id="orgf1a6519"><span style="color: #8ac6f2;">select</span>
    model_id,
    entity_id,
    as_of_date,
    score,
    label_value,
    matrix_uuid
<span style="color: #8ac6f2;">from</span>
    test_results.predictions
<span style="color: #8ac6f2;">where</span>
    model_id = 1
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> score <span style="color: #8ac6f2;">desc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>id</sub></th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-left">as<sub>of</sub><sub>date</sub></th>
<th scope="col" class="org-right">score</th>
<th scope="col" class="org-right">label<sub>value</sub></th>
<th scope="col" class="org-left">matrix<sub>uuid</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">219</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-right">1.0</td>
<td class="org-right">1</td>
<td class="org-left">c29c7917371d4cea99fadf4ad37a5686</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">362</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-right">1.0</td>
<td class="org-right">1</td>
<td class="org-left">c29c7917371d4cea99fadf4ad37a5686</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">859</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-right">1.0</td>
<td class="org-right">0</td>
<td class="org-left">c29c7917371d4cea99fadf4ad37a5686</td>
</tr>
</tbody>
</table>


<p>
As you can see, the table contains our models' predictions for a given
entity and date.
</p>

<p>
And do you notice the field <code>matrix_uuid</code>? Doesn't it look similar to
the fields from above that gave us the names of our training matrices?
In fact, it is the same. You can find the test matrix that was used to
make this prediction under <code>TRIAGE_OUTPUT_PATH/matrices/{matrix_uuid}.csv</code>.
</p>
</div>
</li>

<li><a id="orgb66ef4e"></a><code>{test, train}_results.feature_importances</code><br />
<div class="outline-text-5" id="text-4-7-1-7">
<p>
This tables store the feature importance of all the models.
</p>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgd1e0073" class="outline-3">
<h3 id="orgd1e0073"><span class="section-number-3">4.8</span> Audition</h3>
<div class="outline-text-3" id="text-4-8">
<p>
<b>Audition</b> is a tool for helping you select a subset of trained
classifiers from a triage experiment. Often, production-scale experiments
will come up with thousands of trained models, and sifting through all
of those results can be time-consuming even after calculating the
usual basic metrics like precision and recall.
</p>

<p>
You will be facing questions as:
</p>

<ul class="org-ul">
<li>Which metrics matter most?</li>
<li>Should you prioritize the best metric value over time or treat
recent data as most important?</li>
<li>Is low metric variance important?</li>
</ul>

<p>
The answers to questions like these may not be obvious. <b>Audition</b>
introduces a structured, semi-automated way of filtering models based
on what you consider important.
</p>
</div>
</div>

<div id="outline-container-org51a3f9a" class="outline-3">
<h3 id="org51a3f9a"><span class="section-number-3">4.9</span> Post-modeling</h3>
<div class="outline-text-3" id="text-4-9">
<p>
As the name indicates, <b>postmodeling</b> occurs <b>after</b> you have modeled
(potentially) thousands of models (different hyperparameters, different
time windows, different algorithms, etc), and using <code>audition</code> you <i>pre</i>
selected a small number of models.
</p>

<p>
Now, with the <b>postmodeling</b> tools you will be able to select your final
model for <i>production</i> use.
</p>

<p>
Triage's postmodeling capabilities include:
</p>

<ul class="org-ul">
<li>Show the score distribution</li>
<li>Compare the list generated by a set of models</li>
<li>Compare the feature importance between a set of models</li>
<li>Diplay the probability calibration curves</li>
<li>Analyze the errors using a decision tree trained on the errors of the model.</li>
<li>Cross-tab analysis</li>
<li>Bias analysis</li>
</ul>

<p>
If you want to see <b>Audition</b> and <b>Postmodeling</b> in action, please see
<a href="inspections.html">Inspections modeling</a> or to <a href="eis.html">EIS modeling</a> for practical examples.
</p>
</div>
</div>

<div id="outline-container-orga988a26" class="outline-3">
<h3 id="orga988a26"><span class="section-number-3">4.10</span> Final cleaning</h3>
<div class="outline-text-3" id="text-4-10">
<p>
In the next section we will start modeling, so it is a good idea to
clean the <code>{test, train}_results</code> schemas and have a fresh start:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> nuke_triage<span style="color: #8c8c8c;">()</span>;
</pre>
</div>

<p>
<code>triage</code> also creates a lot of files (we will see why in the next section). Let's remove them too.
</p>

<div class="org-src-container">
<pre class="src src-sh">rm -r /triage/output/matrices/*
rm -r /triage/output/trained_models/*
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgf1af385" class="outline-2">
<h2 id="orgf1af385"><span class="section-number-2">5</span> Inpection prioritization</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org3d761c5" class="outline-3">
<h3 id="org3d761c5"><span class="section-number-3">5.1</span> Problem description</h3>
<div class="outline-text-3" id="text-5-1">
<p>
We will begin with the <b>inspection prioritization</b> problem. We want to generate a list of
  facilities that will have a <b>critical</b> or <b>serious</b> food violation <i>if</i> inspected.
</p>

<p>
The scenario is the following: you work for the City of Chicago and you have
  limited food inspectors, so you try to prioritize them to focus on the highest-risk
  facilities. So you will use the data to answer the next question:
</p>

<blockquote>
<p>
Which X facilities are most likely to fail a food inspection in the
  following Y period of time?
</p>
</blockquote>

<p>
If you want to focus on major violations only, you can do that too:
</p>

<blockquote>
<p>
Which X facilities are most likely to have a critical or serious
  violation in the following Y period of time?
</p>
</blockquote>
</div>
</div>


<div id="outline-container-orgf41a447" class="outline-3">
<h3 id="orgf41a447"><span class="section-number-3">5.2</span> Creating the labels</h3>
<div class="outline-text-3" id="text-5-2">
<p>
We will define two labels:
</p>

<ul class="org-ul">
<li><b>Which facilities are likely to fail an inspection?</b></li>
</ul>

<p>
The label takes a 1 if the inspection had at least one <code>result</code> = <code>'fail'</code> and a 0 otherwise.
</p>

<ul class="org-ul">
<li><b>Which facilities fail an inspection with a major violation?</b></li>
</ul>

<p>
Critical violations are coded between <code>1-14</code>, serious violations between
<code>15-29</code>, everything above <code>30</code> is assumed to be a minor violation.
The label takes a 1 if the inspection had at least one <code>result</code> = <code>'fail'</code> and a
violation between 1 and 29, and a 0 otherwise.
</p>

<p>
We can extract the severity of the violation using the
following code:
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    event_id,
    entity_id,
    <span style="color: #92a65e;">date</span>,
    <span style="color: #8ac6f2;">result</span>,
    array_agg<span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">distinct</span> obj -&gt;&gt;<span style="color: #95e454;">'severity'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> violations_severity,
    <span style="color: #8c8c8c;">(</span><span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> failed,
    <span style="color: #e5786d;">coalesce</span><span style="color: #8c8c8c;">(</span>
    <span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">result</span> = <span style="color: #95e454;">'fail'</span> <span style="color: #8ac6f2;">and</span>
        <span style="color: #b0b1a3;">(</span><span style="color: #95e454;">'serious'</span> = <span style="color: #8ac6f2;">ANY</span><span style="color: #97b098;">(</span>array_agg<span style="color: #aebed8;">(</span>obj -&gt;&gt; <span style="color: #95e454;">'severity'</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #8ac6f2;">or</span> <span style="color: #95e454;">'critical'</span> = <span style="color: #8ac6f2;">ANY</span><span style="color: #97b098;">(</span>array_agg<span style="color: #aebed8;">(</span>obj -&gt;&gt; <span style="color: #95e454;">'severity'</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #93a8c6;">)</span>, <span style="color: #8ac6f2;">false</span>
    <span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> failed_major_violation
<span style="color: #8ac6f2;">from</span>
    <span style="color: #8c8c8c;">(</span>
    <span style="color: #8ac6f2;">select</span>
        event_id,
        entity_id,
        <span style="color: #92a65e;">date</span>,
        <span style="color: #8ac6f2;">result</span>,
        jsonb_array_elements<span style="color: #93a8c6;">(</span>violations::jsonb<span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> obj
    <span style="color: #8ac6f2;">from</span>
        semantic.events
        <span style="color: #8ac6f2;">limit</span> 20
        <span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> t1
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    entity_id, event_id, <span style="color: #92a65e;">date</span>, <span style="color: #8ac6f2;">result</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    <span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">desc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">event<sub>id</sub></th>
<th scope="col" class="org-right">entity<sub>id</sub></th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-left">result</th>
<th scope="col" class="org-left">violations<sub>severity</sub></th>
<th scope="col" class="org-left">failed</th>
<th scope="col" class="org-left">failed<sub>major</sub><sub>violation</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1770568</td>
<td class="org-right">30852</td>
<td class="org-right">2016-05-11</td>
<td class="org-left">pass</td>
<td class="org-left">{minor}</td>
<td class="org-left">f</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">1763967</td>
<td class="org-right">30852</td>
<td class="org-right">2016-05-03</td>
<td class="org-left">fail</td>
<td class="org-left">{critical,minor,serious}</td>
<td class="org-left">t</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">1434534</td>
<td class="org-right">21339</td>
<td class="org-right">2014-04-03</td>
<td class="org-left">pass</td>
<td class="org-left">{NULL}</td>
<td class="org-left">f</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">1343315</td>
<td class="org-right">22056</td>
<td class="org-right">2013-06-06</td>
<td class="org-left">fail</td>
<td class="org-left">{minor,serious}</td>
<td class="org-left">t</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">1235707</td>
<td class="org-right">21339</td>
<td class="org-right">2013-03-27</td>
<td class="org-left">pass</td>
<td class="org-left">{NULL}</td>
<td class="org-left">f</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">537439</td>
<td class="org-right">13471</td>
<td class="org-right">2011-06-10</td>
<td class="org-left">fail</td>
<td class="org-left">{NULL}</td>
<td class="org-left">t</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">569377</td>
<td class="org-right">5592</td>
<td class="org-right">2011-06-01</td>
<td class="org-left">pass</td>
<td class="org-left">{NULL}</td>
<td class="org-left">f</td>
<td class="org-left">f</td>
</tr>
</tbody>
</table>

<p>
Remember from the section <a href="#org3e82d33">Cohorts, labels, event dates and as of dates</a> that the <i>outcome</i> will be used by
<code>triage</code> to generate the labels. The following image tries to
show the meaning of the <i>outcomes</i> for the <i>inspection failed</i> problem definition.
</p>


<div id="org6894f0c" class="figure">
<p><img src="./images/outcomes-inspections.png" alt="outcomes-inspections.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 13: </span>The image shows three facilities and, next to each, a temporal line with 6 days (0-5). Each dot represents an inspection. Green means the facility passed the inspection, and red means it failed. Each facility in the image had two inspections, but only the facility in the middle passed both.</p>
</div>
</div>
</div>



<div id="outline-container-org129f598" class="outline-3">
<h3 id="org129f598"><span class="section-number-3">5.3</span> Modeling Using Machine Learning</h3>
<div class="outline-text-3" id="text-5-3">
<p>
It is time to put these steps together. All the coding is complete
(<code>triage</code> dev team did that for us); we just need to modify the <code>triage</code>
configuration file.
</p>
</div>

<div id="outline-container-orgc8a0675" class="outline-4">
<h4 id="orgc8a0675"><span class="section-number-4">5.3.1</span> Defining a baseline</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
As a first step, lets do an experiment that defines our
<i>baseline</i>. The rationale of this is that the knowing the <i>baseline</i> will
allow us to verify if our Machine Learning model is better than the
baseline.  It is also very fast to train ( <code>DummyClassifier</code> is not
computationally expensive, so it will
help us to verify that the experiment configuration is correct without
waiting for a long time)
</p>

<p>
We need to write the experiment config file for that. Let's break it
down and explain the sections.
</p>

<p>
The config file for this first experiment is located in
<a href="./triage/experiment_config/inspections_baseline.yaml">triage/experiment<sub>config</sub>/inspections<sub>baseline.yaml</sub></a>.
</p>

<p>
The first lines of the experiment config file specify the
config-file version (<code>v6</code> at the moment of writing this tutorial),
a comment (<code>model_comment</code>, which will end up as
a value in the <code>model_metadata.models</code> table), and a list of user-defined
metadata (<code>user_metadata</code>) that can help to identify the
resulting model groups. For this example, if you run experiments that share
a temporal configuration but that use different label definitions
(say, labeling inspections with <b>any</b> violation as positive versus
only labeling inspections with major violations as positive),
you can use the user metadata keys to indicate that the matrices
from these experiments have different labeling criteria. The matrices from the
two experiments will have different filenames (and should not be overwritten or
incorrectly used), and if you add the <code>label_definition</code> key to
the <code>model_group_keys</code>, models made on different label definitions will
belong to different model groups.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">config_version</span>: <span style="color: #95e454;">'v6'</span>

<span style="color: #cae682;">model_comment</span>: <span style="color: #95e454;">'inspections: baseline'</span>

<span style="color: #cae682;">user_metadata</span>:
    <span style="color: #cae682;">label_definition</span>: <span style="color: #95e454;">'failed'</span>
    <span style="color: #cae682;">experiment_type</span>: <span style="color: #95e454;">'inspections prioritization'</span>
    <span style="color: #cae682;">description</span>: |
      <span style="color: #95e454;">Baseline calculation</span>
    <span style="color: #cae682;">purpose</span>: <span style="color: #95e454;">'baseline'</span>
    <span style="color: #cae682;">org</span>: <span style="color: #95e454;">'DSaPP'</span>
    <span style="color: #cae682;">team</span>: <span style="color: #95e454;">'Tutorial'</span>
    <span style="color: #cae682;">author</span>: <span style="color: #95e454;">'Your name here'</span>
    <span style="color: #cae682;">etl_date</span>: <span style="color: #95e454;">'2019-01-18'</span>

<span style="color: #cae682;">model_group_keys</span>:
  - <span style="color: #95e454;">'class_path'</span>
  - <span style="color: #95e454;">'parameters'</span>
  - <span style="color: #95e454;">'feature_names'</span>
  - <span style="color: #95e454;">'feature_groups'</span>
  - <span style="color: #95e454;">'cohort_name'</span>
  - <span style="color: #95e454;">'state'</span>
  - <span style="color: #95e454;">'label_name'</span>
  - <span style="color: #95e454;">'label_timespan'</span>
  - <span style="color: #95e454;">'training_as_of_date_frequency'</span>
  - <span style="color: #95e454;">'max_training_history'</span>
  - <span style="color: #95e454;">'label_definition'</span>
  - <span style="color: #95e454;">'experiment_type'</span>
  - <span style="color: #95e454;">'org'</span>
  - <span style="color: #95e454;">'team'</span>
  - <span style="color: #95e454;">'author'</span>
  - <span style="color: #95e454;">'purpose'</span>
  - <span style="color: #95e454;">'etl_date'</span>


</pre>
</div>

<p>
(Obviously, change <code>'Your name here'</code> for your name)
</p>

<p>
Next comes the <b>temporal configuration</b> section. The first four parameters
are related to the availability of data: How much data you have for
feature creation? How much data you have for label generation? For
simplicity we will assume that we can use the full <code>semantic.events</code> time
span for both.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #e5786d;">min</span><span style="color: #8c8c8c;">(</span><span style="color: #92a65e;">date</span><span style="color: #8c8c8c;">)</span>, <span style="color: #e5786d;">max</span><span style="color: #8c8c8c;">(</span><span style="color: #92a65e;">date</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">from</span> semantic.events
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">min</th>
<th scope="col" class="org-right">max</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2010-01-04</td>
<td class="org-right">2019-01-18</td>
</tr>
</tbody>
</table>

<p>
The next parameters are related to the training intervals:
</p>
<ul class="org-ul">
<li>How frequently to retrain models? (<code>model_update_frequency</code>)</li>
<li>How many rows per entity in the train matrices?
(<code>training_as_of_date_frequencies</code>)</li>
<li>How much time is covered by labels in the training matrices? (<code>training_label_timespans</code>)</li>
</ul>

<p>
The remaining elements are related to the <b>testing</b> matrices.
For <b>inspections</b>, you can choose them as follows:
</p>

<ul class="org-ul">
<li><code>test_as_of_date_frequencies</code> is planning/scheduling frequency</li>
<li><code>test_durations</code> how far ahead do you schedule inspections?</li>
<li><code>test_label_timespan</code> is equal to <code>test_durations</code></li>
</ul>

<p>
Let's assume that we need to do rounds of inspections every month
(<code>test_as_of_date_frequencies = 1month</code>) and we need to complete that
round in exactly one month (<code>test_durations = test_label_timespan =
1month</code>).
</p>

<p>
We will assume that the data is more or less stable<sup><a id="fnr.41" class="footref" href="#fn.41">41</a></sup>, at least for one
year, so <code>model_update_frequency</code> = <code>1 year.</code>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">temporal_config</span>:
    <span style="color: #cae682;">feature_start_time</span>: <span style="color: #95e454;">'2010-01-04'</span>
    <span style="color: #cae682;">feature_end_time</span>: <span style="color: #95e454;">'2019-01-01'</span>
    <span style="color: #cae682;">label_start_time</span>: <span style="color: #95e454;">'2015-02-01'</span>
    <span style="color: #cae682;">label_end_time</span>: <span style="color: #95e454;">'2019-01-01'</span>

    <span style="color: #cae682;">model_update_frequency</span>: <span style="color: #95e454;">'1y'</span>
    <span style="color: #cae682;">training_label_timespans</span>: [<span style="color: #95e454;">'1month'</span>]
    <span style="color: #cae682;">training_as_of_date_frequencies</span>: <span style="color: #95e454;">'1month'</span>

    <span style="color: #cae682;">test_durations</span>: <span style="color: #95e454;">'1y'</span>
    <span style="color: #cae682;">test_label_timespans</span>: [<span style="color: #95e454;">'1month'</span>]
    <span style="color: #cae682;">test_as_of_date_frequencies</span>: <span style="color: #95e454;">'1month'</span>

    <span style="color: #cae682;">max_training_histories</span>: <span style="color: #95e454;">'5y'</span>
</pre>
</div>

<p>
We can visualize the splitting using the function <code>show-timechop</code>
introduced in <a href="triage_intro.html">Introduction to triage</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage showtimechops experiment_config/inspections_baseline.yaml
</pre>
</div>


<div class="figure">
<p><img src="./images/inspections_baseline.png" alt="inspections_baseline.png" width="800" height="800" />
</p>
<p><span class="figure-number">Figure 14: </span>Temporal blocks for inspections<sub>dt</sub> experiment</p>
</div>

<p>
We need to specify our labels. For this first
experiment we will use the label <code>failed</code>, using the same query from the
<code>simple_skeleton_experiment.yaml</code>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">label_config</span>:
  <span style="color: #cae682;">query</span>: |
    <span style="color: #95e454;">select</span>
<span style="color: #95e454;">    entity_id,</span>
    bool_or(result = <span style="color: #95e454;">'fail'</span>)::integer as outcome
<span style="color: #95e454;">    from semantic.events</span>
    where <span style="color: #95e454;">'{as_of_date}'</span>::timestamp &lt;= date
    and date &lt; <span style="color: #95e454;">'{as_of_date}'</span>::timestamp + interval <span style="color: #95e454;">'{label_timespan}'</span>
<span style="color: #95e454;">    group by entity_id</span>
  <span style="color: #cae682;">name</span>: <span style="color: #95e454;">'failed_inspections'</span>
</pre>
</div>

<p>
We just want to include <b>active</b> facilities in our matrices, so we tell
<code>triage</code> to take that in account:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">cohort_config</span>:
  <span style="color: #cae682;">query</span>: |
    <span style="color: #95e454;">select entity_id</span>
<span style="color: #95e454;">    from semantic.entities</span>
<span style="color: #95e454;">    where</span>
    daterange(start_time, end_time, <span style="color: #95e454;">'[]'</span>) @&gt; <span style="color: #95e454;">'{as_of_date}'</span>::date
  <span style="color: #cae682;">name</span>: <span style="color: #95e454;">'active_facilities'</span>
</pre>
</div>

<p>
<code>Triage</code> will generate the features for us, but we need to tell it which features
we want in the section <code>feature_aggregations</code>. Here, each entry describes a
<code>collate.SpacetimeAggregation</code> object and the
arguments needed to create it. For this experiment, we will use only
one feature (number of inspections). <code>DummyClassifier</code> don't use any
feature to do the "prediction", so we won't expend compute cycles
doing the feature/matrix creation:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">feature_aggregations</span>:
  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'inspections'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">aggregates_imputation</span>:
      <span style="color: #cae682;">count</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero_noflag'</span>

    <span style="color: #cae682;">aggregates</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        quantity</span>:
          <span style="color: #cae682;">total</span>: <span style="color: #95e454;">"*"</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'count'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>

<span style="color: #cae682;">feature_group_definition</span>:
   <span style="color: #cae682;">prefix</span>:
     - <span style="color: #95e454;">'inspections'</span>

<span style="color: #cae682;">feature_group_strategies</span>: [<span style="color: #95e454;">'all'</span>]
</pre>
</div>

<p>
If we observe the image generated from the <code>temporal_config</code> section,
each particular date is the beginning of the rectangles that describes
the rows in the matrix. In that date (<code>as_of_date</code> in <code>timechop</code> parlance)
we will calculate both features, and we will repeat that for every
other rectangle in that image.
</p>

<p>
Now, let's discuss how we will specify the models to try
(remember that the model is specified by the algorithm, the
hyperparameters, and the subset of features to use). In <code>triage</code> you
need to specify in the <code>grid_config</code> section a list of machine learning
algorithms that you want to train and a list of
hyperparameters. You can use any algorithm that you want; the only
requirement is that it respects the <code>sklearn</code> API.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">grid_config</span>:
    <span style="color: #95e454;">'sklearn.dummy.DummyClassifier'</span>:
        <span style="color: #cae682;">strategy</span>: [prior,uniform, most_frequent]
</pre>
</div>

<p>
Finally, we should define wich metrics we care about for evaluating our
model. Here we will concentrate only in <code>precision</code> and <code>recall</code>.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">scoring</span>:
    <span style="color: #cae682;">testing_metric_groups</span>:
        <span style="color: #cae682;">-</span>
<span style="color: #cae682;">          metrics</span>: [precision@, recall@]
          <span style="color: #cae682;">thresholds</span>:
            <span style="color: #cae682;">percentiles</span>: [1.0, 2.0, 3.0, 4.0, 5.0, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]
            <span style="color: #cae682;">top_n</span>: [1, 5, 10, 25, 50, 100, 250, 500, 1000]


    <span style="color: #cae682;">training_metric_groups</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        metrics</span>: [accuracy]
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        metrics</span>: [precision@, recall@]
        <span style="color: #cae682;">thresholds</span>:
          <span style="color: #cae682;">percentiles</span>: [1.0, 2.0, 3.0, 4.0, 5.0, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]
          <span style="color: #cae682;">top_n</span>: [1, 5, 10, 25, 50, 100, 250, 500, 1000]
</pre>
</div>

<p>
You should be warned that precision and recall at \(k\) in this setting
is kind of ill-defined (because you will end with a lot of <code>NULL</code>
labels, remember, only a few of facilities are inspected in each
period)<sup><a id="fnr.42" class="footref" href="#fn.42">42</a></sup>.
</p>

<p>
We will want a <b>list</b> of facilities to
be inspected. The length of our list is constrained by our inspection
resources, i.e. the answer to the question <i>How many facilities can I
inpect in a month?</i> In this experiment we are assuming that the
maximum capacity is <b>50</b> but we are testing also for a list of length
<b>5</b>, and <b>10</b> (see <code>top_n</code> above).
</p>

<p>
The execution of the experiments can take a long time, so it is a
good practice to <i>validate</i> the configuration file <i>before</i> running
the model. You don't want to wait for hours (or days) and then
discover that something went wrong.
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/inspections_baseline.yaml  --validate-only
</pre>
</div>

<p>
If everything was ok, you should see an <code>Experiment validation ran to completion with no errors</code>.
</p>

<p>
You can execute the experiment as<sup><a id="fnr.43" class="footref" href="#fn.43">43</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/inspections_baseline.yaml --profile
</pre>
</div>


<p>
This will print a lot of output, and if everything is correct it will
create <b>6</b> matrices (3 for
training, 3 for testing) in <code>triage/matrices</code> and every matrix will be
represented by two files, one with the metadata of the matrix (a
<code>yaml</code> file) and one with the actual matrix (the <code>csv</code> file).
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">We will use some bash magic</span>

ls matrices | awk -F . <span style="color: #95e454;">'{print $NF}'</span> | sort | uniq -c
</pre>
</div>

<p>
<code>Triage</code> also will store <b>9</b> trained models in <code>triage/trained_models</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">ls trained_models | wc -l
</pre>
</div>

<p>
And it will populate the <code>results</code> schema in the database. As
mentioned, we will get <b>3</b> <i>model groups</i>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    model_group_id,
    model_type,
    hyperparameters
<span style="color: #8ac6f2;">from</span>
    model_metadata.model_groups;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">model<sub>type</sub></th>
<th scope="col" class="org-left">hyperparameters</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
</tr>
</tbody>
</table>


<p>
And <b>9</b> <i>models</i>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    model_group_id,
    array_agg<span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> models,
    array_agg<span style="color: #8c8c8c;">(</span>train_end_time<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> train_end_times
<span style="color: #8ac6f2;">from</span>
    model_metadata.models
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    model_group_id
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    model_group_id
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">models</th>
<th scope="col" class="org-left">train<sub>end</sub><sub>times</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">{1,4,7}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">{2,5,8}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">{3,6,9}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
</tbody>
</table>

<p>
From that last query, you should note that the order in which <code>triage</code> trains
the models is from oldest to newest <code>train_end_time</code> and
<code>model_group</code> , also in ascending order. It will not go to the
next block until all the <i>models groups</i> are trained.
</p>

<p>
You can check with which matrix the models are trained:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    model_group_id,
    model_id, train_end_time,
    model_hash, train_matrix_uuid,
    ma.num_observations <span style="color: #8ac6f2;">as</span> observations,
    ma.lookback_duration <span style="color: #8ac6f2;">as</span> feature_lookback_duration,  ma.feature_start_time
<span style="color: #8ac6f2;">from</span>
    model_metadata.models <span style="color: #8ac6f2;">as</span> mo
    <span style="color: #8ac6f2;">join</span>
    model_metadata.matrices <span style="color: #8ac6f2;">as</span> ma
    <span style="color: #8ac6f2;">on</span> train_matrix_uuid = matrix_uuid
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    model_group_id,
    train_end_time <span style="color: #8ac6f2;">asc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-right">model<sub>id</sub></th>
<th scope="col" class="org-left">train<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-left">model<sub>hash</sub></th>
<th scope="col" class="org-left">train<sub>matrix</sub><sub>uuid</sub></th>
<th scope="col" class="org-right">observations</th>
<th scope="col" class="org-left">feature<sub>lookback</sub><sub>duration</sub></th>
<th scope="col" class="org-left">feature<sub>start</sub><sub>time</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">2015-12-01 00:00:00</td>
<td class="org-left">d3cea395750042c6ce8b4b16629b7f27</td>
<td class="org-left">82a55ba9d2013abb7722c20b17500b57</td>
<td class="org-right">10763</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-left">2016-12-01 00:00:00</td>
<td class="org-left">6ec07f83562b515c46b1ef7d6c76e5f4</td>
<td class="org-left">a6a067fbbf34115a48201a626f17e67a</td>
<td class="org-right">25036</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">7</td>
<td class="org-left">2017-12-01 00:00:00</td>
<td class="org-left">6356a11ad724fa48ef2751d13f11801c</td>
<td class="org-left">e8663158b8c6b131505f12fafd196e8d</td>
<td class="org-right">38673</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">2015-12-01 00:00:00</td>
<td class="org-left">74fee6432b12350f25c62bdf4c499a82</td>
<td class="org-left">82a55ba9d2013abb7722c20b17500b57</td>
<td class="org-right">10763</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">5</td>
<td class="org-left">2016-12-01 00:00:00</td>
<td class="org-left">a011aa2bad1cecaa3ba3a7e579efa80a</td>
<td class="org-left">a6a067fbbf34115a48201a626f17e67a</td>
<td class="org-right">25036</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">8</td>
<td class="org-left">2017-12-01 00:00:00</td>
<td class="org-left">36d38ecf8f2b3b433eb7c4dc5a048577</td>
<td class="org-left">e8663158b8c6b131505f12fafd196e8d</td>
<td class="org-right">38673</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-left">2015-12-01 00:00:00</td>
<td class="org-left">062f34c179e27cc779f050f7678f87a3</td>
<td class="org-left">82a55ba9d2013abb7722c20b17500b57</td>
<td class="org-right">10763</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">6</td>
<td class="org-left">2016-12-01 00:00:00</td>
<td class="org-left">abd9adc61fce6b64ad4a52461e894f51</td>
<td class="org-left">a6a067fbbf34115a48201a626f17e67a</td>
<td class="org-right">25036</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">9</td>
<td class="org-left">2017-12-01 00:00:00</td>
<td class="org-left">cb89c4cc25bf9ca6746ab899d9805c74</td>
<td class="org-left">e8663158b8c6b131505f12fafd196e8d</td>
<td class="org-right">38673</td>
<td class="org-left">@ 5 years</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>
</tbody>
</table>

<p>
As expected, we have three models per model group. Each model was trained
with the matrix indicated in the column <code>train_matrix_uuid</code>. This <code>uuid</code>
is the file name of the stored matrix. The model itself was
stored under the file named with the <code>model_hash</code>.
</p>

<p>
If you want to see in which matrix the model was <i>tested</i> you need to
run the following query
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #8ac6f2;">distinct</span>
    model_id,
    model_group_id, train_end_time,
    model_hash,
    pr.matrix_uuid <span style="color: #8ac6f2;">as</span> test_matrix_uuid,
    ma.num_observations <span style="color: #8ac6f2;">as</span> observations,
    ma.lookback_duration <span style="color: #8ac6f2;">as</span> feature_lookback_duration,  ma.feature_start_time
<span style="color: #8ac6f2;">from</span>
    model_metadata.models <span style="color: #8ac6f2;">as</span> mo
    <span style="color: #8ac6f2;">join</span>
    test_results.predictions <span style="color: #8ac6f2;">as</span> pr <span style="color: #8ac6f2;">using</span> <span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">join</span>
    model_metadata.matrices <span style="color: #8ac6f2;">as</span> ma <span style="color: #8ac6f2;">on</span> pr.matrix_uuid = ma.matrix_uuid
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    model_group_id, train_end_time <span style="color: #8ac6f2;">asc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>id</sub></th>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">train<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-left">model<sub>hash</sub></th>
<th scope="col" class="org-left">test<sub>matrix</sub><sub>uuid</sub></th>
<th scope="col" class="org-right">observations</th>
<th scope="col" class="org-left">feature<sub>lookback</sub><sub>duration</sub></th>
<th scope="col" class="org-left">feature<sub>start</sub><sub>time</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">2015-12-01 00:00:00</td>
<td class="org-left">d3cea395750042c6ce8b4b16629b7f27</td>
<td class="org-left">ce3fb740876bfe04aa05e0a6ec9dbd69</td>
<td class="org-right">228584</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">1</td>
<td class="org-left">2016-12-01 00:00:00</td>
<td class="org-left">6ec07f83562b515c46b1ef7d6c76e5f4</td>
<td class="org-left">9e6d30009128903d2cb30ddfa4de6daf</td>
<td class="org-right">236914</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">1</td>
<td class="org-left">2017-12-01 00:00:00</td>
<td class="org-left">6356a11ad724fa48ef2751d13f11801c</td>
<td class="org-left">54137d5f48f70e52e4dae0a681c7476c</td>
<td class="org-right">246585</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">2015-12-01 00:00:00</td>
<td class="org-left">74fee6432b12350f25c62bdf4c499a82</td>
<td class="org-left">ce3fb740876bfe04aa05e0a6ec9dbd69</td>
<td class="org-right">228584</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">2</td>
<td class="org-left">2016-12-01 00:00:00</td>
<td class="org-left">a011aa2bad1cecaa3ba3a7e579efa80a</td>
<td class="org-left">9e6d30009128903d2cb30ddfa4de6daf</td>
<td class="org-right">236914</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">2</td>
<td class="org-left">2017-12-01 00:00:00</td>
<td class="org-left">36d38ecf8f2b3b433eb7c4dc5a048577</td>
<td class="org-left">54137d5f48f70e52e4dae0a681c7476c</td>
<td class="org-right">246585</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-left">2015-12-01 00:00:00</td>
<td class="org-left">062f34c179e27cc779f050f7678f87a3</td>
<td class="org-left">ce3fb740876bfe04aa05e0a6ec9dbd69</td>
<td class="org-right">228584</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">3</td>
<td class="org-left">2016-12-01 00:00:00</td>
<td class="org-left">abd9adc61fce6b64ad4a52461e894f51</td>
<td class="org-left">9e6d30009128903d2cb30ddfa4de6daf</td>
<td class="org-right">236914</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">3</td>
<td class="org-left">2017-12-01 00:00:00</td>
<td class="org-left">cb89c4cc25bf9ca6746ab899d9805c74</td>
<td class="org-left">54137d5f48f70e52e4dae0a681c7476c</td>
<td class="org-right">246585</td>
<td class="org-left">@ 1 year</td>
<td class="org-left">2010-01-04 00:00:00</td>
</tr>
</tbody>
</table>

<p>
All the models were stored in
<code>/triage/trained_models/{model_hash}</code>
using the standard serialization of sklearn models. Every model was
trained with the matrix <code>train_matrix_uuid</code>
 stored in the directory <code>/triage/matrices</code>.
</p>


<p>
What's the performance of this model groups?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #8ac6f2;">distinct</span>
    model_group_id,
    model_id,
    ma.feature_start_time::<span style="color: #92a65e;">date</span>,
    train_end_time::<span style="color: #92a65e;">date</span>,
    ev.evaluation_start_time::<span style="color: #92a65e;">date</span>,
    ev.evaluation_end_time::<span style="color: #92a65e;">date</span>,
    to_char<span style="color: #8c8c8c;">(</span>ma.num_observations, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> observations,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_labeled_examples, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> labeled_examples,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_labeled_above_threshold, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> labeled_above_threshold,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_positive_labels, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_positive_labels,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_positive_labels*1.0 / ma.num_observations, <span style="color: #95e454;">'0.999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> baserate,
    to_char<span style="color: #8c8c8c;">(</span>ev.<span style="color: #8ac6f2;">value</span>, <span style="color: #95e454;">'0.999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> "<span style="color: #92a65e;">precision</span>@100%"
<span style="color: #8ac6f2;">from</span>
    model_metadata.models <span style="color: #8ac6f2;">as</span> mo
    <span style="color: #8ac6f2;">join</span>
    test_results.predictions <span style="color: #8ac6f2;">as</span> pr <span style="color: #8ac6f2;">using</span> <span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">join</span>
    model_metadata.matrices <span style="color: #8ac6f2;">as</span> ma <span style="color: #8ac6f2;">on</span> pr.matrix_uuid = ma.matrix_uuid
    <span style="color: #8ac6f2;">join</span>
    test_results.evaluations <span style="color: #8ac6f2;">as</span> ev <span style="color: #8ac6f2;">using</span><span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">where</span>
    ev.metric || ev.<span style="color: #8ac6f2;">parameter</span> = <span style="color: #95e454;">'precision@100_pct'</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    train_end_time <span style="color: #8ac6f2;">asc</span>, model_group_id;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-right">model<sub>id</sub></th>
<th scope="col" class="org-right">feature<sub>start</sub><sub>time</sub></th>
<th scope="col" class="org-right">train<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-right">evaluation<sub>start</sub><sub>time</sub></th>
<th scope="col" class="org-right">evaluation<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-left">observations</th>
<th scope="col" class="org-left">labeled<sub>examples</sub></th>
<th scope="col" class="org-left">labeled<sub>above</sub><sub>threshold</sub></th>
<th scope="col" class="org-left">total<sub>positive</sub><sub>labels</sub></th>
<th scope="col" class="org-right">baserate</th>
<th scope="col" class="org-right">precision@100%</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2016-11-01</td>
<td class="org-left">228,584</td>
<td class="org-left">14,273</td>
<td class="org-left">14,273</td>
<td class="org-left">3,460</td>
<td class="org-right">0.015</td>
<td class="org-right">0.242</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2016-11-01</td>
<td class="org-left">228,584</td>
<td class="org-left">14,273</td>
<td class="org-left">14,273</td>
<td class="org-left">3,460</td>
<td class="org-right">0.015</td>
<td class="org-right">0.242</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2016-11-01</td>
<td class="org-left">228,584</td>
<td class="org-left">14,273</td>
<td class="org-left">14,273</td>
<td class="org-left">3,460</td>
<td class="org-right">0.015</td>
<td class="org-right">0.242</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2017-11-01</td>
<td class="org-left">236,914</td>
<td class="org-left">13,637</td>
<td class="org-left">13,637</td>
<td class="org-left">3,203</td>
<td class="org-right">0.014</td>
<td class="org-right">0.235</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">5</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2017-11-01</td>
<td class="org-left">236,914</td>
<td class="org-left">13,637</td>
<td class="org-left">13,637</td>
<td class="org-left">3,203</td>
<td class="org-right">0.014</td>
<td class="org-right">0.235</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">6</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2017-11-01</td>
<td class="org-left">236,914</td>
<td class="org-left">13,637</td>
<td class="org-left">13,637</td>
<td class="org-left">3,203</td>
<td class="org-right">0.014</td>
<td class="org-right">0.235</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">7</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2018-11-01</td>
<td class="org-left">246,585</td>
<td class="org-left">10,490</td>
<td class="org-left">10,490</td>
<td class="org-left">2,449</td>
<td class="org-right">0.010</td>
<td class="org-right">0.233</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">8</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2018-11-01</td>
<td class="org-left">246,585</td>
<td class="org-left">10,490</td>
<td class="org-left">10,490</td>
<td class="org-left">2,449</td>
<td class="org-right">0.010</td>
<td class="org-right">0.233</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">9</td>
<td class="org-right">2010-01-04</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2018-11-01</td>
<td class="org-left">246,585</td>
<td class="org-left">10,490</td>
<td class="org-left">10,490</td>
<td class="org-left">2,449</td>
<td class="org-right">0.010</td>
<td class="org-right">0.233</td>
</tr>
</tbody>
</table>

<p>
The columns <code>num_labeled_examples, num_labeled_above_threshold,
num_positive_labels</code> represent the number of selected entities on the
prediction date that are labeled, the
number of entities with a positive label above the threshold, and the
number of entities with positive labels among all the
labeled entities  respectively.
</p>
</div>
</div>

<div id="outline-container-orgb4556af" class="outline-4">
<h4 id="orgb4556af"><span class="section-number-4">5.3.2</span> Creating a simple experiment: ML as a Data Mining technique</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
For the first experiment we will try one of the simplest
machine learning algorithms: a <b>Decision Tree Classifier</b> (<i>DT</i>)
The rationale of this is that the DT is very fast to train (so it will
help us to verify that the experiment configuration is correct without
waiting for a long time) and it helps you
to understand the structure of your data.
</p>

<p>
The config file for this first experiment is located in
<a href="./triage/experiment_config/inspections_dt.yaml">./triage/experiment_config/inspections_dt.yaml</a>
</p>

<p>
Note that we don't modify the <code>temporal_config</code> section neither the
<code>feature_aggregations</code>, <code>cohort_config</code> or <code>label_config</code>. Triage is smart
enough to use the previous tables and matrices instead of generating
them from scratch.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">config_version</span>: <span style="color: #95e454;">'v6'</span>

<span style="color: #cae682;">model_comment</span>: <span style="color: #95e454;">'inspections: DT'</span>

<span style="color: #cae682;">user_metadata</span>:
  <span style="color: #cae682;">label_definition</span>: <span style="color: #95e454;">'failed'</span>
  <span style="color: #cae682;">experiment_type</span>: <span style="color: #95e454;">'inspections prioritization'</span>
  <span style="color: #cae682;">description</span>: |
    <span style="color: #95e454;">Decision Tree Classifier</span>
  <span style="color: #cae682;">purpose</span>: <span style="color: #95e454;">'data mining'</span>
  <span style="color: #cae682;">org</span>: <span style="color: #95e454;">'DSaPP'</span>
  <span style="color: #cae682;">team</span>: <span style="color: #95e454;">'Tutorial'</span>
  <span style="color: #cae682;">author</span>: <span style="color: #95e454;">'Your name here'</span>
  <span style="color: #cae682;">etl_date</span>: <span style="color: #95e454;">'2019-01-18'</span>

</pre>
</div>

<p>
Note that we don't modify the <code>temporal_config</code> section neither the
<code>cohort_config</code> or <code>label_config</code>. Triage is smart
enough to use the previous tables and matrices instead of generating
them from scratch.
</p>

<p>
For this experiment, we will add the following features:
</p>

<ul class="org-ul">
<li>Number of different types of inspections the facility had in the last year
(calculated for an as-of date).</li>

<li>Number of different types of inspections that happened in the
zip code in the last year from a particular day.</li>

<li>Number of inspections</li>

<li>Number/proportion of inspections by result type</li>

<li>Number/proportion of times that a facility was classify with particular risk level</li>
</ul>

<p>
In all of them we will do the aggregation in the last month, 3 months,
6 months, 1 year and historically. Remember
that all this refers to events in the past, i.e. <i>How many times the facility was marked with high risk in the previous 3 Months?</i>,
<i>What is the proportion of failed inspections in the previous year?</i>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">feature_aggregations</span>:
  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'inspections'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">aggregates_imputation</span>:
      <span style="color: #cae682;">count</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero_noflag'</span>

    <span style="color: #cae682;">aggregates</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        quantity</span>:
          <span style="color: #cae682;">total</span>: <span style="color: #95e454;">"*"</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'count'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>

  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'risks'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">categoricals_imputation</span>:
      <span style="color: #cae682;">sum</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero'</span>
      <span style="color: #cae682;">avg</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero'</span>

    <span style="color: #cae682;">categoricals</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        column</span>: <span style="color: #95e454;">'risk'</span>
        <span style="color: #cae682;">choices</span>: [<span style="color: #95e454;">'low'</span>, <span style="color: #95e454;">'medium'</span>, <span style="color: #95e454;">'high'</span>]
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'sum'</span>
          - <span style="color: #95e454;">'avg'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>
      - <span style="color: #95e454;">'zip_code'</span>

  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'results'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">categoricals_imputation</span>:
      <span style="color: #cae682;">all</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero'</span>

    <span style="color: #cae682;">categoricals</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        column</span>: <span style="color: #95e454;">'result'</span>
        <span style="color: #cae682;">choice_query</span>: <span style="color: #95e454;">'select distinct result from semantic.events'</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'sum'</span>
          - <span style="color: #95e454;">'avg'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>

  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'inspection_types'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">categoricals_imputation</span>:
      <span style="color: #cae682;">sum</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero_noflag'</span>

    <span style="color: #cae682;">categoricals</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        column</span>: <span style="color: #95e454;">'type'</span>
        <span style="color: #cae682;">choice_query</span>: <span style="color: #95e454;">'select distinct type from semantic.events where type is not null'</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'sum'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>
      - <span style="color: #95e454;">'zip_code'</span>

</pre>
</div>

<p>
And as stated, we will train some Decision Trees
</p>


<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">grid_config</span>:
    <span style="color: #95e454;">'sklearn.tree.DecisionTreeClassifier'</span>:
        <span style="color: #cae682;">max_depth</span>: [2,10,~]
        <span style="color: #cae682;">min_samples_split</span>: [2,5]
</pre>
</div>

<p>
Some of the parameters in <code>sklearn</code> are <code>None</code>. If you want to try those
you need to indicate it with <code>yaml</code>'s <code>null</code> or <code>~</code> keyword.
</p>

<p>
Besides the algorithm and the hyperparameters, you should specify
which subset of features use. First, in the section
<code>feature_group_definition</code> you specify how to group the features (you
can use the <code>table name</code> or the <code>prefix</code> from the section
<code>feature_aggregation</code>) and then a <i>strategy</i> for choosing the
subsets: <code>all</code> (all the subsets at once), <code>leave-one-out</code> (try all the
subsets except one, do that for all the combinations), or <code>leave-one-in</code>
(just try subset at the time).
</p>


<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">feature_group_definition</span>:
   <span style="color: #cae682;">prefix</span>:
     - <span style="color: #95e454;">'inspections'</span>
     - <span style="color: #95e454;">'results'</span>
     - <span style="color: #95e454;">'risks'</span>
     - <span style="color: #95e454;">'inspection_types'</span>

<span style="color: #cae682;">feature_group_strategies</span>: [<span style="color: #95e454;">'all'</span>]
</pre>
</div>

<p>
Finally we will leave the <code>scoring</code> section as before.
</p>

<p>
In this experiment we will end with <b>5</b> model groups
(number of algorithms [1] \(\times\) number of hyperparameter combinations [2
\(\times\) 3 = 5] \(\times\) number of feature groups strategies [1]]). Also, we will create <b>15</b> models (3 per
model group) given that we have 3 temporal blocks (one model per temporal group).
</p>

<p>
Before running the experiment, remember to validate that the
configuration is correct:
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/inspections_dt.yaml  --validate-only
</pre>
</div>

<p>
and check the temporal cross validation:
</p>


<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage showtimechops experiment_config/inspections_dt.yaml
</pre>
</div>


<div class="figure">
<p><img src="./images/inspections_dt.png" alt="inspections_dt.png" width="800" height="800" />
</p>
<p><span class="figure-number">Figure 15: </span>Temporal blocks for inspections experiment. The label is a failed inspection in the next month.</p>
</div>


<p>
You can execute the experiment like this:
</p>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/inspections_dt.yaml --no-save-predictions --profile
</pre>
</div>


<p>
After the experiment finishes, you will get <b>5</b> new <code>model_groups</code> (1 per
combination in <code>grid_config</code>)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    model_group_id,
    model_type,
    hyperparameters
<span style="color: #8ac6f2;">from</span>
    model_metadata.model_groups
<span style="color: #8ac6f2;">where</span>
    model_group_id <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>1,2,3<span style="color: #8c8c8c;">)</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">model<sub>type</sub></th>
<th scope="col" class="org-left">hyperparameters</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">4</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2, "min<sub>samples</sub><sub>split</sub>": 2}</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2, "min<sub>samples</sub><sub>split</sub>": 5}</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 10, "min<sub>samples</sub><sub>split</sub>": 2}</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 10, "min<sub>samples</sub><sub>split</sub>": 5}</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null, "min<sub>samples</sub><sub>split</sub>": 2}</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null, "min<sub>samples</sub><sub>split</sub>": 5}</td>
</tr>
</tbody>
</table>

<p>
and <b>15</b> models
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span>
    model_group_id,
    array_agg<span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> models,
    array_agg<span style="color: #8c8c8c;">(</span>train_end_time<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> train_end_times
<span style="color: #8ac6f2;">from</span>
    model_metadata.models
<span style="color: #8ac6f2;">where</span>
    model_group_id <span style="color: #8ac6f2;">not</span> <span style="color: #8ac6f2;">in</span> <span style="color: #8c8c8c;">(</span>1,2,3<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    model_group_id
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    model_group_id;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">models</th>
<th scope="col" class="org-left">train<sub>end</sub><sub>times</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">4</td>
<td class="org-left">{10,16,22}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">{11,17,23}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">{12,18,24}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">{13,19,25}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">{14,20,26}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">{15,21,27}</td>
<td class="org-left">{"2015-12-01 00:00:00","2016-12-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
</tbody>
</table>

<p>
Let's see the performance of the new models:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">select</span> <span style="color: #8ac6f2;">distinct</span> <span style="color: #8ac6f2;">on</span> <span style="color: #8c8c8c;">(</span>train_end_time<span style="color: #8c8c8c;">)</span>
    model_group_id,
    model_id,
    train_end_time::<span style="color: #92a65e;">date</span>,
    ev.evaluation_start_time::<span style="color: #92a65e;">date</span>,
    ev.evaluation_end_time::<span style="color: #92a65e;">date</span>,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_labeled_examples, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> labeled_examples,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_labeled_above_threshold, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> labeled_above_threshold,
    to_char<span style="color: #8c8c8c;">(</span>ev.num_positive_labels, <span style="color: #95e454;">'999,999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> total_positive_labels,
    to_char<span style="color: #8c8c8c;">(</span>ev.<span style="color: #8ac6f2;">value</span>, <span style="color: #95e454;">'0.999'</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> "<span style="color: #92a65e;">precision</span>@10%"
<span style="color: #8ac6f2;">from</span>
    model_metadata.models <span style="color: #8ac6f2;">as</span> mo
    <span style="color: #8ac6f2;">join</span>
    test_results.evaluations <span style="color: #8ac6f2;">as</span> ev <span style="color: #8ac6f2;">using</span><span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">where</span>
    ev.metric || ev.<span style="color: #8ac6f2;">parameter</span> = <span style="color: #95e454;">'precision@10_pct'</span>
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    train_end_time <span style="color: #8ac6f2;">asc</span>, ev.<span style="color: #8ac6f2;">value</span> <span style="color: #8ac6f2;">desc</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-right">model<sub>id</sub></th>
<th scope="col" class="org-right">train<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-right">evaluation<sub>start</sub><sub>time</sub></th>
<th scope="col" class="org-right">evaluation<sub>end</sub><sub>time</sub></th>
<th scope="col" class="org-left">labeled<sub>examples</sub></th>
<th scope="col" class="org-left">labeled<sub>above</sub><sub>threshold</sub></th>
<th scope="col" class="org-left">total<sub>positive</sub><sub>labels</sub></th>
<th scope="col" class="org-right">precision@10%</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">5</td>
<td class="org-right">11</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2015-12-01</td>
<td class="org-right">2016-11-01</td>
<td class="org-left">14,273</td>
<td class="org-left">2,014</td>
<td class="org-left">3,460</td>
<td class="org-right">0.336</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">19</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2016-12-01</td>
<td class="org-right">2017-11-01</td>
<td class="org-left">13,637</td>
<td class="org-left">1,675</td>
<td class="org-left">3,203</td>
<td class="org-right">0.331</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">24</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2017-12-01</td>
<td class="org-right">2018-11-01</td>
<td class="org-left">10,490</td>
<td class="org-left">1,254</td>
<td class="org-left">2,449</td>
<td class="org-right">0.344</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-orgc8a4ee7" class="outline-4">
<h4 id="orgc8a4ee7"><span class="section-number-4">5.3.3</span> A more advanced experiment</h4>
<div class="outline-text-4" id="text-5-3-3">
<p>
Ok, let's add a more complete experiment. First the usual generalities.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">config_version</span>: <span style="color: #95e454;">'v6'</span>

<span style="color: #cae682;">model_comment</span>: <span style="color: #95e454;">'inspections: advanced'</span>

<span style="color: #cae682;">user_metadata</span>:
  <span style="color: #cae682;">label_definition</span>: <span style="color: #95e454;">'failed'</span>
  <span style="color: #cae682;">experiment_type</span>: <span style="color: #95e454;">'inspections prioritization'</span>
  <span style="color: #cae682;">description</span>: |
    <span style="color: #95e454;">Using Ensamble methods</span>
  <span style="color: #cae682;">purpose</span>: <span style="color: #95e454;">'trying ensamble algorithms'</span>
  <span style="color: #cae682;">org</span>: <span style="color: #95e454;">'DSaPP'</span>
  <span style="color: #cae682;">team</span>: <span style="color: #95e454;">'Tutorial'</span>
  <span style="color: #cae682;">author</span>: <span style="color: #95e454;">'Your name here'</span>
  <span style="color: #cae682;">etl_date</span>: <span style="color: #95e454;">'2019-01-18'</span>
</pre>
</div>

<p>
We won't change anything related to features, cohort and label
definition neither to temporal configuration.
</p>

<p>
As before, we can check the temporal structure of our crossvalidation:
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage showtimechops experiment_config/inspections_label_failed_01.yaml
</pre>
</div>


<div class="figure">
<p><img src="./images/inspections_label_failed_01.png" alt="inspections_label_failed_01.png" width="800" height="800" />
</p>
<p><span class="figure-number">Figure 16: </span>Temporal blocks for inspections experiment. The label is a failed inspection in the next month.</p>
</div>


<p>
We want to use all the features groups
(<code>feature_group_definition</code>). The training will be made on matrices
with <code>all</code> the feature groups, then leaving one feature group out at a time,
<code>leave-one-out</code> (i.e. one model with <code>inspections</code> and <code>results</code>, another with
<code>inspections</code> and <code>risks</code>, and another with <code>results</code> and <code>risks), and finally
leaving one feature group in at a time (i.e. a model with =inspections</code> only,
another with <code>results</code> only, and a third with <code>risks</code> only).
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">feature_group_definition</span>:
   <span style="color: #cae682;">prefix</span>:
     - <span style="color: #95e454;">'inspections'</span>
     - <span style="color: #95e454;">'results'</span>
     - <span style="color: #95e454;">'risks'</span>
     - <span style="color: #95e454;">'inspection_types'</span>

<span style="color: #cae682;">feature_group_strategies</span>: [<span style="color: #95e454;">'all'</span>, <span style="color: #95e454;">'leave-one-in'</span>, <span style="color: #95e454;">'leave-one-out'</span>]
</pre>
</div>

<p>
Finally, we will try some <code>RandomForestClassifier</code>:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">grid_config</span>:
    <span style="color: #95e454;">'sklearn.ensemble.RandomForestClassifier'</span>:
        <span style="color: #cae682;">max_features</span>: [<span style="color: #95e454;">'sqrt'</span>]
        <span style="color: #cae682;">criterion</span>: [<span style="color: #95e454;">'gini'</span>]
        <span style="color: #cae682;">n_estimators</span>: [100, 250]
        <span style="color: #cae682;">min_samples_split</span>: [2,10]

<span style="color: #cae682;">scoring</span>:
    <span style="color: #cae682;">testing_metric_groups</span>:
        <span style="color: #cae682;">-</span>
<span style="color: #cae682;">          metrics</span>: [precision@, recall@]
          <span style="color: #cae682;">thresholds</span>:
            <span style="color: #cae682;">percentiles</span>: [1.0, 2.0, 3.0, 4.0, 5.0, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]
            <span style="color: #cae682;">top_n</span>: [1, 5, 10, 25, 50, 100, 250, 500, 1000]

    <span style="color: #cae682;">training_metric_groups</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        metrics</span>: [accuracy]
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        metrics</span>: [precision@, recall@]
        <span style="color: #cae682;">thresholds</span>:
          <span style="color: #cae682;">percentiles</span>: [1.0, 2.0, 3.0, 4.0, 5.0, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]
          <span style="color: #cae682;">top_n</span>: [1, 5, 10, 25, 50, 100, 250, 500, 1000]

</pre>
</div>

<p>
Before running, let's verify the configuration file
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/inspections_label_failed_01.yaml  --validate-only
</pre>
</div>

<p>
You can execute the experiment with
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/inspections_label_failed_01.yaml --no-save-predictions --profile
</pre>
</div>

<p>
This will take a looooong time to run.
</p>

<p>
Well, now we have a lot of models. How can you pick the best one?
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org518c064" class="outline-2">
<h2 id="org518c064"><span class="section-number-2">6</span> An Early Intervention System</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgcb51c06" class="outline-3">
<h3 id="orgcb51c06"><span class="section-number-3">6.1</span> Problem description</h3>
<div class="outline-text-3" id="text-6-1">
<p>
<code>triage</code> is designed to also build early warning systems (also called early intervention, EIS).
While there are  several differences between modeling early warnings and inspection
 prioritization, perhaps the biggest is that  the <i>entity</i> is active
(i.e. it is doing stuff for which
 an outcome will happen) in EIS but passive (i.e. inspected)
 in <b>inspection prioritization</b>. Among other things, this difference
affects the way the <i>outcome</i> is built.
</p>

<p>
Here's the question we want to answer:
</p>

<blockquote>
<p>
Will my restaurant be inspected in the
<i>next X period of time?</i>
</p>
</blockquote>

<p>
Where \(X\) could be 3 days, 2 months, 1 year,
etc.
</p>

<p>
Knowing the answer to this question enables you (as the restaurant
owner or manager) to prepare for the inspection.
</p>
</div>
</div>


<div id="outline-container-orgbabbf25" class="outline-3">
<h3 id="orgbabbf25"><span class="section-number-3">6.2</span> What are the labels? What are the outcomes?</h3>
<div class="outline-text-3" id="text-6-2">
<p>
The trick to note is that on any given day there are two possible outcomes:
<i>the facility was inspected</i> and <i>the facility wasn't inspected</i>.
Our <i>outcomes</i> table will be larger than in the inspection prioritization example
because we need an <i>outcome</i> for every <i>active</i> facility on every date.
The following image tries to exemplify this reasoning:
</p>



<div id="org0ac6073" class="figure">
<p><img src="./images/outcomes-eis.png" alt="outcomes-eis.png" width="600" height="400" />
</p>
<p><span class="figure-number">Figure 17: </span>The image shows three facilities, and next to each, a temporal line with 6 days (0-5). Each dot represents the event (whether an inspection happened). Yellow means the inspection happened (<code>TRUE</code> outcome) and blue means it didn't (<code>FALSE</code> outcome). Each facility in the image had two inspections, six in total.</p>
</div>

<p>
Fortunately, <code>triage</code> will help us to create this table. The <i>cohort</i>
table is the same as the <i>cohort</i> table in the inspection case.
</p>


<p>
First the usual stuff. Note that we are changing <code>model_comment</code> and
<code>label_definition</code> (remember that this is used for generating the
<i>hash</i> that differentiates models and model groups).
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">config_version</span>: <span style="color: #95e454;">'v6'</span>

<span style="color: #cae682;">model_comment</span>: <span style="color: #95e454;">'eis: 01'</span>

<span style="color: #cae682;">user_metadata</span>:
  <span style="color: #cae682;">label_definition</span>: <span style="color: #95e454;">'inspected'</span>
  <span style="color: #cae682;">experiment_type</span>: <span style="color: #95e454;">'eis'</span>
  <span style="color: #cae682;">description</span>: |
    <span style="color: #95e454;">EIS 01</span>
  <span style="color: #cae682;">purpose</span>: <span style="color: #95e454;">'model creation'</span>
  <span style="color: #cae682;">org</span>: <span style="color: #95e454;">'DSaPP'</span>
  <span style="color: #cae682;">team</span>: <span style="color: #95e454;">'Tutorial'</span>
  <span style="color: #cae682;">author</span>: <span style="color: #95e454;">'Your name here'</span>
  <span style="color: #cae682;">etl_date</span>: <span style="color: #95e454;">'2019-01-18'</span>

<span style="color: #cae682;">model_group_keys</span>:
  - <span style="color: #95e454;">'class_path'</span>
  - <span style="color: #95e454;">'parameters'</span>
  - <span style="color: #95e454;">'feature_names'</span>
  - <span style="color: #95e454;">'feature_groups'</span>
  - <span style="color: #95e454;">'cohort_name'</span>
  - <span style="color: #95e454;">'state'</span>
  - <span style="color: #95e454;">'label_name'</span>
  - <span style="color: #95e454;">'label_timespan'</span>
  - <span style="color: #95e454;">'training_as_of_date_frequency'</span>
  - <span style="color: #95e454;">'max_training_history'</span>
  - <span style="color: #95e454;">'label_definition'</span>
  - <span style="color: #95e454;">'experiment_type'</span>
  - <span style="color: #95e454;">'org'</span>
  - <span style="color: #95e454;">'team'</span>
  - <span style="color: #95e454;">'author'</span>
  - <span style="color: #95e454;">'purpose'</span>
  - <span style="color: #95e454;">'etl_date'</span>

</pre>
</div>

<p>
For the labels the query is pretty simple, if the facility showed in
the data, it will get a <i>positive</i> outcome, if not they will get a <i>negative</i> outcome
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">label_config</span>:
  <span style="color: #cae682;">query</span>: |
    <span style="color: #95e454;">select</span>
<span style="color: #95e454;">    entity_id,</span>
<span style="color: #95e454;">    True::integer as outcome</span>
<span style="color: #95e454;">    from semantic.events</span>
    where <span style="color: #95e454;">'{as_of_date}'</span>::timestamp &lt;= date
    and date &lt; <span style="color: #95e454;">'{as_of_date}'</span>::timestamp + interval <span style="color: #95e454;">'{label_timespan}'</span>
<span style="color: #95e454;">    group by entity_id</span>
  <span style="color: #cae682;">include_missing_labels_in_train_as</span>: <span style="color: #e5786d;">False</span>
  <span style="color: #cae682;">name</span>: <span style="color: #95e454;">'inspected'</span>
</pre>
</div>

<p>
Note the two introduced changes in this block, first, the <i>outcome</i> is
<code>True</code> , because all our observations represent <i>inspected</i> facilities
(see discussion above and in particular previous image), second, we
added the line <code>include_missing_labels_in_train_as: False</code>. This line
tells <code>triage</code> to incorporate all the missing facilities with <code>False</code>  as
the <i>outcome</i>.
</p>

<p>
As stated we will use the same configuration block for <i>cohorts</i> that we
used in inspections:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">cohort_config</span>:
  <span style="color: #cae682;">query</span>: |
    <span style="color: #95e454;">select entity_id</span>
<span style="color: #95e454;">    from semantic.entities</span>
<span style="color: #95e454;">    where</span>
    daterange(start_time, end_time, <span style="color: #95e454;">'[]'</span>) @&gt; <span style="color: #95e454;">'{as_of_date}'</span>::date
  <span style="color: #cae682;">name</span>: <span style="color: #95e454;">'active_facilities'</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org3ab6030" class="outline-3">
<h3 id="org3ab6030"><span class="section-number-3">6.3</span> Modeling Using Machine Learning</h3>
<div class="outline-text-3" id="text-6-3">
<p>
We need to specify the temporal configuration too
</p>
</div>

<ol class="org-ol">
<li><a id="orgf51088b"></a>Temporal configuration<br />
<div class="outline-text-5" id="text-6-3-0-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">temporal_config</span>:
    <span style="color: #cae682;">feature_start_time</span>: <span style="color: #95e454;">'2010-01-04'</span>
    <span style="color: #cae682;">feature_end_time</span>: <span style="color: #95e454;">'2019-01-01'</span>
    <span style="color: #cae682;">label_start_time</span>: <span style="color: #95e454;">'2015-02-01'</span>
    <span style="color: #cae682;">label_end_time</span>: <span style="color: #95e454;">'2019-01-01'</span>

    <span style="color: #cae682;">model_update_frequency</span>: <span style="color: #95e454;">'1y'</span>
    <span style="color: #cae682;">training_label_timespans</span>: [<span style="color: #95e454;">'1month'</span>]
    <span style="color: #cae682;">training_as_of_date_frequencies</span>: <span style="color: #95e454;">'1month'</span>

    <span style="color: #cae682;">test_durations</span>: <span style="color: #95e454;">'1y'</span>
    <span style="color: #cae682;">test_label_timespans</span>: [<span style="color: #95e454;">'1month'</span>]
    <span style="color: #cae682;">test_as_of_date_frequencies</span>: <span style="color: #95e454;">'1month'</span>

    <span style="color: #cae682;">max_training_histories</span>: <span style="color: #95e454;">'5y'</span>
</pre>
</div>


<p>
As before, you can generate the image of the temporal blocks:
</p>


<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage showtimechops experiment_config/eis_01.yaml
</pre>
</div>



<div class="figure">
<p><img src="./images/eis_01.png" alt="eis_01.png" width="600" height="600" />
</p>
<p><span class="figure-number">Figure 18: </span>Temporal blocks for the Early Warning System. We want to predict the most likely facilities to be inspected in the following month.</p>
</div>
</div>
</li>

<li><a id="org814e2a1"></a>Features<br />
<div class="outline-text-5" id="text-6-3-0-2">
<p>
Regarding the features, we will use the same ones that were used in <a href="inspections.html">inspections prioritization</a>:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">feature_aggregations</span>:
  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'inspections'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">aggregates_imputation</span>:
      <span style="color: #cae682;">count</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero_noflag'</span>

    <span style="color: #cae682;">aggregates</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        quantity</span>:
          <span style="color: #cae682;">total</span>: <span style="color: #95e454;">"*"</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'count'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>

  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'risks'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">categoricals_imputation</span>:
      <span style="color: #cae682;">sum</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero'</span>
      <span style="color: #cae682;">avg</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero'</span>

    <span style="color: #cae682;">categoricals</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        column</span>: <span style="color: #95e454;">'risk'</span>
        <span style="color: #cae682;">choices</span>: [<span style="color: #95e454;">'low'</span>, <span style="color: #95e454;">'medium'</span>, <span style="color: #95e454;">'high'</span>]
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'sum'</span>
          - <span style="color: #95e454;">'avg'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>
      - <span style="color: #95e454;">'zip_code'</span>

  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'results'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">categoricals_imputation</span>:
      <span style="color: #cae682;">all</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero'</span>

    <span style="color: #cae682;">categoricals</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        column</span>: <span style="color: #95e454;">'result'</span>
        <span style="color: #cae682;">choice_query</span>: <span style="color: #95e454;">'select distinct result from semantic.events'</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'sum'</span>
          - <span style="color: #95e454;">'avg'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>

  <span style="color: #cae682;">-</span>
<span style="color: #cae682;">    prefix</span>: <span style="color: #95e454;">'inspection_types'</span>
    <span style="color: #cae682;">from_obj</span>: <span style="color: #95e454;">'semantic.events'</span>
    <span style="color: #cae682;">knowledge_date_column</span>: <span style="color: #95e454;">'date'</span>

    <span style="color: #cae682;">categoricals_imputation</span>:
      <span style="color: #cae682;">sum</span>:
        <span style="color: #cae682;">type</span>: <span style="color: #95e454;">'zero_noflag'</span>

    <span style="color: #cae682;">categoricals</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        column</span>: <span style="color: #95e454;">'type'</span>
        <span style="color: #cae682;">choice_query</span>: <span style="color: #95e454;">'select distinct type from semantic.events where type is not null'</span>
        <span style="color: #cae682;">metrics</span>:
          - <span style="color: #95e454;">'sum'</span>

    <span style="color: #cae682;">intervals</span>: [<span style="color: #95e454;">'1month'</span>, <span style="color: #95e454;">'3month'</span>, <span style="color: #95e454;">'6month'</span>, <span style="color: #95e454;">'1y'</span>, <span style="color: #95e454;">'all'</span>]

    <span style="color: #cae682;">groups</span>:
      - <span style="color: #95e454;">'entity_id'</span>
      - <span style="color: #95e454;">'zip_code'</span>

<span style="color: #cae682;">grid_config</span>:
    <span style="color: #95e454;">'sklearn.tree.DecisionTreeClassifier'</span>:
        <span style="color: #cae682;">max_depth</span>: [2,10,~]
        <span style="color: #cae682;">min_samples_split</span>: [2,5]


</pre>
</div>

<p>
We declare that we want to use all possible feature-group combinations for training:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">feature_group_definition</span>:
   <span style="color: #cae682;">prefix</span>:
     - <span style="color: #95e454;">'inspections'</span>
     - <span style="color: #95e454;">'results'</span>
     - <span style="color: #95e454;">'risks'</span>
     - <span style="color: #95e454;">'inspection_types'</span>

<span style="color: #cae682;">feature_group_strategies</span>: [<span style="color: #95e454;">'all'</span>, <span style="color: #95e454;">'leave-one-out'</span>]
</pre>
</div>

<p>
i.e. <code>all</code> will train models with all the features groups,
<code>leave-one-in</code> will use only one of the feature groups for traning, and
lastly, <code>leave-one-out</code> will train the model with all the features
except one.
</p>
</div>
</li>

<li><a id="orge559e06"></a>Algorithm and hyperparameters<br />
<div class="outline-text-5" id="text-6-3-0-3">
<p>
We will collapse the baseline (<code>DummyClassifier</code>) and the exploratory configuration together:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">grid_config</span>:
    <span style="color: #95e454;">'sklearn.tree.DecisionTreeClassifier'</span>:
        <span style="color: #cae682;">max_depth</span>: [2,null]
    <span style="color: #95e454;">'sklearn.ensemble.RandomForestClassifier'</span>:
        <span style="color: #cae682;">max_features</span>: [<span style="color: #95e454;">'sqrt'</span>]
        <span style="color: #cae682;">criterion</span>: [<span style="color: #95e454;">'gini'</span>]
        <span style="color: #cae682;">n_estimators</span>: [250]
        <span style="color: #cae682;">min_samples_leaf</span>: [1]
        <span style="color: #cae682;">min_samples_split</span>: [50]
    <span style="color: #95e454;">'sklearn.dummy.DummyClassifier'</span>:
        <span style="color: #cae682;">strategy</span>: [most_frequent]
</pre>
</div>

<p>
<code>triage</code> will create <b>20</b> <i>model groups</i>: <b>4</b> algorithms and
hyperparameters (2 <code>DecisionTreeClassifier</code>, 1
<code>RandomForestClassifier</code>, 1 <code>DummyClassifier</code>) &times; <b>5</b> features groups (1
<code>all</code>, 4 <code>leave-one-out</code>). The total number of <i>models</i>
is triple that (we have 3 time blocks, so <b>60</b>).
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #cae682;">scoring</span>:
    <span style="color: #cae682;">testing_metric_groups</span>:
        <span style="color: #cae682;">-</span>
<span style="color: #cae682;">          metrics</span>: [precision@, recall@]
          <span style="color: #cae682;">thresholds</span>:
            <span style="color: #cae682;">percentiles</span>: [1.0, 2.0, 3.0, 4.0, 5.0, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]
            <span style="color: #cae682;">top_n</span>: [1, 5, 10, 25, 50, 100, 250, 500, 1000]


    <span style="color: #cae682;">training_metric_groups</span>:
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        metrics</span>: [accuracy]
      <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        metrics</span>: [precision@, recall@]
        <span style="color: #cae682;">thresholds</span>:
          <span style="color: #cae682;">percentiles</span>: [1.0, 2.0, 3.0, 4.0, 5.0, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]
          <span style="color: #cae682;">top_n</span>: [1, 5, 10, 25, 50, 100, 250, 500, 1000]

</pre>
</div>

<p>
As a last step, we validate that the configuration file is correct:
</p>


<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/eis_01.yaml  --validate-only
</pre>
</div>


<p>
And then just run it:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #99968b;"># </span><span style="color: #99968b;">Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiment_config/eis_01.yaml --profile
</pre>
</div>

<p>
This will take a <b>lot</b> amount of time (on my computer took 3h 42m),
so, grab your coffee, chat with
your coworkers, check your email, or read the <a href="https://dssg.uchicago.edu/blog">DSSG blog</a>.
It's taking that long for several reasons:
</p>

<ol class="org-ol">
<li>There are a lot of models, parameters, etc.</li>
<li>We are running in serial mode (i.e. not in parallel).</li>
<li>The database is running on your laptop.</li>
</ol>

<p>
You can solve 2 and 3. For the second point you could use the <code>docker</code>
container that has the multicore option enabled. For 3, I recommed you
to use a PostgreSQL database in the cloud, such as Amazon's
<b>PostgreSQL RDS</b> (we will explore this later in running triage in AWS Batch).
</p>

<p>
After the experiment finishes, we can create the following table:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8ac6f2;">with</span> features_groups <span style="color: #8ac6f2;">as</span> <span style="color: #8c8c8c;">(</span>
<span style="color: #8ac6f2;">select</span>
    model_group_id,
    split_part<span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">unnest</span><span style="color: #b0b1a3;">(</span>feature_list<span style="color: #b0b1a3;">)</span>, <span style="color: #95e454;">'_'</span>, 1<span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> feature_groups
<span style="color: #8ac6f2;">from</span>
    model_metadata.model_groups
<span style="color: #8c8c8c;">)</span>,

features_arrays <span style="color: #8ac6f2;">as</span> <span style="color: #8c8c8c;">(</span>
<span style="color: #8ac6f2;">select</span>
    model_group_id,
    array_agg<span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">distinct</span> feature_groups<span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">as</span> feature_groups
<span style="color: #8ac6f2;">from</span>
    features_groups
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    model_group_id
<span style="color: #8c8c8c;">)</span>

<span style="color: #8ac6f2;">select</span>
    model_group_id,
    model_type,
    hyperparameters,
    feature_groups,
    array_agg<span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> models,
    array_agg<span style="color: #8c8c8c;">(</span>train_end_time::<span style="color: #92a65e;">date</span> <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> train_end_time <span style="color: #8ac6f2;">asc</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> times,
    array_agg<span style="color: #8c8c8c;">(</span>to_char<span style="color: #93a8c6;">(</span><span style="color: #8ac6f2;">value</span>, <span style="color: #95e454;">'0.999'</span><span style="color: #93a8c6;">)</span> <span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span> train_end_time <span style="color: #8ac6f2;">asc</span><span style="color: #8c8c8c;">)</span> <span style="color: #8ac6f2;">as</span> "<span style="color: #92a65e;">precision</span>@5%"
<span style="color: #8ac6f2;">from</span>
    model_metadata.models
    <span style="color: #8ac6f2;">join</span>
    features_arrays <span style="color: #8ac6f2;">using</span><span style="color: #8c8c8c;">(</span>model_group_id<span style="color: #8c8c8c;">)</span>
    <span style="color: #8ac6f2;">join</span>
    test_results.evaluations <span style="color: #8ac6f2;">using</span><span style="color: #8c8c8c;">(</span>model_id<span style="color: #8c8c8c;">)</span>
<span style="color: #8ac6f2;">where</span>
    model_comment ~ <span style="color: #95e454;">'eis'</span>
    <span style="color: #8ac6f2;">and</span>
    metric || <span style="color: #8ac6f2;">parameter</span> = <span style="color: #95e454;">'precision@5.0_pct'</span>
<span style="color: #8ac6f2;">group</span> <span style="color: #8ac6f2;">by</span>
    model_group_id,
    model_type,
    hyperparameters,
    feature_groups
<span style="color: #8ac6f2;">order</span> <span style="color: #8ac6f2;">by</span>
    model_group_id;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model<sub>group</sub><sub>id</sub></th>
<th scope="col" class="org-left">model<sub>type</sub></th>
<th scope="col" class="org-left">hyperparameters</th>
<th scope="col" class="org-left">feature<sub>groups</sub></th>
<th scope="col" class="org-left">models</th>
<th scope="col" class="org-left">times</th>
<th scope="col" class="org-left">precision@5%</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">10</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2}</td>
<td class="org-left">{inspection,inspections,results,risks}</td>
<td class="org-left">{28}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.171"}</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null}</td>
<td class="org-left">{inspection,inspections,results,risks}</td>
<td class="org-left">{29}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.179"}</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 1000, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td class="org-left">{inspection,inspections,results,risks}</td>
<td class="org-left">{30}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.316"}</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">{inspection,inspections,results,risks}</td>
<td class="org-left">{31}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.063"}</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{32}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.102"}</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{33}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.116"}</td>
</tr>

<tr>
<td class="org-right">16</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 1000, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{34}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.116"}</td>
</tr>

<tr>
<td class="org-right">17</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{35}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.063"}</td>
</tr>

<tr>
<td class="org-right">18</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2}</td>
<td class="org-left">{results}</td>
<td class="org-left">{36}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.172"}</td>
</tr>

<tr>
<td class="org-right">19</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null}</td>
<td class="org-left">{results}</td>
<td class="org-left">{37}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.232"}</td>
</tr>

<tr>
<td class="org-right">20</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 1000, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td class="org-left">{results}</td>
<td class="org-left">{38}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.267"}</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">{results}</td>
<td class="org-left">{39}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.063"}</td>
</tr>

<tr>
<td class="org-right">22</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{40}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.164"}</td>
</tr>

<tr>
<td class="org-right">23</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{41}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.126"}</td>
</tr>

<tr>
<td class="org-right">24</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 1000, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{42}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.226"}</td>
</tr>

<tr>
<td class="org-right">25</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{43}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.063"}</td>
</tr>

<tr>
<td class="org-right">26</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2}</td>
<td class="org-left">{inspection}</td>
<td class="org-left">{44}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.152"}</td>
</tr>

<tr>
<td class="org-right">27</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null}</td>
<td class="org-left">{inspection}</td>
<td class="org-left">{45}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.135"}</td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 1000, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td class="org-left">{inspection}</td>
<td class="org-left">{46}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.213"}</td>
</tr>

<tr>
<td class="org-right">29</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">{inspection}</td>
<td class="org-left">{47}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.063"}</td>
</tr>

<tr>
<td class="org-right">30</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": 2}</td>
<td class="org-left">{inspection,results,risks}</td>
<td class="org-left">{48}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.172"}</td>
</tr>

<tr>
<td class="org-right">31</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max<sub>depth</sub>": null}</td>
<td class="org-left">{inspection,results,risks}</td>
<td class="org-left">{49}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.175"}</td>
</tr>

<tr>
<td class="org-right">32</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "max<sub>features</sub>": "sqrt", "n<sub>estimators</sub>": 1000, "min<sub>samples</sub><sub>leaf</sub>": 1, "min<sub>samples</sub><sub>split</sub>": 50}</td>
<td class="org-left">{inspection,results,risks}</td>
<td class="org-left">{50}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.315"}</td>
</tr>

<tr>
<td class="org-right">33</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most<sub>frequent</sub>"}</td>
<td class="org-left">{inspection,results,risks}</td>
<td class="org-left">{51}</td>
<td class="org-left">{2015-12-01}</td>
<td class="org-left">{" 0.063"}</td>
</tr>
</tbody>
</table>
</div>
</li>
</ol>
</div>
</div>


<div id="outline-container-org1f18376" class="outline-2">
<h2 id="org1f18376"><span class="section-number-2">7</span> <span class="todo TODO">TODO</span> Audition: How can I pick the best one?</h2>
<div class="outline-text-2" id="text-7">
<p>
Now you have <b>42</b> <i>model groups</i>. Which is best? Which should you choose to
use? This is not as easy as it sounds, due to several factors:
</p>

<ul class="org-ul">
<li>You can try to pick the best using a metric
specified in the config file (<code>precision@</code> and <code>recall@</code>),
but at what point of time? Maybe different model groups are best
at different prediction times.</li>
<li>You can just use the one that performs best on the last test set.</li>
<li>You can value a model group that provides consistent results over time.
It might not be the best on any test set, but you can feel more
confident that it will continue to perform similarly.</li>
<li>If there are several model groups that perform similarly and
their lists are more or less similar, maybe it doesn't really
matter which you pick.</li>
</ul>

<p>
<code>triage</code> provides this functionality in <code>audition</code> and in
<code>postmodel</code>. At the moment of this writing, these two modules require
more interaction (i.e. they aren't integrated with the <i>configuration
file</i>).
</p>

<p>
<code>Audition</code> formalizes this idea through <i>selection rules</i> that take in
the data up to a given point in time, apply some rule to choose a
model group, and then evaluate the performance (<b>regret</b>) of the chosen
model group in the subsequent time window.
</p>

<p>
<code>Audition</code> predefines 7 rules:
</p>

<ol class="org-ol">
<li><code>best_current_value</code> :: Pick the model group with the best current metric Value.</li>
<li><code>best_average_value</code> :: Pick the model with the highest average metric value so far.</li>
<li><code>lowest_metric_variance</code> :: Pick the model with the lowest metric variance so far.</li>
<li><code>most_frequent_best_dist</code> :: Pick the model that is most frequently
within <code>dist_from_best_case</code> from the best-performing model group
across test sets so far.</li>
<li><code>best_average_two_metrics</code> :: Pick the model with the highest
average combined value to date of two metrics weighted together
using <code>metric1_weight</code>.</li>
<li><code>best_avg_var_penalized</code> :: Pick the model with the highest average
metric value so far, penalized for relative variance ss:
<code>avg_value - (stdev_penalty) * (stdev - min_stdev)</code> where
<code>min_stdev</code> is the minimum standard deviation of the metric
across all model groups</li>
<li><code>best_avg_recency_weight</code> :: Pick the model with the highest
average metric value so far, penalized for relative variance as:
<code>avg_value - (stdev_penalty) * (stdev - min_stdev)</code> where
<code>min_stdev</code> is the minimum standard deviation of the metric
across all  model groups</li>
</ol>

<p>
We included a simple configuration file with some rules:
</p>

<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #99968b;"># </span><span style="color: #99968b;">CHOOSE MODEL GROUPS</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">Audition needs a bunch of model_group_ids to help you select the models.</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">The query is to choose what the model groups you want to include in the first round.</span>
<span style="color: #cae682;">model_groups</span>:
    <span style="color: #cae682;">query</span>: |
        <span style="color: #95e454;">SELECT DISTINCT(model_group_id)</span>
<span style="color: #95e454;">        FROM results.model_groups</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">CHOOSE TIMESTAMPS/TRAIN END TIMES</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">The timestamps when audition happens for each model group.</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">There's a hard rule in Audition that all of the chosen model groups for audition should</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">have the same train end times as the timestamps or the subset of the timestamps from this</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">query, otherwise those model groups with unmatched train end times will be pruned in the</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">first round.</span>
<span style="color: #cae682;">time_stamps</span>:
    <span style="color: #cae682;">query</span>: |
        <span style="color: #95e454;">SELECT DISTINCT train_end_time</span>
<span style="color: #95e454;">        FROM results.models</span>
<span style="color: #95e454;">        WHERE model_group_id IN ({})</span>
<span style="color: #95e454;">        AND EXTRACT(DAY FROM train_end_time) IN (1)</span>
        AND train_end_time &gt;= <span style="color: #95e454;">'2012-01-01'</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">FILTER</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">Configuration for the Auditioner</span>
<span style="color: #cae682;">filter</span>:
    <span style="color: #cae682;">metric</span>: <span style="color: #95e454;">'precision@'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">metric of interest</span>
    <span style="color: #cae682;">parameter</span>: <span style="color: #95e454;">'50_abs'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">parameter of interest</span>
    <span style="color: #cae682;">max_from_best</span>: 1.0 <span style="color: #99968b;"># </span><span style="color: #99968b;">The maximum value that the given metric can be worse than the best model for a given train end time.</span>
    <span style="color: #cae682;">threshold_value</span>: 0.0 <span style="color: #99968b;"># </span><span style="color: #99968b;">The worst absolute value that the given metric should be.</span>
    <span style="color: #cae682;">distance_table</span>: <span style="color: #95e454;">'distance_table'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">name of the distance table</span>
    <span style="color: #cae682;">models_table</span>: <span style="color: #95e454;">'models'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">name of the models table</span>

<span style="color: #99968b;"># </span><span style="color: #99968b;">RULES</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">The selection rules for Audition to simulate the model selection process for each timestamps.</span>
<span style="color: #99968b;"># </span><span style="color: #99968b;">More rules can be found in the README.</span>
<span style="color: #cae682;">rules</span>:
    <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        shared_parameters</span>:
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                metric</span>: <span style="color: #95e454;">'precision@'</span>
                <span style="color: #cae682;">parameter</span>: <span style="color: #95e454;">'50_abs'</span>
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                metric</span>: <span style="color: #95e454;">'recall@'</span>
                <span style="color: #cae682;">parameter</span>: <span style="color: #95e454;">'50_abs'</span>
        <span style="color: #cae682;">selection_rules</span>:
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                name</span>: <span style="color: #95e454;">'best_current_value'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">Pick the model group with the best current metric value</span>
                <span style="color: #cae682;">num</span>: 3
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                name</span>: <span style="color: #95e454;">'best_average_value'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">Pick the model with the highest average metric value</span>
                <span style="color: #cae682;">num</span>: 3
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                name</span>: <span style="color: #95e454;">'lowest_metric_variance'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">Pick the model with the lowest metric variance</span>
                <span style="color: #cae682;">num</span>: 3
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                name</span>: <span style="color: #95e454;">'most_frequent_best_dist'</span> <span style="color: #99968b;"># </span><span style="color: #99968b;">Pick the model that is most frequently within `dist_from_best_case`</span>
                <span style="color: #cae682;">dist_from_best_case</span>: [0.05]
                <span style="color: #cae682;">num</span>: 3

    <span style="color: #cae682;">-</span>
<span style="color: #cae682;">        shared_parameters</span>:
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                metric1</span>: <span style="color: #95e454;">'precision@'</span>
                <span style="color: #cae682;">parameter1</span>: <span style="color: #95e454;">'50_abs'</span>
        <span style="color: #cae682;">selection_rules</span>:
            <span style="color: #cae682;">-</span>
<span style="color: #cae682;">                name</span>: <span style="color: #95e454;">'best_average_two_metrics'</span> <span style="color: #99968b;">#  </span><span style="color: #99968b;">Pick the model with the highest average combined value to date of two metrics weighted together using metric1_weight</span>
                <span style="color: #cae682;">metric2</span>: <span style="color: #95e454;">'recall@'</span>
                <span style="color: #cae682;">parameter2</span>: <span style="color: #95e454;">'50_abs'</span>
                <span style="color: #cae682;">metric1_weight</span>: 0.5
                <span style="color: #cae682;">num</span>: 3

</pre>
</div>

<p>
<code>Audition</code> will have each rule give you the best \(n\) model-group IDs
based on the metric and parameter following that rule for the most
recent time period (in all the rules shown \(n\) = 1).
</p>

<p>
We can run the simulation of the rules againts the experiment as:
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file eis_01.yaml audit_models --metric precision@50_abs --rules rules.yaml
</pre>
</div>
</div>
</div>


<div id="outline-container-org4bc9352" class="outline-2">
<h2 id="org4bc9352"><span class="section-number-2">8</span> <span class="todo TODO">TODO</span> Postmodeling</h2>
<div class="outline-text-2" id="text-8">
</div>
</div>

<div id="outline-container-org768e5ae" class="outline-2">
<h2 id="org768e5ae"><span class="section-number-2">9</span> <span class="todo WORKING">WORKING</span> Scaling out: AWS Batch</h2>
<div class="outline-text-2" id="text-9">
<blockquote>
<p>
If your laptop choked in the previous sections or if you can't afford
to look your laptop just lagging forever, you should read this section&#x2026;
</p>
</blockquote>

<p>
For bigger experiment, one option is use <code>[[https://aws.amazon.com/batch/][AWS Batch]]</code>. AWS Batch Batch
dynamically provisions the optimal quantity and type of compute
resources based on the specific resource requirements of the tasks
submitted. AWS Batch will manage (i.e. plans, schedules, and executes)
the resources (CPU, Memory) that we need to run the pipeline.
</p>

<p>
AWS Batch dependes in other two technologies in order to work: Elastic
Container Registry (Amazon ECR) as the Docker image registry (allowing
AWS Batch to fetch the task images), and Elastic Compute Cloud (Amazon
EC2) instances located in the cluster as the docker host (allowing AWS
Batch to execute the task).
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./images/AWS_Batch_Architecture.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<p>
An AWS ECS task will be executed by an EC2 instance belonging to the
ECS cluster (if there are resources available). The EC2 machine
operates as a Docker host: it will run the task definition, download
the appropriate image from the ECS registry, and execute the
container.
</p>
</div>

<div id="outline-container-org5163dc0" class="outline-3">
<h3 id="org5163dc0"><span class="section-number-3">9.1</span> What do you need to setup?</h3>
<div class="outline-text-3" id="text-9-1">
<p>
AWS Batch requires setup the following infrastructure:
</p>

<ul class="org-ul">
<li>An <a href="https://aws.amazon.com/s3/?nc2=h_m1">AWS S3 bucket</a> for storing the original data and the successive transformations of it made by the pipeline.</li>
<li>A PostgreSQL database (provided by <a href="https://aws.amazon.com/rds/">AWS RDS</a>) for storing the data in a relational form.</li>
<li>An Elastic Container Registry (<a href="https://aws.amazon.com/ecs/">AWS ECR</a>) for storing the triage's Docker image used in the pipeline.</li>
<li><a href="https://aws.amazon.com/batch/">AWS Batch Job Queue</a> configured and ready to go.</li>
</ul>
</div>
</div>

<div id="outline-container-orga35d7a2" class="outline-3">
<h3 id="orga35d7a2"><span class="section-number-3">9.2</span> Assumptions</h3>
<div class="outline-text-3" id="text-9-2">
<ul class="org-ul">
<li>You have IAM credentials with permissions to run AWS Batch, read
AWS S3 and create AWS EC2 machines.</li>
<li>You installed <code>awscli</code> and configure your credentials following
the standard instructions.</li>
<li>You have access to a S3 bucket with the following form
<code>s3://dssg-${PROJECT_NAME}</code></li>
<li>You have a AWS ECR repository with the following form: <code>dsapp/${PROJECT_NAME}/triage</code></li>
<li>You have a AWS Batch job queue configured and have permissions
for adding, running, canceling jobs.</li>
</ul>
</div>
</div>


<div id="outline-container-org43ee7c6" class="outline-3">
<h3 id="org43ee7c6"><span class="section-number-3">9.3</span> Configuration</h3>
<div class="outline-text-3" id="text-9-3">
<p>
We need 3 files for running in AWS Batch, copy the files and remove
the <code>.example</code> extension and adapt them to your case:
</p>
</div>

<div id="outline-container-orge808c06" class="outline-4">
<h4 id="orge808c06"><span class="section-number-4">9.3.1</span> Job definition</h4>
<div class="outline-text-4" id="text-9-3-1">
<p>
Change the <code>PROJECT_NAME</code> and <code>AWS_ACCOUNT</code> for their real values
</p>

<div class="org-src-container">
<pre class="src src-json"> <span style="color: #8c8c8c;">{</span>
     <span style="color: #8ac6f2;">"jobDefinitionName"</span>: <span style="color: #95e454;">"dirtyduck-run-experiment"</span>,
     <span style="color: #8ac6f2;">"type"</span>: <span style="color: #95e454;">"container"</span>,
     <span style="color: #8ac6f2;">"containerProperties"</span>: <span style="color: #93a8c6;">{</span>
         <span style="color: #8ac6f2;">"image"</span>: <span style="color: #95e454;">"AWS_ACCOUNT.dkr.ecr.us-west-2.amazonaws.com/dirtyduck/triage"</span>,
         <span style="color: #8ac6f2;">"vcpus"</span>: <span style="color: #e5786d;">10</span>,
         <span style="color: #8ac6f2;">"memory"</span>: <span style="color: #e5786d;">60000</span>,
         <span style="color: #8ac6f2;">"jobRoleArn"</span>: <span style="color: #95e454;">"arn:aws:iam::AWS_ACCOUNT:role/dsappBatchJobRole"</span>,
         <span style="color: #8ac6f2;">"command"</span>: <span style="color: #b0b1a3;">[</span>
             <span style="color: #95e454;">"--experiment-file"</span>,
             <span style="color: #95e454;">"Ref::experiment_file"</span>,
             <span style="color: #95e454;">"--output-path"</span>,
             <span style="color: #95e454;">"Ref::output_path"</span>,
             <span style="color: #95e454;">"Ref::replace"</span>
         <span style="color: #b0b1a3;">]</span>
     <span style="color: #93a8c6;">}</span>,
     <span style="color: #8ac6f2;">"retryStrategy"</span>: <span style="color: #93a8c6;">{</span>
         <span style="color: #8ac6f2;">"attempts"</span>: <span style="color: #e5786d;">3</span>
     <span style="color: #93a8c6;">}</span>
 <span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd49988" class="outline-4">
<h4 id="orgdd49988"><span class="section-number-4">9.3.2</span> Environment overrides</h4>
<div class="outline-text-4" id="text-9-3-2">
<p>
Fill out the missing values
</p>

<div class="org-src-container">
<pre class="src src-json"><span style="color: #8c8c8c;">{</span>
    <span style="color: #8ac6f2;">"environment"</span>: <span style="color: #93a8c6;">[</span>
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"AWS_DEFAULT_REGION"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">"us-west-2"</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"AWS_JOB_QUEUE"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"POSTGRES_PASSWORD"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"POSTGRES_USER"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"POSTGRES_DB"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"POSTGRES_PORT"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"POSTGRES_HOST"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"POSTGRES_ROLE"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">""</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"NUMBER_OF_PROCESSES"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">"5"</span>
        <span style="color: #b0b1a3;">}</span>,
        <span style="color: #b0b1a3;">{</span>
            <span style="color: #8ac6f2;">"name"</span>:<span style="color: #95e454;">"NUMBER_OF_DB_PROCESSES"</span>,
            <span style="color: #8ac6f2;">"value"</span>:<span style="color: #95e454;">"5"</span>
        <span style="color: #b0b1a3;">}</span>
    <span style="color: #93a8c6;">]</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org89528ef" class="outline-4">
<h4 id="org89528ef"><span class="section-number-4">9.3.3</span> <code>credentials-filter</code></h4>
<div class="outline-text-4" id="text-9-3-3">
<p>
Leave this file as is (We will use it for storing the temporal token
in <code>deploy.sh</code>)
</p>

<div class="org-src-container">
<pre class="src src-json"><span style="color: #8c8c8c;">{</span>
        <span style="color: #8ac6f2;">"environment"</span>: <span style="color: #93a8c6;">[</span>
                <span style="color: #b0b1a3;">{</span>
                        <span style="color: #8ac6f2;">"name"</span>: <span style="color: #95e454;">"AWS_ACCESS_KEY_ID"</span>,
                        <span style="color: #8ac6f2;">"value"</span>: .Credentials.AccessKeyId
                <span style="color: #b0b1a3;">}</span>,
                <span style="color: #b0b1a3;">{</span>
                        <span style="color: #8ac6f2;">"name"</span>: <span style="color: #95e454;">"AWS_SECRET_ACCESS_KEY"</span>,
                        <span style="color: #8ac6f2;">"value"</span>: .Credentials.SecretAccessKey
                <span style="color: #b0b1a3;">}</span>,
                <span style="color: #b0b1a3;">{</span>
                        <span style="color: #8ac6f2;">"name"</span>: <span style="color: #95e454;">"AWS_SESSION_TOKEN"</span>,
                        <span style="color: #8ac6f2;">"value"</span>: .Credentials.SessionToken
                <span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">]</span>
<span style="color: #8c8c8c;">}</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orga47967f" class="outline-4">
<h4 id="orga47967f"><span class="section-number-4">9.3.4</span> Running an experiment</h4>
<div class="outline-text-4" id="text-9-3-4">
<p>
We provided a simple bash file for creating the image,
uploading/updating the job definition and running the experiment:
</p>

<pre class="example">
    ./deploy.sh -h

    Usage: ./deploy.sh (-h | -i | -u | -b | -r | -a | --sync_{to,from}_s3 )
    OPTIONS:
       -h|--help                   Show this message
       -i|--info                   Show information about the environment
       -b|--update-images          Build the triage image and push it to the AWS ECR
       -u|--update-jobs            Update the triage job definition in AWS Batch
       -r|--run-experiment         Run experiments on chile-dt data
       -a|--all                    Creates images, pushes them the registry, updates the jobs and runs the pipeline
       --sync-to-s3                Uploads the experiments and configuration files to s3://your_project
       --sync-from-s3              Gets the experiments and configuration files from s3://your_project
    EXAMPLES:
       Build and push the images to your AWS ECR:
            $ ./deploy.sh -b
       Update the job's definitions:
            $ ./deploy.sh -u
       Run triage experiments:
            $ ./deploy.sh -r --experiment_file=s3://your_project/experiments/test.yaml,output_path=s3://your_project/triage,replace=--replace
       Everything!:
            $ ./deploy.sh -a --experiment_file=s3://your_project/experiments/test.yaml,output_path=s3://your_project/triage,replace=--replace

</pre>

<p>
If you have multiple AWS profiles use <code>deploy.sh</code> as follows:
</p>

<pre class="example">
AWS_PROFILE=your_profile ./deploy.sh -b
</pre>

<p>
Where <code>your_profile</code> is the name of the profile in <code>~/.aws/credentials</code>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf406f7a" class="outline-2">
<h2 id="orgf406f7a"><span class="section-number-2">10</span> What's next?</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>Add the shape file
<a href="https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&amp;format=Shapefile">https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&amp;format=Shapefile</a>
and generate geospatial variables using <code>location</code></li>
<li>Text analysis on the <i>violations</i>' <code>comments</code> column and generate
new <i>outcomes</i> or <i>features</i>?</li>
<li>Run <code>pgdedup</code> and had a better <code>semantic.entities</code>?</li>
<li>Routing based on the inspection list?</li>
<li>Add more data sources (Census, Schools, bus stops, ACS data, Yelp!)?</li>
</ul>
</div>
</div>

<div id="outline-container-orga459cf2" class="outline-2">
<h2 id="orga459cf2"><span class="section-number-2">11</span> Appendix: For the impatient</h2>
<div class="outline-text-2" id="text-11">
<p>
If you want to skip all the cleansing and transformation and deep
directly into <code>triage</code> you can
execute the following <i>inside bastion</i>:
</p>

<div class="org-src-container">
<pre class="src src-sh">     curl <span style="color: #95e454;">"https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD"</span> &gt; data/inspections.csv

     psql $<span style="color: #8c8c8c;">{</span><span style="color: #cae682;">FOOD_DB_URL</span><span style="color: #8c8c8c;">}</span> -c <span style="color: #95e454;">"\copy raw.inspections FROM '/data/inspections.csv' WITH HEADER CSV"</span>

     psql $<span style="color: #8c8c8c;">{</span><span style="color: #cae682;">FOOD_DB_URL</span><span style="color: #8c8c8c;">}</span> &lt; /sql/create_cleaned_inspections_table.sql

     psql $<span style="color: #8c8c8c;">{</span><span style="color: #cae682;">FOOD_DB_URL</span><span style="color: #8c8c8c;">}</span> &lt; /sql/create_violations_table.sql

     psql $<span style="color: #8c8c8c;">{</span><span style="color: #cae682;">FOOD_DB_URL</span><span style="color: #8c8c8c;">}</span> &lt; /sql/create_semantic_tables.sql
</pre>
</div>


<p>
If everything works, you should end with two new schemas: <code>cleaned</code> and <code>semantic</code>.
</p>

<p>
You could check that (from <code>psql</code>) With
</p>
<div class="org-src-container">
<pre class="src src-sql">\dn
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of schemas</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">cleaned</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">postgis</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">public</td>
<td class="org-left">postgres</td>
</tr>

<tr>
<td class="org-left">raw</td>
<td class="org-left">food<sub>user</sub></td>
</tr>

<tr>
<td class="org-left">semantic</td>
<td class="org-left">food<sub>user</sub></td>
</tr>
</tbody>
</table>

<p>
Now you can continue to the introduction to triage section.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Several examples use this dataset, such as <a href="https://chicago.github.io/food-inspections-evaluation/">City of Chicago Food
Inspection Forecasting</a>,  <a href="https://youtu.be/lyDLAutA88s">PyCon 2016 keynote: Built in Super Heroes</a>,
and <a href="https://youtu.be/1dKonIT-Yak">PyData 2016: Forecasting critical food violations at restaurants
using open data</a>.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
It is also possible to do "visit-level prediction" type of ML problem.
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
Examples include <a href="http://dsapp.uchicago.edu/projects/environment/">Predictive Enforcement
of Hazardous Waste Regulations</a> and <a href="http://dsapp.uchicago.edu/projects/health/lead-prevention/">Targeting Proactive Inspections for Lead Hazards</a>.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
Examples include <a href="http://dsapp.uchicago.edu/projects/education/">Increasing High School Graduation Rates: Early
Warnings and Predictive Systems</a>, <a href="http://dsapp.uchicago.edu/projects/public-safety/police-eis/">Building Data-Driven Early
Intervention Systems for Police Officers</a>, and <a href="http://dsapp.uchicago.edu/projects/criminal-justice/data-driven-justice-initiative/">Data-Driven Justice
Initiative: Identifying Frequent Users of Multiple Public Systems for
More Effective Early Assistance</a>.
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
Defined as "bakery, banquet
hall, candy store, caterer, coffee shop, day care center (for ages less than 2), day care
center (for ages 2 – 6), day care center (combo, for ages less than 2 and 2 – 6
combined), gas station, Golden Diner, grocery store, hospital, long term care
center(nursing home), liquor store, mobile food dispenser, restaurant, paleteria, school,
shelter, tavern, social club, wholesaler, or Wrigley Field Rooftop"
(<a href="https://data.cityofchicago.org/api/views/4ijn-s7e5/files/O9cwLJ4wvxQJ2MirxkNzAUCCMQiM31DMzRkckMsKlxc?download=true&amp;filename=foodinspections_description.pdf">source</a>).
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
This points is particularly acute: Imagine the scenario in
which the <i>inspections</i> problem is <b>crime prediction</b> in order to send
cops (inspectors)to that "risky" area (facilities)&#x2026;
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><p class="footpara">
Reproducible, scalable, flexible, etc.
</p></div></div>

<div class="footdef"><sup><a id="fn.8" class="footnum" href="#fnr.8">8</a></sup> <div class="footpara"><p class="footpara">
And other things through this tutorial, like the execution of
the model training, etc.
</p></div></div>

<div class="footdef"><sup><a id="fn.9" class="footnum" href="#fnr.9">9</a></sup> <div class="footpara"><p class="footpara">
If you have a postgresql client installed, you can use <code>psql -h 0.0.0.0 -p 5434 -d food -U food_user</code> rather than the <code>bastion</code> container.
</p></div></div>

<div class="footdef"><sup><a id="fn.10" class="footnum" href="#fnr.10">10</a></sup> <div class="footpara"><p class="footpara">
Welcome to the not-so-sexy part of the (supposedly) <i>sexiest job</i>
of the XXI century.
</p></div></div>

<div class="footdef"><sup><a id="fn.11" class="footnum" href="#fnr.11">11</a></sup> <div class="footpara"><p class="footpara">
You'll probably get a different number because the data are updated every day.
</p></div></div>

<div class="footdef"><sup><a id="fn.12" class="footnum" href="#fnr.12">12</a></sup> <div class="footpara"><p class="footpara">
If you want to try different columns (or you don't remember
which columns try <code>\d raw.inspectios</code>
</p></div></div>

<div class="footdef"><sup><a id="fn.13" class="footnum" href="#fnr.13">13</a></sup> <div class="footpara"><p class="footpara">
We are following the <a href="https://en.wikipedia.org/wiki/Event_(relativity)">event's definition from /physics</a>/: "an event
is the instantaneous physical situation or occurrence associated with
a point in spacetime"
</p></div></div>

<div class="footdef"><sup><a id="fn.14" class="footnum" href="#fnr.14">14</a></sup> <div class="footpara"><p class="footpara">
It will make your life easier and most of the Machine Learning
algorithms only accept data in matrix form (i.e. one big table)
</p></div></div>

<div class="footdef"><sup><a id="fn.15" class="footnum" href="#fnr.15">15</a></sup> <div class="footpara"><p class="footpara">
Verbatim from the datasource documentation.
</p></div></div>

<div class="footdef"><sup><a id="fn.16" class="footnum" href="#fnr.16">16</a></sup> <div class="footpara"><p class="footpara">
A controversial decision, I know.
</p></div></div>

<div class="footdef"><sup><a id="fn.17" class="footnum" href="#fnr.17">17</a></sup> <div class="footpara"><p class="footpara">
This problem is related to the process of <i>deduplication</i> and
there is another DSaPP tool for that: <a href="https://dssg.github.io/matching-tool/">matching-tool</a>.
</p></div></div>

<div class="footdef"><sup><a id="fn.18" class="footnum" href="#fnr.18">18</a></sup> <div class="footpara"><p class="footpara">
It is the <i>Chicago</i> Food Inspections dataset, after all.
</p></div></div>

<div class="footdef"><sup><a id="fn.19" class="footnum" href="#fnr.19">19</a></sup> <div class="footpara"><p class="footpara">
We could also use the default geometric data type from
postgresql: <code>point</code> (<a href="https://www.postgresql.org/docs/10/datatype-geometric.html">https://www.postgresql.org/docs/10/datatype-geometric.html</a>)
</p></div></div>

<div class="footdef"><sup><a id="fn.20" class="footnum" href="#fnr.20">20</a></sup> <div class="footpara"><p class="footpara">
We will store the <code>Point</code> as a <code>geography</code> object. As a result,
spatial database operations (like calculating the distances between two
facilities) will return answers in meters instead of degrees. See
<a href="http://workshops.boundlessgeo.com/postgis-intro/geography.html">this</a>.
</p></div></div>

<div class="footdef"><sup><a id="fn.21" class="footnum" href="#fnr.21">21</a></sup> <div class="footpara"><p class="footpara">
As a real geographical object <a href="https://postgis.net/docs/ST_MakePoint.html">check the PostGIS documentation</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.22" class="footnum" href="#fnr.22">22</a></sup> <div class="footpara"><p class="footpara">
Remember our tip at the beginning of this section!
</p></div></div>

<div class="footdef"><sup><a id="fn.23" class="footnum" href="#fnr.23">23</a></sup> <div class="footpara"><p class="footpara">
If the code looks funny to you, it is because we are using
<a href="https://www.postgresql.org/docs/devel/queries-table-expressions.html#QUERIES-GROUPING-SETS">grouping sets</a>, in particular <code>rollup</code>. See the docs.
</p></div></div>

<div class="footdef"><sup><a id="fn.24" class="footnum" href="#fnr.24">24</a></sup> <div class="footpara"><p class="footpara">
Yeah, you wish
</p></div></div>

<div class="footdef"><sup><a id="fn.25" class="footnum" href="#fnr.25">25</a></sup> <div class="footpara"><p class="footpara">
If you want to have a deep explanation about why is this good
check <a href="http://coussej.github.io/2016/01/14/Replacing-EAV-with-JSONB-in-PostgreSQL/">this blog post</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.26" class="footnum" href="#fnr.26">26</a></sup> <div class="footpara"><p class="footpara">
As a general rule I hate to add the suffix <code>_id</code>, I would
rather prefer to name them as <code>event</code> and <code>entity</code> instead of
<code>event_id</code> and <code>entity_id</code>. But <code>triage</code> named those columns in that
way and for that we are stuck with that nomenclature.
</p></div></div>

<div class="footdef"><sup><a id="fn.27" class="footnum" href="#fnr.27">27</a></sup> <div class="footpara"><p class="footpara">
This will simplify the creation of <i>features</i> for our machine learning models.
</p></div></div>

<div class="footdef"><sup><a id="fn.28" class="footnum" href="#fnr.28">28</a></sup> <div class="footpara"><p class="footpara">
<i>Would be my restaurant inspected in the following month?</i> in the case of an <b>early warning</b> case.
</p></div></div>

<div class="footdef"><sup><a id="fn.29" class="footnum" href="#fnr.29">29</a></sup> <div class="footpara"><p class="footpara">
It's a little more complicated than that as we will see.
</p></div></div>

<div class="footdef"><sup><a id="fn.30" class="footnum" href="#fnr.30">30</a></sup> <div class="footpara"><p class="footpara">
All events produce some <i>outcome</i>. In theory <b>every</b> event of
interest in stored in a database. These events are <i>immutable</i>: you
can't (shouldn't) change them (they already happen).
</p></div></div>

<div class="footdef"><sup><a id="fn.31" class="footnum" href="#fnr.31">31</a></sup> <div class="footpara"><p class="footpara">
We could consider different states, for example: we can use the column
<code>risk</code> as an state. Another possibility is define a new state called
<code>failed</code> that indicates if the facility failed in the last time it was
inspected. One more: you could create cohorts based on the <code>facility_type.</code>
</p></div></div>

<div class="footdef"><sup><a id="fn.32" class="footnum" href="#fnr.32">32</a></sup> <div class="footpara"><p class="footpara">
The city in this toy example has very low resources.
</p></div></div>

<div class="footdef"><sup><a id="fn.33" class="footnum" href="#fnr.33">33</a></sup> <div class="footpara"><p class="footpara">
See for example: <a href="https://robjhyndman.com/hyndsight/tscv/">https://robjhyndman.com/hyndsight/tscv/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.34" class="footnum" href="#fnr.34">34</a></sup> <div class="footpara"><p class="footpara">
I know, I know. And in order to cover all the cases, we are still
missing one or two parameters, but we are working on it.
</p></div></div>

<div class="footdef"><sup><a id="fn.35" class="footnum" href="#fnr.35">35</a></sup> <div class="footpara"><p class="footpara">
Obscure reference to the "The Last Airbender" cartoon series. I'm sorry.
</p></div></div>

<div class="footdef"><sup><a id="fn.36" class="footnum" href="#fnr.36">36</a></sup> <div class="footpara"><p class="footpara">
<code>collate</code> is to <i>feature generation</i> what <code>timechop</code> is to
<i>date temporal splitting</i>
</p></div></div>

<div class="footdef"><sup><a id="fn.37" class="footnum" href="#fnr.37">37</a></sup> <div class="footpara"><p class="footpara">
<code>triage</code> uses <b>a lot</b> of <code>yaml</code>, <a href="https://github.com/Animosity/CraftIRC/wiki/Complete-idiot%27s-introduction-to-yaml">this guide</a> could be handy
</p></div></div>

<div class="footdef"><sup><a id="fn.38" class="footnum" href="#fnr.38">38</a></sup> <div class="footpara"><p class="footpara">
Note that the name <code>categoricals</code> is confusing here: The
original variable (i.e. a column) is categorical, the aggregate of
that column is not. The same with the <code>aggregates</code>: The original column
could be a categorical or a numeric (to be fare most of the time is a
numeric column, but see the example: <i>we are counting</i>), and then <code>triage</code>
applies an aggregate that will be numeric. That is how triage named
things, and yes, I know is confusing.
</p></div></div>

<div class="footdef"><sup><a id="fn.39" class="footnum" href="#fnr.39">39</a></sup> <div class="footpara"><p class="footpara">
<code>triage</code> will generate also a new binary column that indicates if the
value of the feature was imputed (<code>1</code>) or not (<code>0</code>): <code>inspections_entity_id_6month_total_count_imp</code>.
</p></div></div>

<div class="footdef"><sup><a id="fn.40" class="footnum" href="#fnr.40">40</a></sup> <div class="footpara"><p class="footpara">
Literally from the configuration file. If you modify something it will generate a new hash. Handle with care!
</p></div></div>

<div class="footdef"><sup><a id="fn.41" class="footnum" href="#fnr.41">41</a></sup> <div class="footpara"><p class="footpara">
You need to check this! Fortunately, <code>triage</code> allows you to try
several options here, so, if you think that this is too high or too
low you can change that and fit your needs.
</p></div></div>

<div class="footdef"><sup><a id="fn.42" class="footnum" href="#fnr.42">42</a></sup> <div class="footpara"><p class="footpara">
We will explore how to one way to tackle this in the advance part of this tutorial.
</p></div></div>

<div class="footdef"><sup><a id="fn.43" class="footnum" href="#fnr.43">43</a></sup> <div class="footpara"><p class="footpara">
The flags <code>-no-save-predictions</code> and <code>profile</code> are not necessary
but useful. The first one configure triage to not store the
predictions (at this stage you don't need them, and you can always
could recreate them from the model and the matrix). This will save you
execution time. The flag <code>profile</code> stores the <i>execution</i> profile times
in a file, so you can check which models or matrices are taking a lot
of time on been built.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Center of Data Science for Public Policy</p>
<p class="date">Created: 2019-02-08 Fri 11:58</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
